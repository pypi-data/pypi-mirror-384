version: "3.9"

services:
  crowdsec:
    image: crowdsecurity/crowdsec:latest
    hostname: crowdsec
    container_name: crowdsec-appsec
    restart: "no"
    entrypoint:
      - /bin/bash
      - /usr/local/bin/init-bouncer.sh
    environment:
      # Ensure the local API stays accessible for the nginx bouncer.
      - DISABLE_LOCAL_API=0
      - DISABLE_ONLINE_API=1
      # Turn on AppSec mode inside the CrowdSec container.
      - ENABLE_APPSEC=1
    volumes:
      # Persist CrowdSec data (buckets, alerts, etc.) between restarts.
      - crowdsec-data:/var/lib/crowdsec/data
      # Allow templated acquisition and AppSec config overrides without replacing the whole /etc/crowdsec tree.
      - ./crowdsec/acquis.d/appsec.yaml:/etc/crowdsec/acquis.d/appsec-mcp.yaml:ro
      - ./crowdsec/appsec-configs/mcp-appsec.yaml:/etc/crowdsec/appsec-configs/mcp-appsec.yaml:ro
      - ./crowdsec/init-bouncer.sh:/usr/local/bin/init-bouncer.sh:ro
      # The MCP tooling will drop the user-provided rule in this folder as current-rule.yaml
      - ./rules:/etc/crowdsec/appsec-rules/custom
    ports:
      - "18080:8080" # LAPI (use non-default host port to avoid conflicts)
      - "17422:7422" # AppSec Live mode (non-default host port)
    networks:
      - waf-net

  nginx:
    build:
      context: ./nginx
    container_name: nginx-appsec
    restart: "no"
    depends_on:
      - crowdsec
      - backend
    ports:
      - "8081:80"
    command:
      - openresty
      - -g
      - 'daemon off;'
    volumes:
      - ./nginx/nginx.conf:/usr/local/openresty/nginx/conf/nginx.conf:ro
      # Site config enabling the CrowdSec module and proxying to the backend.
      - ./nginx/site-enabled:/usr/local/openresty/nginx/conf/site-enabled:ro
      # Override the bouncer configuration shipped in the image with the harness version.
      - ./nginx/crowdsec/crowdsec-openresty-bouncer.conf:/etc/crowdsec/bouncers/crowdsec-openresty-bouncer.conf:ro
    networks:
      - waf-net

  backend:
    image: nginxdemos/hello:latest
    container_name: app-backend
    restart: unless-stopped
    networks:
      - waf-net

volumes:
  crowdsec-data:

networks:
  waf-net:
    driver: bridge
