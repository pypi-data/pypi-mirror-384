{# ä¸»æ‰§è¡Œå¾ªç¯æ¨¡å— - å¤„ç†åŠ¨ä½œåºåˆ—çš„ä¸»è¦æ‰§è¡Œé€»è¾‘ #}
{% from 'main/checkpoint_validation.j2' import execute_checkpoint_validation %}

{% macro execute_main_loop(device, runner_dir, screenshot_count, action_sequence, task_status, task_status_file, start_time, task_first_step_map, all_expected_results) %}
        # æ‰§è¡ŒåŠ¨ä½œåºåˆ—
        previous_after_screenshot = None  # ç”¨äºå­˜å‚¨å‰ä¸€æ­¥çš„æ‰§è¡Œåæˆªå›¾è·¯å¾„
        
        for step_index, step_data in enumerate(action_sequence):
            step_number, step_name, operation_type = get_step_info(step_data, step_index)
            
            logging.info(f"{'='*50}")
            logging.info(f"æ‰§è¡Œæ­¥éª¤ {step_number}: {step_name} ({operation_type})")
            logging.info(f"{'='*50}")
            
            # å¼ºåˆ¶åˆ·æ–°æ—¥å¿—ç¡®ä¿æ­¥éª¤å¼€å§‹è¢«è®°å½•
            for handler in logging.getLogger().handlers:
                handler.flush()
            
            # æ›´æ–°ä»»åŠ¡è¿›åº¦
            task_status["current_step"] = step_number
            task_status["progress_percentage"] = round((step_index / len(action_sequence)) * 100, 1)
            task_status["current_step_name"] = step_name
            task_status["current_operation_type"] = operation_type
            
            # åˆå§‹åŒ–å½“å‰æ­¥éª¤çš„æ£€æŸ¥ç‚¹çŠ¶æ€
            task_status["current_checkpoint_status"] = {
                "step_number": step_number,
                "step_name": step_name,
                "current_phase": "å‡†å¤‡æ‰§è¡Œ",
                "status": "å¾…æ‰§è¡Œ",
                "last_update": datetime.now().isoformat()
            }
            
            # å®æ—¶ä¿å­˜ä»»åŠ¡çŠ¶æ€
            with open(task_status_file, 'w', encoding='utf-8') as f:
                json.dump(task_status, f, ensure_ascii=False, indent=2, default=str)
            
            step_start_time = time.time()
            
            try:
                # ==================== é˜¶æ®µ0: CAN é‡‡é›†å¯åŠ¨æ£€æŸ¥ ====================
                source_task_id = step_data.get('source_task_id', '')
                if source_task_id:
                    # æ£€æŸ¥è¯¥ä»»åŠ¡æ˜¯å¦éœ€è¦CANé‡‡é›†ä¸”å°šæœªå¯åŠ¨
                    task_expected_results = all_expected_results.get(source_task_id, {})
                    can_capture_config = task_expected_results.get('can_capture')
                    conditions = task_expected_results.get('conditions', []) or []

                    # ä»…å½“ä»»åŠ¡å­˜åœ¨can_captureé…ç½®ï¼Œä¸”æ¡ä»¶ä¸­åŒ…å«CANç›¸å…³ï¼ˆdata_source=='can_signal' æˆ– validation_type=='can'ï¼‰æ—¶æ‰å…è®¸å¯åŠ¨
                    has_can_condition = False
                    try:
                        for cond in conditions:
                            ds = (cond.get('data_source') or '').lower()
                            vt = (cond.get('validation_type') or '').lower()
                            if ds == 'can_signal' or vt == 'can':
                                has_can_condition = True
                                break
                    except Exception as _:
                        has_can_condition = False

                    if can_capture_config and has_can_condition and not is_can_capture_running(source_task_id):
                        # ä½¿ç”¨é¢„å¤„ç†çš„æ˜ å°„è¡¨å¿«é€Ÿåˆ¤æ–­æ˜¯å¦ä¸ºä»»åŠ¡ç¬¬ä¸€æ­¥
                        is_first_step_of_task = (task_first_step_map.get(source_task_id) == step_index)
                        
                        if is_first_step_of_task:
                            logging.info(f"ğŸ¯ æ£€æµ‹åˆ°ä»»åŠ¡ {source_task_id} çš„ç¬¬ä¸€ä¸ªæ­¥éª¤ï¼Œæ­£åœ¨å¯åŠ¨CANé‡‡é›†...")
                            try:
                                can_file_path = start_can_capture(source_task_id, can_capture_config, str(runner_dir))
                                logging.info(f"âœ… ä»»åŠ¡ {source_task_id} CANé‡‡é›†å·²å¯åŠ¨ï¼Œæ–‡ä»¶è·¯å¾„: {can_file_path}")
                            except Exception as can_start_error:
                                logging.error(f"âŒ å¯åŠ¨CANé‡‡é›†å¤±è´¥: {can_start_error}")
                                # CANé‡‡é›†å¯åŠ¨å¤±è´¥ä¸åº”é˜»æ­¢æ­¥éª¤æ‰§è¡Œï¼Œè®°å½•é”™è¯¯ç»§ç»­
                        else:
                            logging.debug(f"ğŸ“‹ ä»»åŠ¡ {source_task_id} çš„CANé‡‡é›†å·²åœ¨ä¹‹å‰æ­¥éª¤å¯åŠ¨æˆ–æœªæ»¡è¶³æ¡ä»¶ï¼Œè·³è¿‡å¯åŠ¨æ£€æŸ¥")
                
                # ==================== é˜¶æ®µ1: æ£€æŸ¥ç‚¹å‰ç½®éªŒè¯ ====================
                logging.info("é˜¶æ®µ1: æ‰§è¡Œæ£€æŸ¥ç‚¹å‰ç½®éªŒè¯...")
                
                # æ›´æ–°åŠ¨ä½œçŠ¶æ€ä¸ºå‡†å¤‡ä¸­
                step_data['status'] = 'running'
                
                # æ‰§è¡Œæ£€æŸ¥ç‚¹å‰ç½®éªŒè¯ - ä½¿ç”¨æ£€æŸ¥ç‚¹éªŒè¯å®
                {{ execute_checkpoint_validation(step_data, device, runner_dir, screenshot_count, previous_after_screenshot) }}
                
                if not checkpoint_passed:
                    # æ£€æŸ¥ç‚¹éªŒè¯å¤±è´¥ï¼Œè·³è¿‡åŠ¨ä½œæ‰§è¡Œ
                    logging.error(f"âŒ æ£€æŸ¥ç‚¹éªŒè¯å¤±è´¥: {checkpoint_result.get('detail', 'æœªçŸ¥åŸå› ')}")
                    step_data['status'] = 'failed'
                    step_data['checkpoint'] = checkpoint_result
                    step_data['execution_result'] = {
                        "message": f"æ£€æŸ¥ç‚¹éªŒè¯å¤±è´¥ï¼Œè·³è¿‡åŠ¨ä½œæ‰§è¡Œ: {checkpoint_result.get('detail', 'æœªçŸ¥åŸå› ')}",
                        "screenshots": {
                            "before_execution": checkpoint_result.get('screenshot_path', ''),
                            "after_execution": ""
                        },
                        "duration": 0
                    }
                    continue  # è·³è¿‡å½“å‰æ­¥éª¤ï¼Œç»§ç»­ä¸‹ä¸€ä¸ªæ­¥éª¤
                
                # ==================== é˜¶æ®µ2: åŠ¨ä½œæ‰§è¡Œ ====================
                logging.info("é˜¶æ®µ2: æ£€æŸ¥ç‚¹éªŒè¯é€šè¿‡ï¼Œæ‰§è¡ŒåŠ¨ä½œæ“ä½œ...")
                
                # ä½¿ç”¨åŠ¨ä½œåˆ†å‘å™¨æ‰§è¡Œï¼ˆhandlerså†…éƒ¨ä¼šè¿›è¡Œè¯¦ç»†çš„å®æ—¶çŠ¶æ€æ›´æ–°ï¼‰
                execution_result = execute_action(step_data, device, runner_dir, screenshot_count, previous_after_screenshot)
                
                # æ›´æ–°å‰ä¸€æ­¥çš„æˆªå›¾è·¯å¾„ï¼Œç”¨äºä¸‹ä¸€æ­¥ä¼˜åŒ–
                if execution_result and execution_result.get('screenshots'):
                    previous_after_screenshot = execution_result['screenshots'].get('after_execution')
                
                # åˆ¤æ–­æ‰§è¡Œç»“æœçŠ¶æ€
                execution_success = execution_result.get('status') == 'success'
                
                # æ›´æ–°åŠ¨ä½œçŠ¶æ€
                if execution_success:
                    step_data['status'] = 'success'
                else:
                    step_data['status'] = 'failed'
                
                # ä½¿ç”¨ç»Ÿä¸€çš„æ—¥å¿—è®°å½•å‡½æ•°
                log_step_result(step_number, step_name, execution_success, execution_result.get('message', ''))
                
                # æ¸…ç†execution_resultï¼Œä¿ç•™æ ¸å¿ƒå­—æ®µå’Œæ§åˆ¶æµå­æ­¥éª¤
                cleaned_execution_result = {
                    "message": execution_result.get('message', ''),
                    "screenshots": execution_result.get('screenshots', {
                        "before_execution": "",
                        "after_execution": ""
                    }),
                    "duration": execution_result.get('duration', 0)
                }
                
                # ğŸ¯ ä¿ç•™æ§åˆ¶æµçš„executed_sub_stepså­—æ®µ
                if execution_result.get('executed_sub_steps'):
                    cleaned_execution_result['executed_sub_steps'] = execution_result.get('executed_sub_steps')
                
                # è®°å½•æ¸…ç†åçš„æ‰§è¡Œç»“æœ
                step_data['execution_result'] = cleaned_execution_result
                
                # æ£€æŸ¥ç‚¹å·²åœ¨é˜¶æ®µ1å®Œæˆï¼Œè®°å½•ç»“æœ
                step_data['checkpoint'] = checkpoint_result
                
                # ==================== é˜¶æ®µ3: æ‰§è¡Œç»“æœå¤„ç† ====================
                logging.info("é˜¶æ®µ3: å¤„ç†æ‰§è¡Œç»“æœ...")
                   
                # æ£€æŸ¥ç‚¹éªŒè¯å·²åœ¨é˜¶æ®µ1å®Œæˆï¼Œè¿™é‡Œåªéœ€è¦å¤„ç†å…¶ä»–é€»è¾‘
                step_number, step_name, operation_type = get_step_info(step_data)

                logging.info(f"å¤„ç†æ­¥éª¤ {step_number} çš„æ‰§è¡Œç»“æœ")
                
                # å…¶ä»–æ‰§è¡Œç»“æœå¤„ç†é€»è¾‘
                # ä¾‹å¦‚ï¼šç»Ÿè®¡ã€æ—¥å¿—è®°å½•ç­‰
                
                # æ›´æ–°æˆªå›¾è®¡æ•°
                screenshot_count += 1
                
            except Exception as step_error:
                # ä½¿ç”¨ç»Ÿä¸€çš„æ—¥å¿—è®°å½•å‡½æ•°
                log_step_result(step_number, step_name, False, f"æ­¥éª¤æ‰§è¡Œå¼‚å¸¸: {step_error}")
                import traceback
                logging.error(traceback.format_exc())
                
                # æ„é€ é”™è¯¯æ‰§è¡Œç»“æœç”¨äºæ£€æŸ¥ç‚¹çŠ¶æ€æ›´æ–°
                error_execution_result = {
                    "status": "failed",
                    "message": f"æ­¥éª¤æ‰§è¡Œå¼‚å¸¸: {step_error}",
                    "checkpoint_context": {
                        "operation_completed": False,
                        "operation_mode": "unknown",
                        "error_occurred": True,
                        "error_message": str(step_error)
                    }
                }
                
                # è®°å½•é”™è¯¯çŠ¶æ€
                step_data['execution_result'] = error_execution_result
                step_data['status'] = 'failed'
                
                # é”™è¯¯æˆªå›¾
                try:
                    error_screenshot_path = take_screenshot_and_save(
                        device, runner_dir, screenshot_count, f"error_step_{step_number}"
                    )
                    step_data['execution_screenshot_path'] = error_screenshot_path
                except Exception as screenshot_error:
                    logging.error(f"é”™è¯¯æˆªå›¾å¤±è´¥: {screenshot_error}")
                
                # ä½¿ç”¨æ£€æŸ¥ç‚¹éªŒè¯å®æ›´æ–°é”™è¯¯çŠ¶æ€
                try:
                    if 'checkpoint' not in step_data:
                        step_data['checkpoint'] = {}
                    step_data['checkpoint']['is_pass'] = False
                    step_data['checkpoint']['status'] = 'å¼‚å¸¸'
                    step_data['checkpoint']['detail'] = f"æ­¥éª¤æ‰§è¡Œå¼‚å¸¸: {step_error}"
                except Exception as checkpoint_error:
                    logging.error(f"æ£€æŸ¥ç‚¹çŠ¶æ€æ›´æ–°å¤±è´¥: {checkpoint_error}")
            
            finally:
                # ==================== é˜¶æ®µ3: verify_after éªŒè¯ ====================
                # æ£€æŸ¥æ˜¯å¦éœ€è¦æ‰§è¡Œ verify_after éªŒè¯
                verify_after = step_data.get('verify_after', False)
                source_task_id = step_data.get('source_task_id', '')
                
                if verify_after and source_task_id:
                    logging.info(f"é˜¶æ®µ3: æ‰§è¡Œ verify_after éªŒè¯ (ä»»åŠ¡ID: {source_task_id})")
                    try:
                        # ==================== verify_after éªŒè¯å†…è”é€»è¾‘ ====================
                        logging.info(f"{'='*20} å¼€å§‹éªŒè¯ä»»åŠ¡ {source_task_id} çš„é¢„æœŸç»“æœ {'='*20}")

                        # è·å–å½“å‰ä»»åŠ¡çš„é¢„æœŸç»“æœ
                        current_task_results = []
                        task_validation_results = []
                        
                        # è·å–æŒ‡å®šä»»åŠ¡çš„éªŒè¯é…ç½®
                        task_validation_config = all_expected_results.get(source_task_id, {})
                        
                        if task_validation_config:
                            expression = task_validation_config.get('expression', '')
                            conditions = task_validation_config.get('conditions', [])
                            
                            logging.info(f"æ‰¾åˆ°ä»»åŠ¡ {source_task_id} çš„é¢„æœŸç»“æœé…ç½®:")
                            logging.info(f"  è¡¨è¾¾å¼: {expression}")
                            logging.info(f"  æ¡ä»¶æ•°é‡: {len(conditions)}")
                            
                            if expression and conditions:
                                # æœ‰è¡¨è¾¾å¼å’Œæ¡ä»¶ï¼šä½¿ç”¨è¡¨è¾¾å¼éªŒè¯é€»è¾‘
                                logging.info("æ‰§è¡Œè¡¨è¾¾å¼éªŒè¯æ¨¡å¼")
                                
                                try:
                                    # è·å–å½“å‰ä»»åŠ¡çš„ CAN æ–‡ä»¶è·¯å¾„
                                    current_can_file_path = get_current_can_file_path(source_task_id)
                                    
                                    if current_can_file_path:
                                        logging.info(f"ğŸš— ä½¿ç”¨CANæ–‡ä»¶è·¯å¾„: {current_can_file_path}")
                                    
                                    # è¯„ä¼°è¡¨è¾¾å¼ï¼Œç›´æ¥ä¼ é€’CANæ–‡ä»¶è·¯å¾„å‚æ•°
                                    expression_is_pass = evaluate_condition_expression(
                                        condition=conditions,
                                        expression=expression,
                                        can_file_path=current_can_file_path
                                    )
                                    
                                    # åˆ›å»ºè¡¨è¾¾å¼éªŒè¯ç»“æœ
                                    result_data = {
                                        "id": source_task_id,
                                        "description": f"ä»»åŠ¡ {source_task_id} è¡¨è¾¾å¼éªŒè¯",
                                        "task_id": source_task_id,
                                        "validation_type": "expression",
                                        "expression": expression,
                                        "conditions_count": len(conditions),
                                        "is_pass": expression_is_pass,
                                        "details": f"è¡¨è¾¾å¼éªŒè¯{'é€šè¿‡' if expression_is_pass else 'å¤±è´¥'}: {expression}",
                                        "execution_timestamp": datetime.now().isoformat(),
                                        "execution_duration": round(time.time() - start_time, 3)
                                    }
                                    
                                    task_validation_results.append(result_data)
                                    
                                    # è¾“å‡ºéªŒè¯ç»“æœ
                                    result_status = "[PASS]" if result_data['is_pass'] else "[FAIL]"
                                    logging.info(f"{result_status} è¡¨è¾¾å¼éªŒè¯: {result_data['details']}")
                                    
                                except Exception as expr_error:
                                    logging.error(f"è¡¨è¾¾å¼éªŒè¯å¼‚å¸¸: {expr_error}")
                                    result_data = {
                                        "id": source_task_id,
                                        "description": f"ä»»åŠ¡ {source_task_id} è¡¨è¾¾å¼éªŒè¯",
                                        "task_id": source_task_id,
                                        "validation_type": "expression",
                                        "expression": expression,
                                        "is_pass": False,
                                        "details": f"è¡¨è¾¾å¼éªŒè¯å¼‚å¸¸: {expr_error}",
                                        "execution_timestamp": datetime.now().isoformat(),
                                        "execution_duration": 0
                                    }
                                    task_validation_results.append(result_data)
                                    
                            elif conditions:
                                # åªæœ‰æ¡ä»¶æ²¡æœ‰è¡¨è¾¾å¼ï¼šéªŒè¯æ‰€æœ‰æ¡ä»¶ï¼Œå¹¶ç”Ÿæˆä»»åŠ¡çº§æ±‡æ€»ç»“æœ
                                logging.info("æ‰§è¡Œæ¡ä»¶éªŒè¯æ¨¡å¼ï¼ˆä»»åŠ¡çº§æ±‡æ€»ï¼‰")
                                
                                conditions_start_time = time.time()
                                condition_results = []  # æ”¶é›†æ¯ä¸ªæ¡ä»¶çš„ç»“æœï¼Œä½†ä¸ç›´æ¥è¾“å‡ºåˆ°expected_results

                                # å¤„ç†æ‰€æœ‰æ¡ä»¶ï¼ˆåŒ…æ‹¬CANæ¡ä»¶ï¼‰
                                for condition_index, condition in enumerate(conditions):
                                    logging.info(f"{'='*50}")
                                    logging.info(f"éªŒè¯æ¡ä»¶ {condition_index + 1}: {condition.get('description', condition.get('id', 'æœªçŸ¥'))}")
                                    logging.info(f"æ¡ä»¶ID: {condition.get('id', 'æœªçŸ¥')}")
                                    logging.info(f"éªŒè¯æ¨¡å¼: {condition.get('mode', 'unknown')}")
                                    
                                    # å¼ºåˆ¶åˆ·æ–°æ—¥å¿—
                                    for handler in logging.getLogger().handlers:
                                        handler.flush()

                                    start_time = time.time()

                                    try:
                                        # è·å–CANæ–‡ä»¶è·¯å¾„ï¼ˆå¦‚æœæ˜¯CANæ¡ä»¶éœ€è¦ï¼‰
                                        current_can_file_path = get_current_can_file_path(source_task_id) if condition.get('data_source') == 'can_signal' else None
                                        
                                        # ä½¿ç”¨ validate_validation_model éªŒè¯å•ä¸ªæ¡ä»¶
                                        validation_result = validate_validation_model(
                                            validation_model=condition,
                                            device=device,
                                            runner_dir=runner_dir,
                                            screenshot_count=screenshot_count + condition_index,
                                            can_file_path=current_can_file_path
                                        )
                                        
                                        # æ”¶é›†æ¡ä»¶éªŒè¯ç»“æœï¼ˆä¸ç›´æ¥è¾“å‡ºåˆ°expected_resultsï¼‰
                                        condition_result_data = {
                                            "id": condition.get('id', f'{source_task_id}_condition_{condition_index + 1}'),
                                            "description": condition.get('description', f'ä»»åŠ¡ {source_task_id} æ¡ä»¶éªŒè¯'),
                                            "task_id": source_task_id,
                                            "validation_type": "condition",
                                            "condition_index": condition_index,
                                            "is_pass": validation_result.get('is_pass', False),
                                            "details": validation_result.get('message', 'æ¡ä»¶éªŒè¯å®Œæˆ'),
                                            "validation_result": validation_result,
                                            "execution_timestamp": datetime.now().isoformat()
                                        }
                                        condition_results.append(condition_result_data)
                                        
                                        # è¾“å‡ºéªŒè¯ç»“æœæ—¥å¿—
                                        result_status = "[PASS]" if condition_result_data['is_pass'] else "[FAIL]"
                                        logging.info(f"{result_status} æ¡ä»¶éªŒè¯: {condition_result_data['details']}")
                                        
                                    except Exception as condition_error:
                                        logging.error(f"æ¡ä»¶éªŒè¯å¼‚å¸¸: {condition_error}")
                                        condition_result_data = {
                                            "id": condition.get('id', f'{source_task_id}_condition_{condition_index + 1}'),
                                            "description": condition.get('description', f'ä»»åŠ¡ {source_task_id} æ¡ä»¶éªŒè¯'),
                                            "task_id": source_task_id,
                                            "validation_type": "condition",
                                            "condition_index": condition_index,
                                            "is_pass": False,
                                            "details": f"æ¡ä»¶éªŒè¯å¼‚å¸¸: {condition_error}",
                                            "execution_timestamp": datetime.now().isoformat()
                                        }
                                        condition_results.append(condition_result_data)

                                # æ¡ä»¶éªŒè¯å®Œæˆåï¼Œç”Ÿæˆä»»åŠ¡çº§åˆ«çš„æ±‡æ€»ç»“æœ
                                total_conditions = len(condition_results)
                                passed_conditions = sum(1 for r in condition_results if r.get('is_pass', False))
                                failed_conditions = total_conditions - passed_conditions
                                overall_pass = (failed_conditions == 0)

                                summary_details = f"æ¡ä»¶éªŒè¯{'é€šè¿‡' if overall_pass else 'å¤±è´¥'}: é€šè¿‡={passed_conditions}, å¤±è´¥={failed_conditions}"
                                task_result_data = {
                                    "id": source_task_id,
                                    "description": f"ä»»åŠ¡ {source_task_id} æ¡ä»¶éªŒè¯æ±‡æ€»",
                                    "task_id": source_task_id,
                                    "validation_type": "conditions",
                                    "conditions_count": total_conditions,
                                    "passed_conditions": passed_conditions,
                                    "failed_conditions": failed_conditions,
                                    "is_pass": overall_pass,
                                    "details": summary_details,
                                    "execution_timestamp": datetime.now().isoformat(),
                                    "execution_duration": round(time.time() - conditions_start_time, 3)
                                }
                                task_validation_results.append(task_result_data)
                                        
                            else:
                                logging.warning(f"ä»»åŠ¡ {source_task_id} æ—¢æ²¡æœ‰è¡¨è¾¾å¼ä¹Ÿæ²¡æœ‰æ¡ä»¶ï¼Œè·³è¿‡éªŒè¯")
                                    
                        else:
                            logging.info(f"ä»»åŠ¡ {source_task_id} æ²¡æœ‰é…ç½®é¢„æœŸç»“æœï¼Œè·³è¿‡ verify_after éªŒè¯")

                        # å°†éªŒè¯ç»“æœæ·»åŠ åˆ°å…¨å±€ç»“æœåˆ—è¡¨
                        global verify_after_results
                        if 'verify_after_results' not in globals():
                            verify_after_results = []
                        verify_after_results.extend(task_validation_results)

                        # è¾“å‡ºéªŒè¯æ‘˜è¦
                        if task_validation_results:
                            total_results = len(task_validation_results)
                            passed_results = sum(1 for r in task_validation_results if r["is_pass"])
                            failed_results = total_results - passed_results
                            
                            logging.info(f"ä»»åŠ¡ {source_task_id} verify_after éªŒè¯å®Œæˆ: æ€»æ•°={total_results}, é€šè¿‡={passed_results}, å¤±è´¥={failed_results}")
                            
                            if failed_results > 0:
                                logging.warning(f"ä»»åŠ¡ {source_task_id} verify_after éªŒè¯æœ‰{failed_results}ä¸ªå¤±è´¥é¡¹")
                        else:
                            logging.info(f"ä»»åŠ¡ {source_task_id} æ— éœ€ verify_after éªŒè¯")

                        logging.info(f"{'='*20} ä»»åŠ¡ {source_task_id} verify_after éªŒè¯ç»“æŸ {'='*20}")
                        
                        # ==================== é˜¶æ®µ4: CAN é‡‡é›†åœæ­¢æ£€æŸ¥ ====================
                        # æ£€æŸ¥æ˜¯å¦éœ€è¦åœæ­¢CANé‡‡é›†
                        if is_can_capture_running(source_task_id):
                            # æ£€æŸ¥æ˜¯å¦è¿˜æœ‰åç»­çš„éªŒè¯æ­¥éª¤
                            has_remaining_steps = check_remaining_verify_steps(action_sequence, step_index, source_task_id)
                            
                            if not has_remaining_steps:
                                logging.info(f"ğŸ”„ ä»»åŠ¡ {source_task_id} æ²¡æœ‰åç»­éªŒè¯æ­¥éª¤ï¼Œæ­£åœ¨åœæ­¢CANé‡‡é›†...")
                                try:
                                    stop_success = stop_can_capture(source_task_id)
                                    if stop_success:
                                        logging.info(f"âœ… ä»»åŠ¡ {source_task_id} CANé‡‡é›†å·²æˆåŠŸåœæ­¢")
                                    else:
                                        logging.warning(f"âš ï¸ ä»»åŠ¡ {source_task_id} CANé‡‡é›†åœæ­¢å¤±è´¥")
                                except Exception as can_stop_error:
                                    logging.error(f"âŒ åœæ­¢CANé‡‡é›†å¼‚å¸¸: {can_stop_error}")
                            else:
                                logging.info(f"ğŸ“‹ ä»»åŠ¡ {source_task_id} è¿˜æœ‰åç»­éªŒè¯æ­¥éª¤ï¼Œç»§ç»­ä¿æŒCANé‡‡é›†")
                        
                        # æ›´æ–°æˆªå›¾è®¡æ•°ï¼ˆéªŒè¯è¿‡ç¨‹ä¸­å¯èƒ½äº§ç”Ÿæ–°çš„æˆªå›¾ï¼‰
                        screenshot_count += 2  # é¢„ç•™ç©ºé—´ç»™éªŒè¯æˆªå›¾
                        
                    except Exception as verify_error:
                        logging.error(f"verify_after éªŒè¯å¼‚å¸¸: {verify_error}")
                        import traceback
                        logging.error(traceback.format_exc())
                elif verify_after and not source_task_id:
                    logging.warning(f"æ­¥éª¤ {step_number} è®¾ç½®äº† verify_after=true ä½†ç¼ºå°‘ source_task_idï¼Œè·³è¿‡éªŒè¯")
                elif source_task_id and not verify_after:
                    logging.debug(f"æ­¥éª¤ {step_number} æœ‰ source_task_id ä½† verify_after=falseï¼Œè·³è¿‡éªŒè¯")
                
                # è®°å½•æ­¥éª¤è€—æ—¶
                step_duration = time.time() - step_start_time
                logging.info(f"æ­¥éª¤ {step_number} è€—æ—¶: {step_duration:.3f}ç§’")
                
                # æ›´æ–°execution_resultä¸­çš„durationå­—æ®µ
                if 'execution_result' in step_data:
                    step_data['execution_result']['duration'] = round(step_duration, 3)
                
                # æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸­çš„æ­¥éª¤å®Œæˆä¿¡æ¯
                task_status["last_completed_step"] = step_number
                task_status["last_step_duration"] = step_duration
                task_status["last_step_success"] = (step_data.get('status') == 'success')
                
                # æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸­çš„æ£€æŸ¥ç‚¹å®Œæˆä¿¡æ¯
                checkpoint_info = step_data.get('checkpoint', {})
                task_status["current_checkpoint_status"] = {
                    "step_number": step_number,
                    "step_name": step_name,
                    "current_phase": "å·²å®Œæˆ",
                    "status": checkpoint_info.get("status", "æœªçŸ¥"),
                    "is_pass": checkpoint_info.get("is_pass", False),
                    "detail": checkpoint_info.get("detail", ""),
                    "last_update": datetime.now().isoformat(),
                    "execution_duration": step_duration,
                    "checkpoint_type": checkpoint_info.get("type", "unknown"),
                    "operation_mode": checkpoint_info.get("operation_mode", "unknown"),
                    "validation_duration": checkpoint_info.get("validation_duration", 0)
                }
                
                # æ›´æ–°æ‰§è¡Œå†å²è®°å½•
                if "execution_history" not in task_status:
                    task_status["execution_history"] = []
                
                # æ·»åŠ å½“å‰æ­¥éª¤æ‰§è¡Œç»“æœåˆ°å†å²è®°å½•
                execution_history_entry = {
                    "step_number": step_number,
                    "step_name": step_name,
                    "operation_type": operation_type,  # æ·»åŠ operation_typeå­—æ®µ
                    "is_pass": checkpoint_info.get("is_pass", False),
                    "status": checkpoint_info.get("status", "æœªçŸ¥"),
                    "detail": checkpoint_info.get("detail", ""),
                    "checkpoint_type": checkpoint_info.get("type", "unknown"),
                    "operation_mode": checkpoint_info.get("operation_mode", "unknown"),
                    "validation_duration": checkpoint_info.get("validation_duration", 0),
                    "completed_at": checkpoint_info.get("completed_at", datetime.now().isoformat()),
                    "screenshot_available": bool(checkpoint_info.get("screenshot_path"))
                }
                task_status["execution_history"].append(execution_history_entry)
                
                # æ›´æ–°æ£€æŸ¥ç‚¹ç»Ÿè®¡ä¿¡æ¯
                total_checkpoints = len(task_status["execution_history"])
                passed_checkpoints = sum(1 for cp in task_status["execution_history"] if cp.get("is_pass", False))
                failed_checkpoints = total_checkpoints - passed_checkpoints
                
                task_status["checkpoint_summary"] = {
                    "total_checkpoints": total_checkpoints,
                    "passed_checkpoints": passed_checkpoints,
                    "failed_checkpoints": failed_checkpoints,
                    "success_rate": round((passed_checkpoints / total_checkpoints * 100), 2) if total_checkpoints > 0 else 0,
                    "last_checkpoint_result": checkpoint_info.get("is_pass", False)
                }
                
                # å®æ—¶ä¿å­˜æ›´æ–°åçš„ä»»åŠ¡çŠ¶æ€
                with open(task_status_file, 'w', encoding='utf-8', newline='') as f:
                    json.dump(task_status, f, ensure_ascii=False, indent=2, default=str)
    
    # å®æ‰§è¡Œå®Œæˆï¼Œå˜é‡å·²æ›´æ–°
{% endmacro %}
