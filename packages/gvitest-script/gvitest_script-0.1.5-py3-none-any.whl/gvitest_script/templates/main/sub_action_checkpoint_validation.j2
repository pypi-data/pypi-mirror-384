{# æ§åˆ¶æµå­æ­¥éª¤æ£€æŸ¥ç‚¹éªŒè¯æ¨¡æ¿ - ä¸“é—¨ç”¨äºæ§åˆ¶æµä¸­çš„å­åŠ¨ä½œæ£€æŸ¥ç‚¹éªŒè¯ #}

{% macro execute_sub_action_checkpoint_validation(step_data, device, runner_dir, screenshot_count, previous_after_screenshot) %}
        {# æ§åˆ¶æµå­æ­¥éª¤æ£€æŸ¥ç‚¹éªŒè¯å® - ä½¿ç”¨8ç©ºæ ¼ç¼©è¿›é€‚é…æ§åˆ¶æµå¤„ç†å™¨å‡½æ•° #}
        step_number = step_data.get('step_number', 0)
        operation_type = step_data.get('operation_type', 'unknown')
        operation_mode = step_data.get('mode', 'agent')
        
        # è·å–æ£€æŸ¥ç‚¹é…ç½®
        checkpoint_config = step_data.get("checkpoint", {})
        checkpoint_type = checkpoint_config.get("type", "none")
        expected_value = checkpoint_config.get("expected", "")
        target_bbox = checkpoint_config.get("target_bbox", [])
        description = checkpoint_config.get("description", "")
        
        logging.info(f"å¼€å§‹æ‰§è¡Œå­æ­¥éª¤ {step_number} çš„æ£€æŸ¥ç‚¹å‰ç½®éªŒè¯")
        
        # å®šä¹‰æ— æ£€æŸ¥ç‚¹çš„æ“ä½œç±»å‹è§„åˆ™
        camera_ops = {"black_open", "black_close", "flower_open", "flower_close", "lag_open", "lag_close", "flash_open", "flash_close"}

        # æ£€æŸ¥ç‚¹å‚æ•°å……è¶³æ€§åˆ¤æ–­
        def is_checkpoint_params_sufficient():
            """åˆ¤æ–­æ£€æŸ¥ç‚¹å‚æ•°æ˜¯å¦å……è¶³"""
            if checkpoint_type == "none":
                return False
            elif checkpoint_type == "text":
                # textç±»å‹éœ€è¦expectedå­˜åœ¨
                return bool(expected_value)
            elif checkpoint_type == "image":
                # imageç±»å‹éœ€è¦expectedå’Œtarget_bboxéƒ½å­˜åœ¨
                return bool(expected_value) and bool(target_bbox) and len(target_bbox) == 4
            else:
                # å…¶ä»–ç±»å‹éœ€è¦expectedå­˜åœ¨
                return bool(expected_value)

        # æ–°è§„åˆ™ï¼š
        # 1) can_send ä¸æ‘„åƒå¤´æ“ä½œï¼šä»ä¸äº§ç”Ÿæ£€æŸ¥ç‚¹
        # 2) æ£€æŸ¥ç‚¹ç±»å‹ä¸ºnoneï¼šè·³è¿‡éªŒè¯
        # 3) æ£€æŸ¥ç‚¹å‚æ•°ä¸å……è¶³ï¼šè·³è¿‡éªŒè¯
        no_checkpoint = (
            operation_type == "can_send" or
            operation_type in camera_ops or
            checkpoint_type == "none" or
            not is_checkpoint_params_sufficient()
        )

        if no_checkpoint:
            # ç¡®å®šè·³è¿‡åŸå› 
            skip_reason = ""
            if operation_type == "can_send":
                skip_reason = "can_sendæ“ä½œä¸æ”¯æŒæ£€æŸ¥ç‚¹"
            elif operation_type in camera_ops:
                skip_reason = "æ‘„åƒå¤´æ“ä½œä¸æ”¯æŒæ£€æŸ¥ç‚¹"
            elif checkpoint_type == "none":
                skip_reason = "æ£€æŸ¥ç‚¹ç±»å‹ä¸ºnone"
            elif not is_checkpoint_params_sufficient():
                if checkpoint_type == "text" and not expected_value:
                    skip_reason = "textç±»å‹æ£€æŸ¥ç‚¹ç¼ºå°‘expectedå‚æ•°"
                elif checkpoint_type == "image" and (not expected_value or not target_bbox or len(target_bbox) != 4):
                    skip_reason = "imageç±»å‹æ£€æŸ¥ç‚¹ç¼ºå°‘expectedæˆ–target_bboxå‚æ•°"
                else:
                    skip_reason = "æ£€æŸ¥ç‚¹å‚æ•°ä¸å……è¶³"
            else:
                skip_reason = "æœªçŸ¥åŸå› "
            
            logging.info(f"è·³è¿‡å­æ­¥éª¤æ£€æŸ¥ç‚¹éªŒè¯: {skip_reason}")
            checkpoint_result = {
                "type": checkpoint_type,
                "description": description,
                "screenshot_path": None,
                "is_pass": True,
                "detail": f"è·³è¿‡å­æ­¥éª¤æ£€æŸ¥ç‚¹éªŒè¯: {skip_reason}",
                "similarity_score": None,
                "status": "è·³è¿‡",
                "execution_time": 0,
                "executed_at": datetime.now().isoformat(),
                "error_message": None
            }
            checkpoint_passed = True
        else:
            # æ‰§è¡Œæ£€æŸ¥ç‚¹éªŒè¯
            validation_start_time = time.time()
            
            try:
                # å…ˆæˆªå›¾è·å–å½“å‰ç•Œé¢çŠ¶æ€
                if previous_after_screenshot:
                    # ä½¿ç”¨å‰ä¸€æ­¥çš„åæˆªå›¾ä½œä¸ºå½“å‰çš„å‰æˆªå›¾
                    before_screenshot = previous_after_screenshot
                    logging.info(f"ğŸ“¸ å¤ç”¨å‰ä¸€æ­¥æˆªå›¾ä½œä¸ºå­æ­¥éª¤æ£€æŸ¥ç‚¹éªŒè¯æˆªå›¾: {before_screenshot}")
                else:
                    # æ‹æ‘„æ–°çš„æˆªå›¾
                    before_screenshot = take_screenshot_and_save(
                        device, runner_dir, f"sub_checkpoint_before_step{step_number}", "å­æ­¥éª¤æ£€æŸ¥ç‚¹å‰ç½®éªŒè¯æˆªå›¾"
                    )
                
                # ä½¿ç”¨ç»Ÿä¸€çš„validation_utilsç®—æ³•è¿›è¡ŒéªŒè¯
                if checkpoint_type in ["image", "text"] and expected_value:
                    logging.info(f"æ‰§è¡Œå­æ­¥éª¤{checkpoint_type}æ£€æŸ¥ç‚¹éªŒè¯: æœŸæœ›å€¼ {expected_value}")
                    
                    # æ„é€ ValidationModelæ ¼å¼çš„æ•°æ®ï¼Œå¤ç”¨validation_utils.j2çš„ç»Ÿä¸€ç®—æ³•
                    validation_model = {
                        "id": f"sub_checkpoint_step_{step_number}",
                        "description": f"å­æ­¥éª¤{step_number}æ£€æŸ¥ç‚¹éªŒè¯",
                        "mode": "agent",  # checkpointå›ºå®šä½¿ç”¨agentæ¨¡å¼
                        "data_source": "adb_screenshot",  # checkpointå›ºå®šä½¿ç”¨ADBæˆªå›¾
                        "validation_type": checkpoint_type,
                        "expect_exists": True,  # checkpointé»˜è®¤æœŸæœ›å­˜åœ¨
                    }
            
                    # æ ¹æ®éªŒè¯ç±»å‹è®¾ç½®ä¸åŒå‚æ•°
                    if checkpoint_type == "image":
                        # reference_image_pathåº”è¯¥æ˜¯å½•åˆ¶æ—¶çš„å¤§å›¾ï¼Œå³screenshot_path
                        reference_image_path = step_data.get('screenshot_path')
                        if not reference_image_path:
                            # å¦‚æœå½•åˆ¶æ—¶æ²¡æœ‰æˆªå›¾ï¼Œä½¿ç”¨å½“å‰æˆªå›¾ä½œä¸ºå‚è€ƒ
                            reference_image_path = before_screenshot
                            logging.info(f"å½•åˆ¶æ—¶æ— æˆªå›¾ï¼Œä½¿ç”¨å½“å‰æˆªå›¾ä½œä¸ºå‚è€ƒ: {reference_image_path}")
                        else:
                            logging.info(f"ä½¿ç”¨å½•åˆ¶æ—¶æˆªå›¾ä½œä¸ºå‚è€ƒ: {reference_image_path}")
                        
                        validation_model.update({
                            "target_image_path": expected_value,
                            "reference_image_path": reference_image_path,
                            "target_bbox": target_bbox,
                            "roi_coordinates": None  # ä¸é™åˆ¶ROI
                        })
                    elif checkpoint_type == "text":
                        validation_model.update({
                            "target_text": expected_value
                        })
            
                    # è°ƒç”¨ç»Ÿä¸€çš„éªŒè¯å‡½æ•°
                    validation_result = validate_validation_model(
                        validation_model=validation_model,
                        device=device,
                        runner_dir=runner_dir,
                        screenshot_count=screenshot_count
                    )
                    
                    # å°†validationç»“æœè½¬æ¢ä¸ºcheckpointç»“æœæ ¼å¼
                    is_pass = validation_result.get('is_pass', False)
                    
                    if is_pass:
                        logging.info(f"âœ… å­æ­¥éª¤{checkpoint_type}æ£€æŸ¥ç‚¹éªŒè¯é€šè¿‡")
                        checkpoint_result = {
                            "type": checkpoint_type,
                            "description": description,
                            "screenshot_path": before_screenshot,
                            "is_pass": True,
                            "detail": f"å­æ­¥éª¤{checkpoint_type}æ£€æŸ¥ç‚¹éªŒè¯é€šè¿‡: {validation_result.get('details', '')}",
                            "similarity_score": validation_result.get('similarity_score'),
                            "status": "é€šè¿‡",
                            "execution_time": time.time() - validation_start_time,
                            "executed_at": datetime.now().isoformat(),
                            "error_message": None
                        }
                        checkpoint_passed = True
                    else:
                        logging.warning(f"âŒ å­æ­¥éª¤{checkpoint_type}æ£€æŸ¥ç‚¹éªŒè¯å¤±è´¥")
                        checkpoint_result = {
                            "type": checkpoint_type,
                            "description": description,
                            "screenshot_path": before_screenshot,
                            "is_pass": False,
                            "detail": f"å­æ­¥éª¤{checkpoint_type}æ£€æŸ¥ç‚¹éªŒè¯å¤±è´¥: {validation_result.get('details', '')}",
                            "similarity_score": validation_result.get('similarity_score'),
                            "status": "å¤±è´¥",
                            "execution_time": time.time() - validation_start_time,
                            "executed_at": datetime.now().isoformat(),
                            "error_message": None
                        }
                        checkpoint_passed = False

                else:
                    # å…¶ä»–ç±»å‹æˆ–æ— æœŸæœ›å€¼ï¼Œé»˜è®¤é€šè¿‡
                    logging.info(f"å­æ­¥éª¤æ£€æŸ¥ç‚¹ç±»å‹ {checkpoint_type} æ— éœ€éªŒè¯æˆ–æ— æœŸæœ›å€¼ï¼Œé»˜è®¤é€šè¿‡")
                    checkpoint_result = {
                        "type": checkpoint_type,
                        "description": description,
                        "screenshot_path": before_screenshot,
                        "is_pass": True,
                        "detail": f"å­æ­¥éª¤æ£€æŸ¥ç‚¹ç±»å‹ {checkpoint_type} æ— éœ€éªŒè¯ï¼Œé»˜è®¤é€šè¿‡",
                        "similarity_score": None,
                        "status": "é€šè¿‡",
                        "execution_time": time.time() - validation_start_time,
                        "executed_at": datetime.now().isoformat(),
                        "error_message": None
                    }
                    checkpoint_passed = True
            
            except Exception as e:
                logging.error(f"å­æ­¥éª¤æ£€æŸ¥ç‚¹å‰ç½®éªŒè¯å¼‚å¸¸: {e}")
                checkpoint_result = {
                    "type": checkpoint_type,
                    "description": description,
                    "screenshot_path": None,
                    "is_pass": False,
                    "detail": f"å­æ­¥éª¤æ£€æŸ¥ç‚¹å‰ç½®éªŒè¯å¼‚å¸¸: {str(e)}",
                    "similarity_score": None,
                    "status": "é”™è¯¯",
                    "execution_time": time.time() - validation_start_time,
                    "executed_at": datetime.now().isoformat(),
                    "error_message": str(e)
                }
                checkpoint_passed = False
{% endmacro %}
