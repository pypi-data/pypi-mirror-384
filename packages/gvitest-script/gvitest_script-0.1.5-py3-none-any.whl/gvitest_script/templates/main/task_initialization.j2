{# ä»»åŠ¡åˆå§‹åŒ–æ¨¡å— - å¤„ç†ä»»åŠ¡å¼€å§‹æ—¶çš„åˆå§‹åŒ–é€»è¾‘ #}

{% macro initialize_task() %}
    task_id = "{{ context.script_id }}"
    description = "{{ context.description }}"
    workspace_root = Path("{{ context.execution_config.workspace_root | escape_path_for_python }}")

    # å¼€å§‹ä»»åŠ¡è¿½è¸ª
    logging.info(f"ä»»åŠ¡å¼€å§‹: {task_id} - {description}")
    start_time = time.time()
    
    # åˆ›å»ºä»»åŠ¡çº§åˆ«çš„çŠ¶æ€è¿½è¸ª
    task_status = {
        "task_id": task_id,
        "description": description,
        "status": "åˆå§‹åŒ–",
        "start_time": datetime.now().isoformat(),
        "current_step": 0,
        "total_steps": 0,
        "progress_percentage": 0.0,
        "phase_history": []
    }

    # è®¾ç½®æ—¥å¿—ç³»ç»Ÿ
    # è®¾ç½®ç‹¬ç«‹æ—¥å¿—æ–‡ä»¶
    # ä½¿ç”¨å·²å®šä¹‰çš„å˜é‡è€Œä¸æ˜¯context
    log_dir = workspace_root / task_id / "logs"
    log_dir.mkdir(parents=True, exist_ok=True)

    # é…ç½®æ—¥å¿—æ–‡ä»¶
    log_file = log_dir / f"script_{task_id}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.log"

    # è®¾ç½®æ—¥å¿—æ ¼å¼
    log_format = '%(asctime)s - %(levelname)s - %(message)s'

    # æ¸…é™¤ä»»ä½•å·²æœ‰çš„æ—¥å¿—é…ç½®
    for handler in logging.root.handlers[:]:
        logging.root.removeHandler(handler)

    # é…ç½®æ—¥å¿—å¤„ç†å™¨ - ç¡®ä¿æ–‡ä»¶å†™å…¥ä¼˜å…ˆçº§å’ŒWindowså…¼å®¹æ€§
    file_handler = logging.FileHandler(str(log_file), encoding='utf-8', mode='w')
    file_handler.setLevel(logging.INFO)
    file_handler.setFormatter(logging.Formatter(log_format))
    
    # Windowså…¼å®¹æ€§ï¼šç¡®ä¿æ§åˆ¶å°è¾“å‡ºç¼–ç æ­£ç¡®
    console_handler = logging.StreamHandler(sys.stdout)
    console_handler.setLevel(logging.INFO)
    console_handler.setFormatter(logging.Formatter(log_format))
    
    # é…ç½®æ ¹æ—¥å¿—å™¨
    logging.root.setLevel(logging.INFO)
    logging.root.addHandler(file_handler)
    logging.root.addHandler(console_handler)

    # å¼ºåˆ¶åˆ·æ–°æ—¥å¿—
    logging.getLogger().handlers[0].flush()

    logging.info(f"æ—¥å¿—ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œæ—¥å¿—æ–‡ä»¶: {log_file}")
    logging.info(f"ä»»åŠ¡ID: {task_id}")
    logging.info(f"å½“å‰æ—¶é—´: {datetime.now().isoformat()}")
    logging.info(f"Pythonç‰ˆæœ¬: {sys.version}")
    logging.info(f"å·¥ä½œç›®å½•: {workspace_root}")
    
    # å¼ºåˆ¶åˆ·æ–°ç¡®ä¿åˆå§‹åŒ–æ—¥å¿—è¢«å†™å…¥
    for handler in logging.getLogger().handlers:
        handler.flush()
    
    # è¿æ¥è®¾å¤‡
    device = u2.connect()
    logging.info("âœ¨ è®¾å¤‡è¿æ¥æˆåŠŸ")
    
    # è®¾ç½®å·¥ä½œç›®å½•
    runner_dir = workspace_root / task_id / "runner"
    runner_dir.mkdir(parents=True, exist_ok=True)
    
    # åˆå§‹åŒ–å˜é‡
    action_sequence = [
        {% for step in context.action_sequence %}
        {{ step.to_dict() | to_python_dict }}{% if not loop.last %},{% endif %}
        {% endfor %}
    ]
    screenshot_count = 0
    
    logging.info(f"ä»»åŠ¡å¼€å§‹: {description}")
    logging.info(f"æ­¥éª¤æ€»æ•°: {len(action_sequence)}")
    
    # æ›´æ–°ä»»åŠ¡çŠ¶æ€
    task_status["total_steps"] = len(action_sequence)
    task_status["status"] = "æ‰§è¡Œä¸­"
    task_status["action_sequence"] = action_sequence  # ä¿å­˜åŠ¨ä½œåºåˆ—
    
    # ä¿å­˜åˆå§‹ä»»åŠ¡çŠ¶æ€
    task_status_file = runner_dir / "task_status.json"
    with open(task_status_file, 'w', encoding='utf-8') as f:
        json.dump(task_status, f, ensure_ascii=False, indent=2, default=str)
    
    # é¢„å¤„ç†ï¼šæ ‡è®°æ¯ä¸ªä»»åŠ¡çš„ç¬¬ä¸€ä¸ªæ­¥éª¤ï¼ˆä¼˜åŒ–CANé‡‡é›†å¯åŠ¨åˆ¤æ–­ï¼‰
    task_first_step_map = {}  # {task_id: first_step_index}
    for idx, step in enumerate(action_sequence):
        task_id = step.get('source_task_id')
        if task_id and task_id not in task_first_step_map:
            task_first_step_map[task_id] = idx
    
    logging.info(f"ğŸ“‹ é¢„å¤„ç†å®Œæˆï¼Œå‘ç° {len(task_first_step_map)} ä¸ªä»»åŠ¡çš„é¦–æ­¥ä¿¡æ¯")
    
    {% if context is defined and context.expected_results %}
    # åˆå§‹åŒ–é¢„æœŸç»“æœé…ç½®ï¼ˆå…¨å±€å¯ç”¨ï¼‰
    all_expected_results = {{ context.expected_results | to_python_dict }}
    {% else %}
    all_expected_results = {}
    {% endif %}
    
    return (device, runner_dir, screenshot_count, action_sequence, task_status, 
            task_status_file, start_time, task_first_step_map, all_expected_results)
{% endmacro %}
