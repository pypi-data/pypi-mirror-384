{# å¤„ç†å™¨éœ€æ±‚æ£€æµ‹æ¨¡å— - åˆ†æåŠ¨ä½œåºåˆ—å¹¶ç¡®å®šéœ€è¦åŒ…å«çš„å¤„ç†å™¨ #}

{# æ”¶é›†éœ€è¦çš„æ“ä½œç±»å‹ï¼Œé¿å…é‡å¤åŒ…å« #}
{% set required_handlers = [] %}
{% for step in context.action_sequence %}
    {% if step %}
        {% set step_type = (step.step_type | default('action') | string).lower() %}
        
        {% if step_type == 'control_flow' %}
            {# æ§åˆ¶æµæ­¥éª¤éœ€è¦ç‰¹æ®Šå¤„ç† #}
            {% if 'control_flow' not in required_handlers %}
                {% set _ = required_handlers.append('control_flow') %}
            {% endif %}
            
            {# ğŸ”„ é€’å½’æ£€æŸ¥æ§åˆ¶æµå†…éƒ¨çš„å¾ªç¯ä½“æ­¥éª¤ #}
            {% if step.control_flow_config and step.control_flow_config.loop_body %}
                {% for loop_step in step.control_flow_config.loop_body %}
                    {% if loop_step %}
                        {% set loop_operation_type = (loop_step.operation_type | default('unknown') | string).lower() %}
                        {% set loop_is_manual = (loop_step.mode | default('agent')) == 'manual' %}
                        
                        {% if loop_is_manual and 'manual' not in required_handlers %}
                            {% set _ = required_handlers.append('manual') %}
                        {% endif %}
                        
                        {% if loop_operation_type in ['click', 'tap', 'long_click', 'double_click'] and 'click' not in required_handlers %}
                            {% set _ = required_handlers.append('click') %}
                        {% elif loop_operation_type in ['type', 'input'] and 'type' not in required_handlers %}
                            {% set _ = required_handlers.append('type') %}
                        {% elif loop_operation_type in ['swipe', 'drag'] and 'swipe' not in required_handlers %}
                            {% set _ = required_handlers.append('swipe') %}
                        {% elif loop_operation_type == 'scroll' and 'scroll' not in required_handlers %}
                            {% set _ = required_handlers.append('scroll') %}
                        {% elif loop_operation_type == 'can_send' and 'can' not in required_handlers %}
                            {% set _ = required_handlers.append('can') %}
                        {% elif loop_operation_type not in ['click', 'tap', 'long_click', 'double_click', 'type', 'input', 'swipe', 'drag', 'scroll', 'can_send'] and 'default' not in required_handlers %}
                            {% set _ = required_handlers.append('default') %}
                        {% endif %}
                    {% endif %}
                {% endfor %}
            {% endif %}
            
            {# ğŸ”„ é€’å½’æ£€æŸ¥æ§åˆ¶æµå†…éƒ¨çš„åˆ†æ”¯æ­¥éª¤ (if-else) #}
            {% if step.control_flow_config and step.control_flow_config.branches %}
                {% for branch in step.control_flow_config.branches %}
                    {% if branch.steps %}
                        {% for branch_step in branch.steps %}
                            {% if branch_step %}
                                {% set branch_operation_type = (branch_step.operation_type | default('unknown') | string).lower() %}
                                {% set branch_is_manual = (branch_step.mode | default('agent')) == 'manual' %}
                                
                                {% if branch_is_manual and 'manual' not in required_handlers %}
                                    {% set _ = required_handlers.append('manual') %}
                                {% endif %}
                                
                                {% if branch_operation_type in ['click', 'tap', 'long_click', 'double_click'] and 'click' not in required_handlers %}
                                    {% set _ = required_handlers.append('click') %}
                                {% elif branch_operation_type in ['type', 'input'] and 'type' not in required_handlers %}
                                    {% set _ = required_handlers.append('type') %}
                                {% elif branch_operation_type in ['swipe', 'drag'] and 'swipe' not in required_handlers %}
                                    {% set _ = required_handlers.append('swipe') %}
                                {% elif branch_operation_type == 'scroll' and 'scroll' not in required_handlers %}
                                    {% set _ = required_handlers.append('scroll') %}
                                {% elif branch_operation_type == 'can_send' and 'can' not in required_handlers %}
                                    {% set _ = required_handlers.append('can') %}
                                {% elif branch_operation_type not in ['click', 'tap', 'long_click', 'double_click', 'type', 'input', 'swipe', 'drag', 'scroll', 'can_send'] and 'default' not in required_handlers %}
                                    {% set _ = required_handlers.append('default') %}
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                {% endfor %}
            {% endif %}
        {% else %}
            {# æ™®é€šåŠ¨ä½œæ­¥éª¤ - åŸºäºoperation_typeé€‰æ‹©å¤„ç†å™¨ #}
            {% set operation_type = (step.operation_type | default('unknown') | string).lower() %}
            
            {# ä¸“ç”¨å¤„ç†å™¨éœ€æ±‚æ£€æµ‹ #}
            {% if operation_type in ['click', 'tap', 'long_click', 'double_click'] and 'click' not in required_handlers %}
                {% set _ = required_handlers.append('click') %}
            {% elif operation_type in ['type', 'input'] and 'type' not in required_handlers %}
                {% set _ = required_handlers.append('type') %}
            {% elif operation_type in ['swipe', 'drag'] and 'swipe' not in required_handlers %}
                {% set _ = required_handlers.append('swipe') %}
            {% elif operation_type == 'scroll' and 'scroll' not in required_handlers %}
                {% set _ = required_handlers.append('scroll') %}
            {% elif operation_type == 'can_send' and 'can' not in required_handlers %}
                {% set _ = required_handlers.append('can') %}
            {% elif operation_type == 'error' and 'error' not in required_handlers %}
                {% set _ = required_handlers.append('error') %}
            {% else %}
                {# é€šç”¨å¤„ç†å™¨éœ€æ±‚æ£€æµ‹ - æ‰€æœ‰å…¶ä»–æ“ä½œç±»å‹ #}
                {% if 'default' not in required_handlers %}
                    {% set _ = required_handlers.append('default') %}
                {% endif %}
            {% endif %}
        {% endif %}
    {% endif %}
{% endfor %}

{# ==================== å¤„ç†å™¨æ¨¡æ¿åŒ…å« ==================== #}
{# ä¸“ç”¨å¤„ç†å™¨ - å¤æ‚æ“ä½œï¼Œéœ€è¦ç‰¹æ®Šé€»è¾‘ #}
{% if 'click' in required_handlers %}
{% include 'handlers/click_handler.j2' %}
{% endif %}
{% if 'type' in required_handlers %}
{% include 'handlers/type_handler.j2' %}
{% endif %}
{% if 'swipe' in required_handlers %}
{% include 'handlers/swipe_handler.j2' %}
{% endif %}
{% if 'scroll' in required_handlers %}
{% include 'handlers/scroll_handler.j2' %}
{% endif %}
{% if 'can' in required_handlers %}
{% include 'handlers/can_handler.j2' %}
{% endif %}
{% if 'control_flow' in required_handlers %}
{% include 'handlers/control_flow_handler.j2' %}
{% endif %}

{# ç‰¹æ®Šå¤„ç†å™¨ #}
{% if 'error' in required_handlers %}
{% include 'handlers/error_handler.j2' %}
{% endif %}

{# é€šç”¨å¤„ç†å™¨ - ç®€å•æ“ä½œï¼Œæ ‡å‡†æµç¨‹å³å¯ #}
{% if 'default' in required_handlers %}
{% include 'handlers/default_handler.j2' %}
{% endif %}
