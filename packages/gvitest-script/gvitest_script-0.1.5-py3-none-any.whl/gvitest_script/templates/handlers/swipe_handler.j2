{# æ»‘åŠ¨åŠ¨ä½œå¤„ç†æ¨¡æ¿ - æ”¯æŒå¤šç§æ»‘åŠ¨æ–¹å‘å’Œæ™ºèƒ½è·ç¦»è®¡ç®— #}

{# æ»‘åŠ¨åŠ¨ä½œå¤„ç†å‡½æ•° #}
def handle_swipe_action(step_data, device, runner_dir, screenshot_count, previous_after_screenshot=None):
    """
    å¤„ç†æ»‘åŠ¨åŠ¨ä½œ - æ”¯æŒå¤šç§æ»‘åŠ¨æ–¹å‘å’Œæ™ºèƒ½è·ç¦»è®¡ç®—
    
    Args:
        step_data: æ­¥éª¤ä¸Šä¸‹æ–‡å¯¹è±¡
        device: uiautomator2è®¾å¤‡å¯¹è±¡
        runner_dir: è¿è¡Œç›®å½•è·¯å¾„
        screenshot_count: æˆªå›¾è®¡æ•°
        previous_after_screenshot: å‰ä¸€æ­¥çš„æ‰§è¡Œåæˆªå›¾è·¯å¾„ï¼Œç”¨äºä¼˜åŒ–æˆªå›¾æ€§èƒ½
    
    Returns:
        Dict: æ‰§è¡Œç»“æœ
    """
    logging.info("å¼€å§‹æ‰§è¡Œæ­¥éª¤ %s: %s" % (step_data.get('step_number', 0), step_data.get('step_name', 'æœªçŸ¥æ­¥éª¤')))

    step_name = step_data.get('step_name', 'æ»‘åŠ¨æ“ä½œ')
    operation_type = step_data.get('operation_type', 'swipe')
    # å…¼å®¹ä¸¤ç§æ•°æ®ç»“æ„ï¼šç›´æ¥åœ¨æ ¹çº§åˆ«çš„element_infoå’Œåœ¨parametersä¸­çš„element_info
    element_info = step_data.get('element_info', {}) or step_data.get('parameters', {}).get('element_info', {})
    
    logging.info(f"å¼€å§‹æ‰§è¡Œæ»‘åŠ¨æ“ä½œ: {step_name}")
    
    try:
        # æ‰§è¡Œå‰æ— éœ€ç­‰å¾…UIç¨³å®šï¼Œç›´æ¥è¿›è¡Œæ“ä½œ
        
        # ä¼˜åŒ–æˆªå›¾é€»è¾‘ï¼šå¦‚æœæœ‰å‰ä¸€æ­¥çš„æˆªå›¾ï¼Œå°±å¤ç”¨å®ƒ
        step_number = step_data.get('step_number', 0)
        
        if previous_after_screenshot:
            # ä½¿ç”¨å‰ä¸€æ­¥çš„åæˆªå›¾ä½œä¸ºå½“å‰æ­¥éª¤çš„å‰æˆªå›¾ï¼Œé¿å…é‡å¤æˆªå›¾
            before_execution_screenshot_path = previous_after_screenshot
            logging.info(f"ğŸ“¸ å¤ç”¨å‰ä¸€æ­¥æˆªå›¾ä½œä¸ºæ‰§è¡Œå‰æˆªå›¾: {before_execution_screenshot_path}")
        else:
            # ç¬¬ä¸€æ­¥æˆ–æ²¡æœ‰å‰ä¸€æ­¥æˆªå›¾æ—¶ï¼Œéœ€è¦æ–°æˆªå›¾
            before_execution_screenshot_path = take_screenshot_and_save(
                device, runner_dir, f"before_step{step_number}", "æ‰§è¡Œå‰æˆªå›¾ - ç”¨äºè®°å½•æ»‘åŠ¨å‰çŠ¶æ€"
            )
        
        # æ›´æ–°æ­¥éª¤æ‰§è¡Œå‰æˆªå›¾ä¿¡æ¯
        step_data['before_execution_screenshot_path'] = before_execution_screenshot_path
        
        # è·å–æ»‘åŠ¨å‚æ•° - åªä½¿ç”¨ç²¾ç¡®åæ ‡
        start_x = element_info.get('start_x')
        start_y = element_info.get('start_y')
        end_x = element_info.get('end_x')
        end_y = element_info.get('end_y')
        duration = 0.5  # å›ºå®šæ»‘åŠ¨æŒç»­æ—¶é—´
        
        # éªŒè¯å¿…éœ€å‚æ•°
        if start_x is None or start_y is None or end_x is None or end_y is None:
            error_msg = "ç¼ºå°‘æ»‘åŠ¨åæ ‡å‚æ•°: éœ€è¦ start_x, start_y, end_x, end_y"
            logging.error(error_msg)
            return {"status": "failed", "message": error_msg}
        
        # è·å–è®¾å¤‡å±å¹•ä¿¡æ¯ç”¨äºåæ ‡éªŒè¯
        device_info = get_device_info(device)
        screen_width = device_info.get('display_width', 1920)
        screen_height = device_info.get('display_height', 1080)
        
        # éªŒè¯åæ ‡æœ‰æ•ˆæ€§
        if not (0 <= start_x <= screen_width and 0 <= start_y <= screen_height and
                0 <= end_x <= screen_width and 0 <= end_y <= screen_height):
            error_msg = f"æ»‘åŠ¨åæ ‡è¶…å‡ºå±å¹•èŒƒå›´: ({start_x}, {start_y}) -> ({end_x}, {end_y}), å±å¹•: {screen_width}x{screen_height}"
            logging.error(error_msg)
            return {"status": "failed", "message": error_msg}
        
        logging.info(f"ä½¿ç”¨ç²¾ç¡®åæ ‡æ»‘åŠ¨: ({start_x}, {start_y}) -> ({end_x}, {end_y})")
        

        
        # æ‰§è¡Œæ»‘åŠ¨æˆ–æ‹–æ‹½æ“ä½œ
        if operation_type == 'drag':
            logging.info(f"æ‰§è¡Œæ‹–æ‹½: ({start_x}, {start_y}) -> ({end_x}, {end_y})")
            device.drag(start_x, start_y, end_x, end_y)
        else:
            logging.info(f"æ‰§è¡Œæ»‘åŠ¨: ({start_x}, {start_y}) -> ({end_x}, {end_y}), æŒç»­æ—¶é—´: {duration}s")
            device.swipe_points([(start_x, start_y), (end_x, end_y),(end_x + 20, end_y + 20)], duration=duration)
        
        # ç­‰å¾…æ»‘åŠ¨å®Œæˆ
        time.sleep(0.5)
        
        # ç­‰å¾…UIç¨³å®šåè¿›è¡Œæ‰§è¡Œåæˆªå›¾
        logging.info("ç­‰å¾…åŠ¨ä½œæ‰§è¡Œå®ŒæˆåUIç¨³å®š...")
        ui_stable = wait_for_ui_stability(device, timeout=1.0)
        if not ui_stable:
            logging.warning("æ‰§è¡ŒåUIç¨³å®šæ£€æŸ¥è¶…æ—¶ï¼Œç»§ç»­æˆªå›¾")
        
        # æ‰§è¡Œåæˆªå›¾ï¼ˆç»Ÿä¸€ä¸ºæ‰€æœ‰æ»‘åŠ¨æ“ä½œæ·»åŠ ï¼‰
        after_swipe_path = take_screenshot_and_save(
            device, runner_dir, f"after_step{step_number}", "æ‰§è¡Œåæˆªå›¾ - ç”¨äºéªŒè¯æ»‘åŠ¨ç»“æœ"
        )
        step_data['after_execution_screenshot_path'] = after_swipe_path
        
        # å¯é€‰ï¼šéªŒè¯æ»‘åŠ¨æ•ˆæœ
        verify_swipe = element_info.get('verify_swipe', False)
        swipe_verification_success = True
        
        if verify_swipe:
            logging.info("éªŒè¯æ»‘åŠ¨æ•ˆæœ...")
            try:
                # ç­‰å¾…UIç¨³å®š
                time.sleep(0.5)
                
                # ç®€å•çš„å›¾åƒå·®å¼‚æ£€æµ‹ï¼ˆä½¿ç”¨æ–‡ä»¶è·¯å¾„æ¯”è¾ƒï¼‰
                if before_execution_screenshot_path != after_swipe_path:
                    logging.info("âœ… æ»‘åŠ¨æ•ˆæœéªŒè¯é€šè¿‡ï¼šå±å¹•å†…å®¹å‘ç”Ÿå˜åŒ–")
                    swipe_verification_success = True
                else:
                    logging.warning("âš ï¸ æ»‘åŠ¨æ•ˆæœéªŒè¯å¤±è´¥ï¼šå±å¹•å†…å®¹æ— æ˜æ˜¾å˜åŒ–")
                    swipe_verification_success = False
                    
            except Exception as verify_error:
                logging.warning(f"æ»‘åŠ¨æ•ˆæœéªŒè¯å¼‚å¸¸: {verify_error}")
                swipe_verification_success = False
        
        logging.info("æ­¥éª¤ %s å®Œæˆ: %s, æˆåŠŸ: %s" % (step_data.get('step_number', 0), step_data.get('step_name', 'æœªçŸ¥æ­¥éª¤'), swipe_verification_success))
        
        operation_name = "æ‹–æ‹½" if operation_type == 'drag' else "æ»‘åŠ¨"
        logging.info(f"âœ… {operation_name}æ“ä½œå®Œæˆ: {step_name}")
        return {
            "status": "success",
            "message": f"{operation_name}æ“ä½œæˆåŠŸ",
            "start_coordinates": (start_x, start_y),
            "end_coordinates": (end_x, end_y),
            "coordinate_method": "ç²¾ç¡®åæ ‡",
            "duration": duration,
            "verification_passed": swipe_verification_success,
            "screenshots": {
                "before_execution": step_data.get('before_execution_screenshot_path'),
                "after_execution": after_swipe_path
            },

        }
        
    except Exception as e:
        operation_name = "æ‹–æ‹½" if operation_type == 'drag' else "æ»‘åŠ¨"
        error_msg = f"{operation_name}æ“ä½œå¤±è´¥: " + str(e)
        logging.error(error_msg)
        
        # å®æ—¶çŠ¶æ€æ›´æ–°ï¼šé”™è¯¯å¤„ç†
        
        
        # ç¡®ä¿æœ‰æˆªå›¾è®°å½•é”™è¯¯çŠ¶æ€
        if not step_data.get('before_execution_screenshot_path'):
            try:
                error_screenshot_path = take_screenshot_and_save(
                    device, runner_dir, f"error_{operation_type}", "é”™è¯¯æˆªå›¾ - è®°å½•æ»‘åŠ¨æ“ä½œå¤±è´¥æ—¶çš„ç•Œé¢çŠ¶æ€"
                )
                step_data['before_execution_screenshot_path'] = error_screenshot_path
            except Exception as screenshot_error:
                logging.error(f"é”™è¯¯æˆªå›¾å¤±è´¥: {screenshot_error}")
        
        logging.error("æ­¥éª¤ %s æ‰§è¡Œé”™è¯¯: %s, é”™è¯¯: %s" % (step_data.get('step_number', 0), step_data.get('step_name', 'æœªçŸ¥æ­¥éª¤'), error_msg))
        
        return {
            "status": "failed",
            "message": error_msg,
            "start_coordinates": (start_x, start_y) if 'start_x' in locals() else None,
            "end_coordinates": (end_x, end_y) if 'end_x' in locals() else None,
            "checkpoint_context": {
                "operation_completed": False,
                "error_occurred": True,
                "error_message": error_msg,
                "operation_mode": step_data.get('mode', 'manual'),

            }
        }

