{% include 'base/imports.j2' %}
{% include 'base/utilities.j2' %}
{% include 'base/image_utils.j2' %}
{% include 'base/validation_utils.j2' %}
{% include 'base/expression_utils.j2' %}
{% include 'base/can_utils.j2' %}
{% from 'base/logging_setup.j2' import setup_logging %}
# checkpoint_validationå‡½æ•°å°†é€šè¿‡includeåŒ…å«


# ==================== åŠ¨ä½œå¤„ç†å‡½æ•°å®šä¹‰ ====================
{# è„šæœ¬åŸºç¡€æ¨¡æ¿ - å¯¼å…¥åŸºç¡€æ¨¡æ¿å’Œå® #}

{# å¤„ç†å™¨éœ€æ±‚æ£€æµ‹å’Œæ¨¡æ¿åŒ…å« - éœ€è¦åœ¨è¿™é‡Œç›´æ¥å±•å¼€ï¼Œå› ä¸ºéœ€è¦è®¿é—®contextå˜é‡ #}
{# æ”¶é›†éœ€è¦çš„æ“ä½œç±»å‹ï¼Œé¿å…é‡å¤åŒ…å« #}
{% set required_handlers = [] %}
{% for step in context.action_sequence %}
    {% if step %}
        {% set step_type = (step.step_type | default('action') | string).lower() %}
        
        {% if step_type == 'control_flow' %}
            {# æ§åˆ¶æµæ­¥éª¤éœ€è¦ç‰¹æ®Šå¤„ç† #}
            {% if 'control_flow' not in required_handlers %}
                {% set _ = required_handlers.append('control_flow') %}
            {% endif %}
            
            {# ğŸ”„ é€’å½’æ£€æŸ¥æ§åˆ¶æµå†…éƒ¨çš„å¾ªç¯ä½“æ­¥éª¤ #}
            {% if step.control_flow_config and step.control_flow_config.loop_body %}
                {% for loop_step in step.control_flow_config.loop_body %}
                    {% if loop_step %}
                        {% set loop_operation_type = (loop_step.operation_type | default('unknown') | string).lower() %}
                        {% set loop_is_manual = (loop_step.mode | default('agent')) == 'manual' %}
                        
                        {% if loop_is_manual and 'manual' not in required_handlers %}
                            {% set _ = required_handlers.append('manual') %}
                        {% endif %}
                        
                        {% if loop_operation_type in ['click', 'tap', 'long_click', 'double_click'] and 'click' not in required_handlers %}
                            {% set _ = required_handlers.append('click') %}
                        {% elif loop_operation_type in ['type', 'input'] and 'type' not in required_handlers %}
                            {% set _ = required_handlers.append('type') %}
                        {% elif loop_operation_type in ['swipe', 'drag'] and 'swipe' not in required_handlers %}
                            {% set _ = required_handlers.append('swipe') %}
                        {% elif loop_operation_type == 'scroll' and 'scroll' not in required_handlers %}
                            {% set _ = required_handlers.append('scroll') %}
                        {% elif loop_operation_type == 'can_send' and 'can' not in required_handlers %}
                            {% set _ = required_handlers.append('can') %}
                        {% elif loop_operation_type not in ['click', 'tap', 'long_click', 'double_click', 'type', 'input', 'swipe', 'drag', 'scroll', 'can_send'] and 'default' not in required_handlers %}
                            {% set _ = required_handlers.append('default') %}
                        {% endif %}
                    {% endif %}
                {% endfor %}
            {% endif %}
            
            {# ğŸ”„ é€’å½’æ£€æŸ¥æ§åˆ¶æµå†…éƒ¨çš„åˆ†æ”¯æ­¥éª¤ (if-else) #}
            {% if step.control_flow_config and step.control_flow_config.branches %}
                {% for branch in step.control_flow_config.branches %}
                    {% if branch.steps %}
                        {% for branch_step in branch.steps %}
                            {% if branch_step %}
                                {% set branch_operation_type = (branch_step.operation_type | default('unknown') | string).lower() %}
                                {% set branch_is_manual = (branch_step.mode | default('agent')) == 'manual' %}
                                
                                {% if branch_is_manual and 'manual' not in required_handlers %}
                                    {% set _ = required_handlers.append('manual') %}
                                {% endif %}
                                
                                {% if branch_operation_type in ['click', 'tap', 'long_click', 'double_click'] and 'click' not in required_handlers %}
                                    {% set _ = required_handlers.append('click') %}
                                {% elif branch_operation_type in ['type', 'input'] and 'type' not in required_handlers %}
                                    {% set _ = required_handlers.append('type') %}
                                {% elif branch_operation_type in ['swipe', 'drag'] and 'swipe' not in required_handlers %}
                                    {% set _ = required_handlers.append('swipe') %}
                                {% elif branch_operation_type == 'scroll' and 'scroll' not in required_handlers %}
                                    {% set _ = required_handlers.append('scroll') %}
                                {% elif branch_operation_type == 'can_send' and 'can' not in required_handlers %}
                                    {% set _ = required_handlers.append('can') %}
                                {% elif branch_operation_type not in ['click', 'tap', 'long_click', 'double_click', 'type', 'input', 'swipe', 'drag', 'scroll', 'can_send'] and 'default' not in required_handlers %}
                                    {% set _ = required_handlers.append('default') %}
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                {% endfor %}
            {% endif %}
        {% else %}
            {# æ™®é€šåŠ¨ä½œæ­¥éª¤ - åŸºäºoperation_typeé€‰æ‹©å¤„ç†å™¨ #}
            {% set operation_type = (step.operation_type | default('unknown') | string).lower() %}
            
            {# ä¸“ç”¨å¤„ç†å™¨éœ€æ±‚æ£€æµ‹ #}
            {% if operation_type in ['click', 'tap', 'long_click', 'double_click'] and 'click' not in required_handlers %}
                {% set _ = required_handlers.append('click') %}
            {% elif operation_type in ['type', 'input'] and 'type' not in required_handlers %}
                {% set _ = required_handlers.append('type') %}
            {% elif operation_type in ['swipe', 'drag'] and 'swipe' not in required_handlers %}
                {% set _ = required_handlers.append('swipe') %}
            {% elif operation_type == 'scroll' and 'scroll' not in required_handlers %}
                {% set _ = required_handlers.append('scroll') %}
            {% elif operation_type == 'can_send' and 'can' not in required_handlers %}
                {% set _ = required_handlers.append('can') %}
            {% elif operation_type == 'error' and 'error' not in required_handlers %}
                {% set _ = required_handlers.append('error') %}
            {% else %}
                {# é€šç”¨å¤„ç†å™¨éœ€æ±‚æ£€æµ‹ - æ‰€æœ‰å…¶ä»–æ“ä½œç±»å‹ #}
                {% if 'default' not in required_handlers %}
                    {% set _ = required_handlers.append('default') %}
                {% endif %}
            {% endif %}
        {% endif %}
    {% endif %}
{% endfor %}

{# ==================== å¤„ç†å™¨æ¨¡æ¿åŒ…å« ==================== #}
{# ä¸ºäº†ç¡®ä¿æ‰€æœ‰å¤„ç†å™¨éƒ½è¢«åŒ…å«ï¼Œæˆ‘ä»¬ç›´æ¥åŒ…å«æ‰€æœ‰å¤„ç†å™¨æ¨¡æ¿ #}
{# è¿™æ ·å¯ä»¥é¿å…æ¡ä»¶åŒ…å«çš„é—®é¢˜ï¼Œç¡®ä¿ç”Ÿæˆçš„è„šæœ¬åŒ…å«æ‰€æœ‰å¿…è¦çš„å‡½æ•° #}

{# åŒ…å«æ‰€æœ‰å¤„ç†å™¨æ¨¡æ¿ #}
{% include 'handlers/click_handler.j2' %}
{% include 'handlers/type_handler.j2' %}
{% include 'handlers/swipe_handler.j2' %}
{% include 'handlers/scroll_handler.j2' %}
{% include 'handlers/can_handler.j2' %}
{% include 'handlers/control_flow_handler.j2' %}
{% include 'handlers/error_handler.j2' %}
{% include 'handlers/default_handler.j2' %}

{# æ£€æŸ¥ç‚¹éªŒè¯å‡½æ•° #}
{% include 'main/checkpoint_validation.j2' %}

{# åŠ¨ä½œåˆ†å‘å™¨ - éœ€è¦åœ¨handler_detectionä¹‹åï¼Œä»¥ä¾¿è®¿é—®required_handlerså˜é‡ #}
{% include 'main/action_dispatcher.j2' %}

{# ç»“æœå¤„ç†å‡½æ•° #}
{% include 'main/results_processing.j2' %}

# ä¸»å‡½æ•°å®šä¹‰
def main():
    """ä¸»å‡½æ•°ï¼šæ‰§è¡Œè‡ªåŠ¨åŒ–æ“ä½œ - å‡½æ•°åˆ†å‘æ¶æ„"""
    global device, runner_dir, screenshot_count, action_sequence
    
    try:
        # ä»»åŠ¡åˆå§‹åŒ– - ç›´æ¥å†…è”ï¼Œé¿å…contextä½œç”¨åŸŸé—®é¢˜
        task_id = "{{ context.script_id }}"
        description = "{{ context.description }}"
        workspace_root = Path("{{ context.execution_config.workspace_root | escape_path_for_python }}")

        # å¼€å§‹ä»»åŠ¡è¿½è¸ª
        logging.info(f"ä»»åŠ¡å¼€å§‹: {task_id} - {description}")
        start_time = time.time()
        
        # åˆ›å»ºä»»åŠ¡çº§åˆ«çš„çŠ¶æ€è¿½è¸ª
        task_status = {
            "task_id": task_id,
            "description": description,
            "status": "åˆå§‹åŒ–",
            "start_time": datetime.now().isoformat(),
            "current_step": 0,
            "total_steps": 0,
            "progress_percentage": 0.0,
            "phase_history": []
        }

        # è®¾ç½®æ—¥å¿—ç³»ç»Ÿ
        log_dir = workspace_root / task_id / "logs"
        log_dir.mkdir(parents=True, exist_ok=True)

        # é…ç½®æ—¥å¿—æ–‡ä»¶
        log_file = log_dir / f"script_{task_id}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.log"

        # è®¾ç½®æ—¥å¿—æ ¼å¼
        log_format = '%(asctime)s - %(levelname)s - %(message)s'

        # æ¸…é™¤ä»»ä½•å·²æœ‰çš„æ—¥å¿—é…ç½®
        for handler in logging.root.handlers[:]:
            logging.root.removeHandler(handler)

        # é…ç½®æ—¥å¿—å¤„ç†å™¨ - ç¡®ä¿æ–‡ä»¶å†™å…¥ä¼˜å…ˆçº§å’ŒWindowså…¼å®¹æ€§
        file_handler = logging.FileHandler(str(log_file), encoding='utf-8', mode='w')
        file_handler.setLevel(logging.INFO)
        file_handler.setFormatter(logging.Formatter(log_format))
    
        # Windowså…¼å®¹æ€§ï¼šç¡®ä¿æ§åˆ¶å°è¾“å‡ºç¼–ç æ­£ç¡®
        console_handler = logging.StreamHandler(sys.stdout)
        console_handler.setLevel(logging.INFO)
        console_handler.setFormatter(logging.Formatter(log_format))
    
        # é…ç½®æ ¹æ—¥å¿—å™¨
        logging.root.setLevel(logging.INFO)
        logging.root.addHandler(file_handler)
        logging.root.addHandler(console_handler)

        # å¼ºåˆ¶åˆ·æ–°æ—¥å¿—
        logging.getLogger().handlers[0].flush()

        logging.info(f"æ—¥å¿—ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œæ—¥å¿—æ–‡ä»¶: {log_file}")
        logging.info(f"ä»»åŠ¡ID: {task_id}")
        logging.info(f"å½“å‰æ—¶é—´: {datetime.now().isoformat()}")
        logging.info(f"Pythonç‰ˆæœ¬: {sys.version}")
        logging.info(f"å·¥ä½œç›®å½•: {workspace_root}")
    
        # å¼ºåˆ¶åˆ·æ–°ç¡®ä¿åˆå§‹åŒ–æ—¥å¿—è¢«å†™å…¥
        for handler in logging.getLogger().handlers:
            handler.flush()
    
        # è¿æ¥è®¾å¤‡
        device = u2.connect()
        logging.info("âœ¨ è®¾å¤‡è¿æ¥æˆåŠŸ")
        
        # è®¾ç½®å·¥ä½œç›®å½•
        runner_dir = workspace_root / task_id / "runner"
        runner_dir.mkdir(parents=True, exist_ok=True)
        
        # åˆå§‹åŒ–å˜é‡
        action_sequence = [
        {% for step in context.action_sequence %}
        {{ step.to_dict() | to_python_dict }}{% if not loop.last %},{% endif %}
        {% endfor %}
        ]
        screenshot_count = 0
        
        logging.info(f"ä»»åŠ¡å¼€å§‹: {description}")
        logging.info(f"æ­¥éª¤æ€»æ•°: {len(action_sequence)}")
        
        # æ›´æ–°ä»»åŠ¡çŠ¶æ€
        task_status["total_steps"] = len(action_sequence)
        task_status["status"] = "æ‰§è¡Œä¸­"
        task_status["action_sequence"] = action_sequence  # ä¿å­˜åŠ¨ä½œåºåˆ—
        
        # ä¿å­˜åˆå§‹ä»»åŠ¡çŠ¶æ€
        task_status_file = runner_dir / "task_status.json"
        with open(task_status_file, 'w', encoding='utf-8') as f:
            json.dump(task_status, f, ensure_ascii=False, indent=2, default=str)
        
        # é¢„å¤„ç†ï¼šæ ‡è®°æ¯ä¸ªä»»åŠ¡çš„ç¬¬ä¸€ä¸ªæ­¥éª¤ï¼ˆä¼˜åŒ–CANé‡‡é›†å¯åŠ¨åˆ¤æ–­ï¼‰
        task_first_step_map = {}  # {task_id: first_step_index}
        for idx, step in enumerate(action_sequence):
            task_id = step.get('source_task_id')
            if task_id and task_id not in task_first_step_map:
                task_first_step_map[task_id] = idx
        
        logging.info(f"ğŸ“‹ é¢„å¤„ç†å®Œæˆï¼Œå‘ç° {len(task_first_step_map)} ä¸ªä»»åŠ¡çš„é¦–æ­¥ä¿¡æ¯")
        
        {% if context is defined and context.expected_results %}
        # åˆå§‹åŒ–é¢„æœŸç»“æœé…ç½®ï¼ˆå…¨å±€å¯ç”¨ï¼‰
        all_expected_results = {{ context.expected_results | to_python_dict }}
        {% else %}
        all_expected_results = {}
        {% endif %}
        
        # ä½¿ç”¨ main_execution_loop.j2 ä¸­å®šä¹‰çš„å®Œæ•´æ‰§è¡Œå¾ªç¯å®
        {% from 'main/main_execution_loop.j2' import execute_main_loop %}
        {{ execute_main_loop(device, runner_dir, screenshot_count, action_sequence, task_status, task_status_file, start_time, task_first_step_map, all_expected_results) }}
        
        # å¤„ç†æ‰§è¡Œç»“æœå’ŒéªŒè¯ç»“æœ
        {% from 'main/results_processing.j2' import process_results %}
        {{ process_results(action_sequence, task_status, task_status_file, start_time, runner_dir) }}
        
    except Exception as main_error:
        {% from 'main/results_processing.j2' import handle_main_error %}
        {{ handle_main_error(main_error, task_status, task_status_file, start_time, action_sequence) }}
        raise


# å…¥å£ç‚¹
if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        logging.info("ç”¨æˆ·ä¸­æ–­äº†è„šæœ¬æ‰§è¡Œ")
    except Exception as main_error:
        logging.error(f"è„šæœ¬æ‰§è¡Œå¤±è´¥: {main_error}")
        import traceback
        logging.error(traceback.format_exc()) 