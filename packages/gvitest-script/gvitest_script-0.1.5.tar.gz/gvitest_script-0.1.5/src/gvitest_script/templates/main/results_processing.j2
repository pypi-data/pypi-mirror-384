{# ç»“æœå¤„ç†æ¨¡å— - å¤„ç†ä»»åŠ¡å®Œæˆåçš„ç»“æœæ±‡æ€»å’Œä¿å­˜ #}

{% macro process_results(action_sequence, task_status, task_status_file, start_time, runner_dir) -%}
        # ==================== verify_after éªŒè¯ç»“æœæ±‡æ€» ====================
        # åªå¤„ç† verify_after éªŒè¯ç»“æœï¼Œæ²¡æœ‰æœ€ç»ˆé¢„æœŸç»“æœéªŒè¯

        verify_after_validation_results = []
        if 'verify_after_results' in globals() and verify_after_results:
            verify_after_validation_results = verify_after_results
            logging.info(f"verify_after éªŒè¯ç»“æœ: {len(verify_after_validation_results)} ä¸ª")

        if verify_after_validation_results:
            logging.info(f"{'='*20} verify_after éªŒè¯ç»“æœæ±‡æ€» {'='*20}")
            
            # ç»Ÿè®¡éªŒè¯ç»“æœ
            total_validations = len(verify_after_validation_results)
            total_passed = sum(1 for r in verify_after_validation_results if r.get('is_pass', False))
            total_failed = total_validations - total_passed
            
            # æŒ‰ä»»åŠ¡åˆ†ç»„ç»Ÿè®¡
            task_stats = {}
            for result in verify_after_validation_results:
                task_id = result.get('task_id', 'unknown')
                if task_id not in task_stats:
                    task_stats[task_id] = {'total': 0, 'passed': 0, 'failed': 0}
                task_stats[task_id]['total'] += 1
                if result.get('is_pass', False):
                    task_stats[task_id]['passed'] += 1
                else:
                    task_stats[task_id]['failed'] += 1
            
            # è¾“å‡ºè¯¦ç»†ç»Ÿè®¡
            logging.info(f"verify_after éªŒè¯æ€»è®¡: æ€»æ•°={total_validations}, é€šè¿‡={total_passed}, å¤±è´¥={total_failed}")
            
            for task_id, stats in task_stats.items():
                logging.info(f"  ä»»åŠ¡ {task_id}: æ€»æ•°={stats['total']}, é€šè¿‡={stats['passed']}, å¤±è´¥={stats['failed']}")
            
            if total_failed > 0:
                logging.warning(f"verify_after éªŒè¯æœ‰å¤±è´¥é¡¹: {total_failed} ä¸ª")
                
            # ä¿å­˜éªŒè¯ç»“æœåˆ°æ–‡ä»¶
            validation_result_file = runner_dir / "validation_results.json"
            with open(validation_result_file, "w", encoding="utf-8", newline='') as f:
                json.dump({
                    "summary": {
                        "total_validations": total_validations,
                        "total_passed": total_passed,
                        "total_failed": total_failed,
                        "success_rate": round((total_passed / total_validations * 100), 2) if total_validations > 0 else 0,
                        "task_stats": task_stats
                    },
                    "verify_after_results": verify_after_validation_results
                }, f, ensure_ascii=False, indent=2, default=str)
        else:
            logging.info("æ—  verify_after éªŒè¯æ‰§è¡Œ")

        # æ— è®ºæ˜¯å¦æœ‰éªŒè¯ç»“æœï¼Œéƒ½ç¡®ä¿åˆ›å»º validation_results.json æ–‡ä»¶
        validation_result_file = runner_dir / "validation_results.json"
        if not validation_result_file.exists():
            with open(validation_result_file, "w", encoding="utf-8", newline='') as f:
                json.dump({
                    "summary": {
                        "total_validations": 0,
                        "total_passed": 0,
                        "total_failed": 0,
                        "success_rate": 0,
                        "task_stats": {}
                    },
                    "verify_after_results": []
                }, f, ensure_ascii=False, indent=2, default=str)
            logging.info("å·²åˆ›å»ºç©ºçš„validation_results.jsonæ–‡ä»¶")

        # ä¿å­˜æ‰§è¡Œç»“æœ
        save_execution_results(action_sequence, runner_dir)

        # å®Œæˆä»»åŠ¡è¿½è¸ª
        end_time = time.time()
        total_duration = end_time - start_time
        success_status = True

        # æ›´æ–°æœ€ç»ˆä»»åŠ¡çŠ¶æ€
        task_status["status"] = "å®Œæˆ"
        task_status["end_time"] = datetime.now().isoformat()
        task_status["total_duration"] = round(total_duration, 3)
        task_status["success"] = success_status
        task_status["progress_percentage"] = 100.0
        task_status["completed_steps"] = len(action_sequence)
        task_status["successful_steps"] = sum(1 for step in action_sequence if step.get('status') == 'success')
        task_status["passed_checkpoints"] = sum(1 for step in action_sequence if step.get('checkpoint', {}).get('is_pass', False))

        # æ·»åŠ  verify_after éªŒè¯ç»“æœç»Ÿè®¡
        if 'verify_after_validation_results' in locals() and verify_after_validation_results:
            task_status["validation_summary"] = {
                "total_validations": len(verify_after_validation_results),
                "passed_validations": sum(1 for r in verify_after_validation_results if r.get('is_pass', False)),
                "failed_validations": sum(1 for r in verify_after_validation_results if not r.get('is_pass', False)),
                "validation_success_rate": round(sum(1 for r in verify_after_validation_results if r.get('is_pass', False)) / len(verify_after_validation_results) * 100, 2),
                "verify_after_count": len(verify_after_validation_results)
            }
        else:
            task_status["validation_summary"] = {
                "total_validations": 0,
                "passed_validations": 0,
                "failed_validations": 0,
                "validation_success_rate": 0,
                "verify_after_count": 0
            }
        task_status["action_sequence"] = action_sequence  # ç¡®ä¿åŠ¨ä½œåºåˆ—è¢«ä¿å­˜

        # æœ€ç»ˆæ£€æŸ¥ç‚¹ç»Ÿè®¡
        final_checkpoint_summary = task_status.get("checkpoint_summary", {})
        task_status["final_checkpoint_summary"] = {
            "total_checkpoints": final_checkpoint_summary.get("total_checkpoints", 0),
            "passed_checkpoints": final_checkpoint_summary.get("passed_checkpoints", 0),
            "failed_checkpoints": final_checkpoint_summary.get("failed_checkpoints", 0),
            "success_rate": final_checkpoint_summary.get("success_rate", 0),
            "all_checkpoints_passed": final_checkpoint_summary.get("failed_checkpoints", 0) == 0
        }

        # ä¿å­˜æœ€ç»ˆä»»åŠ¡çŠ¶æ€ 
        with open(task_status_file, 'w', encoding='utf-8', newline='') as f:
            json.dump(task_status, f, ensure_ascii=False, indent=2, default=str)

        logging.info(f"ä»»åŠ¡å®Œæˆï¼Œæ€»è€—æ—¶: {total_duration:.2f}ç§’ï¼ŒæˆåŠŸ: {success_status}")
        logging.info(f"{'='*20} ä»»åŠ¡æ‰§è¡Œå®Œæˆ {'='*20}")
{%- endmacro %}

{% macro handle_main_error(main_error, task_status, task_status_file, start_time, action_sequence) -%}
        logging.error(f"ä¸»å‡½æ•°æ‰§è¡Œå¤±è´¥: {main_error}")
        import traceback
        logging.error(traceback.format_exc())

        # å®Œæˆä»»åŠ¡è¿½è¸ª
        end_time = time.time()
        total_duration = end_time - start_time
        success_status = False

        # æ›´æ–°å¤±è´¥ä»»åŠ¡çŠ¶æ€
        try:
            task_status["status"] = "å¤±è´¥"
            task_status["end_time"] = datetime.now().isoformat()
            task_status["total_duration"] = round(total_duration, 3)
            task_status["success"] = success_status
            task_status["error_message"] = str(main_error)
            task_status["action_sequence"] = action_sequence  # ç¡®ä¿åŠ¨ä½œåºåˆ—è¢«ä¿å­˜
            
            # ä¿å­˜å¤±è´¥ä»»åŠ¡çŠ¶æ€ 
            with open(task_status_file, 'w', encoding='utf-8', newline='') as f:
                json.dump(task_status, f, ensure_ascii=False, indent=2, default=str)
        except Exception as status_error:
            logging.error(f"ä¿å­˜å¤±è´¥ä»»åŠ¡çŠ¶æ€æ—¶å‡ºé”™: {status_error}")

        logging.info(f"ä»»åŠ¡å®Œæˆï¼Œæ€»è€—æ—¶: {total_duration:.2f}ç§’ï¼ŒæˆåŠŸ: {success_status}")
{%- endmacro %}

def save_execution_results(action_sequence, runner_dir):
    """ä¿å­˜æ‰§è¡Œç»“æœåˆ°æ–‡ä»¶ï¼Œä¿æŒæ§åˆ¶æµç»“æ„å®Œæ•´æ€§"""
    try:
        results_file = runner_dir / "execution_results.json"
        
        # ğŸ¯ ä¿æŒåŸæœ‰ç»“æ„ï¼Œä¸å±•å¼€æ§åˆ¶æµæ­¥éª¤
        # ç»Ÿè®¡æ—¶éœ€è¦è€ƒè™‘æ§åˆ¶æµçš„å­æ­¥éª¤æ•°é‡
        total_actual_steps = 0
        successful_actual_steps = 0
        passed_actual_checkpoints = 0
        
        for step in action_sequence:
            if step.get('step_type') == 'control_flow':
                execution_result = step.get('execution_result', {})
                executed_sub_steps = execution_result.get('executed_sub_steps', [])
                
                if executed_sub_steps:
                    # æ§åˆ¶æµæœ‰å­æ­¥éª¤ï¼Œç»Ÿè®¡å­æ­¥éª¤
                    total_actual_steps += len(executed_sub_steps)
                    successful_actual_steps += sum(1 for sub_step in executed_sub_steps if sub_step.get('status') == 'success')
                    passed_actual_checkpoints += sum(1 for sub_step in executed_sub_steps if sub_step.get('checkpoint', {}).get('is_pass', False))
                    logging.info(f"æ§åˆ¶æµæ­¥éª¤ {step.get('step_name', '')} åŒ…å« {len(executed_sub_steps)} ä¸ªå·²æ‰§è¡Œçš„å­æ­¥éª¤")
                else:
                    # æ§åˆ¶æµæ²¡æœ‰å­æ­¥éª¤ï¼Œç»Ÿè®¡æ§åˆ¶æµæœ¬èº«
                    total_actual_steps += 1
                    successful_actual_steps += 1 if step.get('status') == 'success' else 0
                    passed_actual_checkpoints += 1 if step.get('checkpoint', {}).get('is_pass', False) else 0
                    logging.warning(f"æ§åˆ¶æµæ­¥éª¤ {step.get('step_name', '')} æ²¡æœ‰æ‰¾åˆ°å·²æ‰§è¡Œçš„å­æ­¥éª¤è®°å½•")
            else:
                # æ™®é€šæ­¥éª¤ï¼Œç›´æ¥ç»Ÿè®¡
                total_actual_steps += 1
                successful_actual_steps += 1 if step.get('status') == 'success' else 0
                passed_actual_checkpoints += 1 if step.get('checkpoint', {}).get('is_pass', False) else 0
        
        # å‡†å¤‡ç»“æœæ•°æ®
        results_data = {
            "task_execution": {
                "total_steps": total_actual_steps,
                "successful_steps": successful_actual_steps,
                "passed_checkpoints": passed_actual_checkpoints,
                "execution_time": datetime.now().isoformat()
            },
            "step_results": []
        }
        
        # æ”¶é›†æ­¥éª¤ç»“æœï¼ˆä¿æŒåŸæœ‰ç»“æ„ï¼‰
        for step in action_sequence:
            checkpoint_info = step.get('checkpoint', {})
            
            # ğŸ¯ æ ‡å‡†åŒ–ç©ºcheckpointï¼šç¡®ä¿ç©ºé…ç½®æ—¶è¿”å›æ ‡å‡†çš„noneç±»å‹ç»“æ„
            if not checkpoint_info or checkpoint_info == {}:
                # ç©ºcheckpointé…ç½®ï¼Œè®¾ç½®æ ‡å‡†çš„noneç±»å‹ç»“æ„
                standardized_checkpoint = {
                    "type": "none",
                    "description": "",
                    "screenshot_path": None,
                    "is_pass": None,
                    "detail": "",
                    "similarity_score": None,
                    "status": "å¾…æ‰§è¡Œ",
                    "execution_time": None,
                    "executed_at": None,
                    "error_message": None
                }
            else:
                # æœ‰checkpointé…ç½®ï¼Œä½¿ç”¨å®é™…å€¼
                standardized_checkpoint = {
                    "type": checkpoint_info.get('type', 'none'),
                    "description": checkpoint_info.get('description', ''),
                    "screenshot_path": checkpoint_info.get('screenshot_path'),
                    "is_pass": checkpoint_info.get('is_pass'),
                    "detail": checkpoint_info.get('detail', ''),
                    "similarity_score": checkpoint_info.get('similarity_score'),
                    "status": checkpoint_info.get('status', 'å¾…æ‰§è¡Œ'),
                    "execution_time": checkpoint_info.get('execution_time'),
                    "executed_at": checkpoint_info.get('executed_at'),
                    "error_message": checkpoint_info.get('error_message')
                }
            
            step_result = {
                "step_number": step.get('step_number'),
                "step_name": step.get('step_name'),
                "operation_type": step.get('operation_type'),
                "success": (step.get('status') == 'success'),
                "checkpoint": standardized_checkpoint
            }
            
            # æ§åˆ¶æµå­—æ®µå·²ä»æºå¤´ç§»é™¤ï¼Œä¸å†éœ€è¦å¤„ç†
                
            results_data["step_results"].append(step_result)
        
        # ä¿å­˜åˆ°æ–‡ä»¶ 
        with open(results_file, 'w', encoding='utf-8', newline='') as f:
            json.dump(results_data, f, ensure_ascii=False, indent=2, default=str)
            
            logging.info(f"æ‰§è¡Œç»“æœå·²ä¿å­˜åˆ°: {results_file} (åŒ…å« {total_actual_steps} ä¸ªå®é™…æ‰§è¡Œæ­¥éª¤)")
        
    except Exception as e:
        logging.error(f"ä¿å­˜æ‰§è¡Œç»“æœå¤±è´¥: {e}")
