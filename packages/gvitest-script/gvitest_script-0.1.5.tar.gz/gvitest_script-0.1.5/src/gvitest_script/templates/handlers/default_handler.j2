{# é»˜è®¤åŠ¨ä½œå¤„ç†å™¨æ¨¡æ¿ - ç”¨äºå¤„ç†æœªæ˜ç¡®å®šä¹‰çš„æ“ä½œç±»å‹ #}
{# é€‚ç”¨äºï¼šæœªçŸ¥æˆ–ä¸å¸¸ç”¨çš„æ“ä½œç±»å‹ #}

# ==================== é»˜è®¤åŠ¨ä½œå¤„ç†å™¨ ====================
def handle_default_action(step_data, device, runner_dir, screenshot_count, previous_after_screenshot=None):
    """
    å¤„ç†é»˜è®¤åŠ¨ä½œ - ç”¨äºå¤„ç†æœªæ˜ç¡®å®šä¹‰çš„æ“ä½œç±»å‹
    
    Args:
        step_data: æ­¥éª¤ä¸Šä¸‹æ–‡å¯¹è±¡
        device: uiautomator2è®¾å¤‡å¯¹è±¡
        runner_dir: è¿è¡Œç›®å½•è·¯å¾„
        screenshot_count: æˆªå›¾è®¡æ•°
        previous_after_screenshot: å‰ä¸€æ­¥çš„æ‰§è¡Œåæˆªå›¾è·¯å¾„ï¼Œç”¨äºä¼˜åŒ–æˆªå›¾æ€§èƒ½
    
    Returns:
        Dict: æ‰§è¡Œç»“æœ
    """
    
    step_number = step_data.get('step_number', 0)
    step_name = step_data.get('step_name', 'æœªçŸ¥æ­¥éª¤')
    operation_type = step_data.get('operation_type', 'unknown')
    
    logging.info(f"æ­¥éª¤ {step_number}: æ‰§è¡Œé»˜è®¤å¤„ç†å™¨ - {operation_type}")

    # æ‰§è¡Œå‰æ— éœ€ç­‰å¾…UIç¨³å®šï¼Œç›´æ¥è¿›è¡Œæ“ä½œ

    # ä¼˜åŒ–æˆªå›¾é€»è¾‘ï¼šå¦‚æœæœ‰å‰ä¸€æ­¥çš„æˆªå›¾ï¼Œå°±å¤ç”¨å®ƒ
    if previous_after_screenshot:
        # ä½¿ç”¨å‰ä¸€æ­¥çš„åæˆªå›¾ä½œä¸ºå½“å‰æ­¥éª¤çš„å‰æˆªå›¾ï¼Œé¿å…é‡å¤æˆªå›¾
        before_execution_screenshot_path = previous_after_screenshot
        logging.info(f"ğŸ“¸ å¤ç”¨å‰ä¸€æ­¥æˆªå›¾ä½œä¸ºæ‰§è¡Œå‰æˆªå›¾: {before_execution_screenshot_path}")
    else:
        # ç¬¬ä¸€æ­¥æˆ–æ²¡æœ‰å‰ä¸€æ­¥æˆªå›¾æ—¶ï¼Œéœ€è¦æ–°æˆªå›¾
        before_execution_screenshot_path = take_screenshot_and_save(
            device, runner_dir, f"before_step{step_number}", "æ‰§è¡Œå‰æˆªå›¾ - ç”¨äºé»˜è®¤æ“ä½œè®°å½•"
        )
    step_data['before_execution_screenshot_path'] = before_execution_screenshot_path
    logging.info(f"æ‰§è¡Œå‰æˆªå›¾å·²ä¿å­˜: {before_execution_screenshot_path}")

    # é»˜è®¤å¤„ç†é€»è¾‘
    try:
        logging.info(f"æ‰§è¡Œé»˜è®¤æ“ä½œå¤„ç†: {operation_type}")
        
        # è·å–å…ƒç´ ä¿¡æ¯
        element_info = step_data.get('element_info', {})
        
        # æ ¹æ®æ“ä½œç±»å‹è¿›è¡ŒåŸºæœ¬å¤„ç†
        if operation_type.lower() == 'wait':
            # ç­‰å¾…æ“ä½œ
            wait_seconds = element_info.get('seconds', 1)
            time.sleep(wait_seconds)
            logging.info(f"â±ï¸ ç­‰å¾…æ“ä½œå®Œæˆ: {step_name} ç­‰å¾…äº† {wait_seconds} ç§’")
            checkpoint_result = {
                "is_pass": True,
                "detail": f"ç­‰å¾…æ“ä½œæˆåŠŸ: ç­‰å¾…äº† {wait_seconds} ç§’"
            }
        
        elif operation_type.lower() == 'key':
            # æŒ‰é”®æ“ä½œ
            key_code = element_info.get('key', 'BACK')
            device.press(key_code)
            logging.info(f"ğŸ”˜ æŒ‰é”®æ“ä½œå®Œæˆ: {step_name} æŒ‰ä¸‹äº† {key_code} é”®")
            checkpoint_result = {
                "is_pass": True,
                "detail": f"æŒ‰é”®æ“ä½œæˆåŠŸ: æŒ‰ä¸‹äº† {key_code} é”®"
            }
        
        elif operation_type.lower() in ['app', 'start_app', 'stop_app']:
            # åº”ç”¨æ“ä½œ
            app_package = element_info.get('app_package', '')
            
            if app_package:
                if operation_type.lower() in ['app', 'start_app']:
                    device.app_start(app_package, stop=True)
                    logging.info(f"ğŸš€ åº”ç”¨å¯åŠ¨å®Œæˆ: {app_package}")
                    checkpoint_result = {
                        "is_pass": True,
                        "detail": f"åº”ç”¨å¯åŠ¨æˆåŠŸ: {app_package}"
                    }
                elif operation_type.lower() == 'stop_app':
                    device.app_stop(app_package)
                    logging.info(f"ğŸ‘‹ åº”ç”¨åœæ­¢å®Œæˆ: {app_package}")
                    checkpoint_result = {
                        "is_pass": True,
                        "detail": f"åº”ç”¨åœæ­¢æˆåŠŸ: {app_package}"
                    }
                else:
                    logging.error(f"â— æœªçŸ¥åº”ç”¨æ“ä½œ: {operation_type}")
                    checkpoint_result = {
                        "is_pass": False,
                        "detail": f"æœªçŸ¥åº”ç”¨æ“ä½œ: {operation_type}"
                    }
            else:
                logging.error("â— åº”ç”¨æ“ä½œå¤±è´¥: ç¼ºå°‘åº”ç”¨åŒ…å")
                checkpoint_result = {
                    "is_pass": False,
                    "detail": "åº”ç”¨æ“ä½œå¤±è´¥: ç¼ºå°‘åº”ç”¨åŒ…å"
                }
        
        elif operation_type.lower() == 'kill_all':
            # æ€æ­»æ‰€æœ‰åº”ç”¨æ“ä½œ
            logging.info('æ‰§è¡Œæ€æ­»æ‰€æœ‰åº”ç”¨æ“ä½œ')
            try:
                device.app_stop_all()
                logging.info(f'ğŸ’€ æ€æ­»æ‰€æœ‰åº”ç”¨å®Œæˆ: {step_name}')
                checkpoint_result = {
                    "is_pass": True,
                    "detail": "æ€æ­»æ‰€æœ‰åº”ç”¨æˆåŠŸ"
                }
            except Exception as kill_error:
                logging.error(f'æ€æ­»æ‰€æœ‰åº”ç”¨æ—¶å‡ºé”™: {kill_error}')
                checkpoint_result = {
                    "is_pass": False,
                    "detail": f"æ€æ­»æ‰€æœ‰åº”ç”¨å¤±è´¥: {str(kill_error)}"
                }
        
        elif operation_type.lower() in ['black_open', 'black_close', 'flower_open', 'flower_close', 
                                       'lag_open', 'lag_close', 'flash_open', 'flash_close']:
            # æ‘„åƒå¤´æ£€æµ‹æ“ä½œ
            from datetime import datetime
            
            # è·å–å½“å‰æ—¶é—´
            current_time = datetime.now()
            time_str = current_time.isoformat()
            
            logging.info(f'æ‰§è¡Œæ‘„åƒå¤´æ“ä½œ: {operation_type} åœ¨ {time_str}')
            
            # è®°å½•æ‘„åƒå¤´æ“ä½œæ—¶é—´åˆ°æ–‡ä»¶
            camera_log_file = os.path.join(runner_dir, 'camera_operations.json')
            
            # è§£ææ“ä½œç±»å‹å’ŒåŠ¨ä½œ
            if '_' in operation_type:
                camera_type, action = operation_type.split('_', 1)
            else:
                camera_type = operation_type
                action = 'unknown'
            
            # å‡†å¤‡æ‘„åƒå¤´æ“ä½œè®°å½•
            camera_record = {
                "type": camera_type,
                "action": action,
                "timestamp": time_str,
                "step_group_id": step_data.get('step_group_id', ''),
                "step_number": step_data.get('step_number', 0),
                "step_name": step_name
            }
            
            # è¯»å–æˆ–åˆ›å»ºæ‘„åƒå¤´æ“ä½œè®°å½•æ–‡ä»¶
            camera_operations = []
            if os.path.exists(camera_log_file):
                try:
                    with open(camera_log_file, 'r', encoding='utf-8') as f:
                        camera_operations = json.load(f)
                except Exception as e:
                    logging.warning(f'è¯»å–æ‘„åƒå¤´æ“ä½œè®°å½•å¤±è´¥: {e}')
            
            # æ·»åŠ æ–°è®°å½•
            camera_operations.append(camera_record)
            
            # ä¿å­˜æ‘„åƒå¤´æ“ä½œè®°å½• 
            try:
                with open(camera_log_file, 'w', encoding='utf-8', newline='') as f:
                    json.dump(camera_operations, f, ensure_ascii=False, indent=2)
                logging.info(f'æ‘„åƒå¤´æ“ä½œè®°å½•å·²ä¿å­˜: {camera_record}')
            except Exception as e:
                logging.error(f'ä¿å­˜æ‘„åƒå¤´æ“ä½œè®°å½•å¤±è´¥: {e}')
            
            checkpoint_result = {
                "is_pass": True,
                "detail": f"æ‘„åƒå¤´æ“ä½œæˆåŠŸ: {operation_type} æ‰§è¡Œæ—¶é—´: {time_str}"
            }
        
        else:
            # æœªçŸ¥æ“ä½œç±»å‹
            logging.warning(f"â— æœªçŸ¥æ“ä½œç±»å‹: {operation_type}")
            checkpoint_result = {
                "is_pass": False,
                "detail": f"æœªçŸ¥æ“ä½œç±»å‹: {operation_type}ï¼Œéœ€è¦å®ç°å¯¹åº”çš„å¤„ç†å™¨"
            }
        
    except Exception as default_err:
        logging.error(f"é»˜è®¤å¤„ç†å™¨æ‰§è¡Œå‡ºé”™: {default_err}")
        checkpoint_result = {
            "is_pass": False,
            "detail": f"é»˜è®¤å¤„ç†å™¨æ‰§è¡Œå‡ºé”™: {default_err}"
        }

    # è·å–æ‰§è¡Œç»“æœ
    is_pass = checkpoint_result.get("is_pass")
    detail = checkpoint_result.get("detail")

    # ç­‰å¾…UIç¨³å®šåè¿›è¡Œæ‰§è¡Œåæˆªå›¾
    logging.info("ç­‰å¾…åŠ¨ä½œæ‰§è¡Œå®ŒæˆåUIç¨³å®š...")
    ui_stable = wait_for_ui_stability(device, timeout=1.0)
    if not ui_stable:
        logging.warning("æ‰§è¡ŒåUIç¨³å®šæ£€æŸ¥è¶…æ—¶ï¼Œç»§ç»­æˆªå›¾")

    # æ‰§è¡Œåæˆªå›¾ï¼ˆç”¨äºå“åº”éªŒè¯ï¼‰
    step_number = step_data.get('step_number', 0)
    after_execution_screenshot_path = take_screenshot_and_save(
        device, runner_dir, f"after_step{step_number}", "æ‰§è¡Œåæˆªå›¾ - ç”¨äºéªŒè¯é»˜è®¤æ“ä½œç»“æœ"
    )
    step_data['after_execution_screenshot_path'] = after_execution_screenshot_path

    logging.info(f"{'âœ…' if is_pass else 'âŒ'} é»˜è®¤å¤„ç†å™¨å®Œæˆ: {detail}")
    
    return {
        "status": "success" if is_pass else "failed",
        "message": detail,
        "screenshots": {
            "before_execution": step_data.get('before_execution_screenshot_path'),
            "after_execution": after_execution_screenshot_path
        },

    } 