{# ç‚¹å‡»åŠ¨ä½œå¤„ç†æ¨¡æ¿ - ä¸“æ³¨äºæ“ä½œæ‰§è¡Œ #}

{# ç‚¹å‡»åŠ¨ä½œå¤„ç†å‡½æ•° #}
def handle_click_action(step_data, device, runner_dir, screenshot_count, previous_after_screenshot=None):
    """
    å¤„ç†ç‚¹å‡»åŠ¨ä½œ - ä¸“æ³¨äºæ“ä½œæ‰§è¡Œ
    
    Args:
        step_data: æ­¥éª¤ä¸Šä¸‹æ–‡å¯¹è±¡
        device: uiautomator2è®¾å¤‡å¯¹è±¡
        runner_dir: è¿è¡Œç›®å½•è·¯å¾„
        screenshot_count: æˆªå›¾è®¡æ•°
        previous_after_screenshot: å‰ä¸€æ­¥çš„æ‰§è¡Œåæˆªå›¾è·¯å¾„ï¼Œç”¨äºä¼˜åŒ–æˆªå›¾æ€§èƒ½
    
    Returns:
        Dict: æ‰§è¡Œç»“æœ
    """
    
    logging.info("å¼€å§‹æ‰§è¡Œæ­¥éª¤ %s: %s" % (step_data.get('step_number', 0), step_data.get('step_name', 'æœªçŸ¥æ­¥éª¤')))

    step_name = step_data.get('step_name', 'ç‚¹å‡»æ“ä½œ')
    operation_type = step_data.get('operation_type', 'click')
    # å…¼å®¹ä¸¤ç§æ•°æ®ç»“æ„ï¼šç›´æ¥åœ¨æ ¹çº§åˆ«çš„element_infoå’Œåœ¨parametersä¸­çš„element_info
    element_info = step_data.get('element_info', {}) or step_data.get('parameters', {}).get('element_info', {})
    
    # è·å–é‡è¯•é…ç½®
    max_retries = element_info.get('max_retries', 3)
    retry_interval = element_info.get('retry_interval', 1.0)
    
    logging.info(f"å¼€å§‹æ‰§è¡Œ{operation_type}æ“ä½œ: {step_name} (æœ€å¤§é‡è¯•: {max_retries}æ¬¡)")
    
    # åˆå§‹åŒ–æ‰§è¡ŒçŠ¶æ€ï¼ˆéä¸šåŠ¡éªŒè¯ï¼‰
    execution_success = False
    final_coordinates = None
    coordinate_method = "æœªå®šä½"
    
    # é‡è¯•å¾ªç¯
    for retry_count in range(max_retries):
        try:
            if retry_count > 0:
                logging.info(f"ç¬¬{retry_count + 1}æ¬¡å°è¯•æ‰§è¡Œ{operation_type}æ“ä½œ...")
                time.sleep(retry_interval)
            
            # æ‰§è¡Œå‰æ— éœ€ç­‰å¾…UIç¨³å®šï¼Œç›´æ¥è¿›è¡Œæ“ä½œ
            
            # ä¼˜åŒ–æˆªå›¾é€»è¾‘ï¼šå¦‚æœæœ‰å‰ä¸€æ­¥çš„æˆªå›¾ï¼Œå°±å¤ç”¨å®ƒ
            step_number = step_data.get('step_number', 0)
            
            if previous_after_screenshot:
                # ä½¿ç”¨å‰ä¸€æ­¥çš„åæˆªå›¾ä½œä¸ºå½“å‰æ­¥éª¤çš„å‰æˆªå›¾ï¼Œé¿å…é‡å¤æˆªå›¾
                before_execution_screenshot_path = previous_after_screenshot
                logging.info(f"ğŸ“¸ å¤ç”¨å‰ä¸€æ­¥æˆªå›¾ä½œä¸ºæ‰§è¡Œå‰æˆªå›¾: {before_execution_screenshot_path}")
            else:
                # ç¬¬ä¸€æ­¥æˆ–æ²¡æœ‰å‰ä¸€æ­¥æˆªå›¾æ—¶ï¼Œéœ€è¦æ–°æˆªå›¾
                before_execution_screenshot_path = take_screenshot_and_save(
                    device, runner_dir, f"before_step{step_number}", "æ‰§è¡Œå‰æˆªå›¾ - ç”¨äºåæ ‡å®šä½å’Œè®°å½•"
                )
            
            # æ›´æ–°æ­¥éª¤æ‰§è¡Œå‰æˆªå›¾ä¿¡æ¯
            step_data['before_execution_screenshot_path'] = before_execution_screenshot_path
            
            # è·å–åæ ‡ä¿¡æ¯
            target_x = element_info.get('start_x')
            target_y = element_info.get('start_y') 
            width = element_info.get('width', 0)
            height = element_info.get('height', 0)
            

            
            # æ™ºèƒ½åæ ‡å®šä½
            coordinate_found = False
            final_x, final_y = target_x, target_y
            
            # æ£€æŸ¥æ˜¯å¦æœ‰å›¾åƒå®šä½ä¿¡æ¯
            icon_path = element_info.get('icon_path')
            # è·å–å½•åˆ¶æ—¶çš„æˆªå›¾è·¯å¾„ï¼ˆåº”è¯¥ä¿æŒåŸå§‹å€¼ï¼Œä¸è¢«æ‰§è¡Œæ—¶æˆªå›¾è¦†ç›–ï¼‰
            reference_screenshot_path = step_data.get('screenshot_path')  # å½•åˆ¶æ—¶çš„æˆªå›¾è·¯å¾„
            bbox = element_info.get('bbox', [])
            # ä½¿ç”¨åˆšæ‹æ‘„çš„æ‰§è¡Œå‰æˆªå›¾è¿›è¡Œæ£€æµ‹
        
            if icon_path and reference_screenshot_path and before_execution_screenshot_path and bbox and len(bbox) == 4:
                logging.info("å°è¯•æ™ºèƒ½å›¾åƒå®šä½...")
                try:
                    # è§£æbboxå­—ç¬¦ä¸²ï¼ˆå¦‚æœæ˜¯å­—ç¬¦ä¸²æ ¼å¼ï¼‰
                    if isinstance(bbox, str):
                        bbox = [float(x) for x in bbox.split(',')]
                    
                    # ä½¿ç”¨æ™ºèƒ½å®šä½å‡½æ•°
                    found_coords = locate_small_via_dynamic_medium(
                        reference_image_data=reference_screenshot_path,
                        target_image_data=icon_path,
                        target_bbox=bbox,
                        detect_image_data=before_execution_screenshot_path
                    )
                    
                    if found_coords:
                        x1, y1, x2, y2 = found_coords
                        final_x = (x1 + x2) / 2
                        final_y = (y1 + y2) / 2
                        coordinate_found = True
                        coordinate_method = "æ™ºèƒ½å®šä½"
                        logging.info(f"æ™ºèƒ½å®šä½æˆåŠŸ: ({final_x:.1f}, {final_y:.1f})")
                    else:
                        logging.warning("æ™ºèƒ½å®šä½å¤±è´¥ï¼Œä½¿ç”¨é¢„è®¾åæ ‡")
                        if retry_count < max_retries - 1:
                            continue  # é‡è¯•
                        coordinate_method = "é¢„è®¾åæ ‡(æ™ºèƒ½å®šä½å¤±è´¥)"
                        
                except Exception as locate_error:
                    logging.error(f"æ™ºèƒ½å®šä½å¼‚å¸¸: {locate_error}")
                    if retry_count < max_retries - 1:
                        continue  # é‡è¯•
                    coordinate_method = f"é¢„è®¾åæ ‡(å®šä½å¼‚å¸¸: {locate_error})"
            else:
                # ç¼ºå°‘å¿…è¦çš„å®šä½ä¿¡æ¯
                missing_info = []
                if not icon_path:
                    missing_info.append("icon_path")
                if not reference_screenshot_path:
                    missing_info.append("screenshot_path") 
                if not before_execution_screenshot_path:
                    missing_info.append("before_execution_screenshot_path")
                if not bbox or len(bbox) != 4:
                    missing_info.append("bbox")
                
                logging.info(f"è·³è¿‡æ™ºèƒ½å®šä½ï¼Œç¼ºå°‘: {', '.join(missing_info)}")
                coordinate_method = "é¢„è®¾åæ ‡(ç¼ºå°‘å®šä½ä¿¡æ¯)"
            
            # éªŒè¯åæ ‡æœ‰æ•ˆæ€§
            if final_x is None or final_y is None:
                # å°è¯•ä»bboxè®¡ç®—ä¸­å¿ƒç‚¹
                if bbox and len(bbox) >= 4:
                    x1, y1, x2, y2 = bbox[:4]
                    final_x = (x1 + x2) / 2
                    final_y = (y1 + y2) / 2
                    coordinate_method = "bboxè®¡ç®—"
                    logging.info(f"ä»bboxè®¡ç®—åæ ‡: ({final_x}, {final_y})")
                else:
                    if retry_count < max_retries - 1:
                        logging.warning("æ— æœ‰æ•ˆåæ ‡ï¼Œå‡†å¤‡é‡è¯•...")
                        continue
                    error_msg = "æ— æœ‰æ•ˆåæ ‡è¿›è¡Œç‚¹å‡»æ“ä½œ"
                    logging.error(error_msg)
                    
                    logging.error("æ­¥éª¤ %s æ‰§è¡Œé”™è¯¯: %s, é”™è¯¯: %s" % (step_data.get('step_number', 0), step_data.get('step_name', 'æœªçŸ¥æ­¥éª¤'), error_msg))
                    
                    return {
                        "status": "failed", 
                        "message": error_msg,
                        "screenshots": {
                            "before_execution": before_execution_screenshot_path,
                            "after_execution": None
                        }
                    }
            
            # åŸºæœ¬åæ ‡èŒƒå›´éªŒè¯
            if not is_coordinates_valid(final_x, final_y, device):
                if retry_count < max_retries - 1:
                    logging.warning("åæ ‡è¶…å‡ºæœ‰æ•ˆèŒƒå›´ï¼Œå‡†å¤‡é‡è¯•...")
                    continue
                else:
                    error_msg = "åæ ‡è¶…å‡ºæœ‰æ•ˆèŒƒå›´: (" + str(final_x) + ", " + str(final_y) + ")"
                    logging.error(error_msg)
                    
                    # å®æ—¶çŠ¶æ€æ›´æ–°ï¼šé”™è¯¯å¤„ç†
    
                    
                    logging.error("æ­¥éª¤ %s æ‰§è¡Œé”™è¯¯: %s, é”™è¯¯: %s" % (step_data.get('step_number', 0), step_data.get('step_name', 'æœªçŸ¥æ­¥éª¤'), error_msg))
                    
                    return {
                        "status": "failed", 
                        "message": error_msg,
                        "screenshots": {
                            "before_execution": before_execution_screenshot_path,
                            "after_execution": None
                        },
                        "checkpoint_context": {
                            "operation_completed": False,
                            "operation_mode": step_data.get('mode', 'manual'),
                            "error_occurred": True,
                            "error_message": error_msg,
                            "locating_success": False,
                            "coordinate_method": coordinate_method
                        }
                    }
            

            
            # æ‰§è¡Œç‚¹å‡»æ“ä½œ
            logging.info("æ‰§è¡Œ" + operation_type + "æ“ä½œï¼Œåæ ‡: (" + str(final_x) + ", " + str(final_y) + ")")
            
            # æ ¹æ®æ“ä½œç±»å‹æ‰§è¡Œç›¸åº”çš„ç‚¹å‡»æ“ä½œ
            if operation_type == 'click':
                device.click(final_x, final_y)
            elif operation_type == 'long_click':
                duration = element_info.get('duration', 1.0)
                device.long_click(final_x, final_y, duration=duration)
            elif operation_type == 'double_click':
                device.double_click(final_x, final_y)
            else:
                # é»˜è®¤ä¸ºæ™®é€šç‚¹å‡»
                device.click(final_x, final_y)
            
            # ç­‰å¾…æ“ä½œå®Œæˆ
            time.sleep(0.5)
            
            # ç­‰å¾…UIç¨³å®šåè¿›è¡Œæ‰§è¡Œåæˆªå›¾
            logging.info("ç­‰å¾…åŠ¨ä½œæ‰§è¡Œå®ŒæˆåUIç¨³å®š...")
            ui_stable = wait_for_ui_stability(device, timeout=1.0)
            if not ui_stable:
                logging.warning("æ‰§è¡ŒåUIç¨³å®šæ£€æŸ¥è¶…æ—¶ï¼Œç»§ç»­æˆªå›¾")
            
            # æ‰§è¡Œåæˆªå›¾ï¼ˆç”¨äºå“åº”éªŒè¯ï¼‰
            after_execution_screenshot_path = take_screenshot_and_save(
                device, runner_dir, f"after_step{step_number}", "æ‰§è¡Œåæˆªå›¾ - ç”¨äºéªŒè¯æ“ä½œç»“æœ"
            )
            step_data['after_execution_screenshot_path'] = after_execution_screenshot_path
            
            # è®°å½•æ‰§è¡ŒæˆåŠŸ
            execution_success = True
            final_coordinates = (final_x, final_y)
            
            # ç®€åŒ–çš„æ‰§è¡ŒçŠ¶æ€è®°å½•ï¼ˆéä¸šåŠ¡éªŒè¯ï¼‰
            retry_info = " (ç¬¬" + str(retry_count + 1) + "æ¬¡å°è¯•)" if retry_count > 0 else ""
            execution_detail = operation_type + "æ“ä½œæ‰§è¡Œå®Œæˆï¼Œåæ ‡: (" + str(round(final_x, 1)) + ", " + str(round(final_y, 1)) + "), æ–¹æ³•: " + coordinate_method + retry_info
            
            logging.info("æ­¥éª¤ %s å®Œæˆ: %s, æˆåŠŸ: %s" % (step_data.get('step_number', 0), step_data.get('step_name', 'æœªçŸ¥æ­¥éª¤'), True))
            
            success_message = "âœ… " + operation_type + "æ“ä½œæ‰§è¡Œå®Œæˆ: " + step_name
            if retry_count > 0:
                success_message += " (ç¬¬" + str(retry_count + 1) + "æ¬¡å°è¯•æˆåŠŸ)"
            logging.info(success_message)
            
            return {
                "status": "success",
                "message": operation_type + "æ“ä½œæ‰§è¡ŒæˆåŠŸ",
                "coordinates": final_coordinates,
                "coordinate_method": coordinate_method,
                "retry_count": retry_count,
                "total_attempts": retry_count + 1,
                "execution_detail": execution_detail,
                "screenshots": {
                    "before_execution": before_execution_screenshot_path,
                    "after_execution": after_execution_screenshot_path
                },

            }
            
        except Exception as e:
            error_msg = operation_type + "æ“ä½œæ‰§è¡Œå¤±è´¥: " + str(e)
            
            if retry_count < max_retries - 1:
                logging.warning(error_msg + "ï¼Œå‡†å¤‡ç¬¬" + str(retry_count + 2) + "æ¬¡å°è¯•...")
                continue
            else:
                logging.error(error_msg + " (å·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°)")
                
                # ç¡®ä¿æœ‰æˆªå›¾è®°å½•é”™è¯¯çŠ¶æ€
                if not step_data.get('before_execution_screenshot_path'):
                    try:
                        error_screenshot_path = take_screenshot_and_save(
                            device, runner_dir, f"error_{operation_type}", "é”™è¯¯æˆªå›¾ - è®°å½•æ“ä½œå¤±è´¥æ—¶çš„ç•Œé¢çŠ¶æ€"
                        )
                        step_data['before_execution_screenshot_path'] = error_screenshot_path
                    except Exception as screenshot_error:
                        logging.error(f"é”™è¯¯æˆªå›¾å¤±è´¥: {screenshot_error}")
                
                logging.error("æ­¥éª¤ %s æ‰§è¡Œé”™è¯¯: %s, é”™è¯¯: %s" % (step_data.get('step_number', 0), step_data.get('step_name', 'æœªçŸ¥æ­¥éª¤'), error_msg))
                
                return {
                    "status": "failed", 
                    "message": error_msg + " (é‡è¯•" + str(max_retries) + "æ¬¡åå¤±è´¥)",
                    "coordinates": final_coordinates,
                    "retry_count": retry_count,
                    "total_attempts": retry_count + 1,
                    "screenshots": {
                        "before_execution": step_data.get('before_execution_screenshot_path'),
                        "after_execution": None
                    }
                }
    
    # å¦‚æœæ‰€æœ‰é‡è¯•éƒ½å¤±è´¥äº†
    final_error = operation_type + "æ“ä½œé‡è¯•" + str(max_retries) + "æ¬¡åä»å¤±è´¥"
    logging.error(final_error)
    
    logging.error("æ­¥éª¤ %s æ‰§è¡Œé”™è¯¯: %s, é”™è¯¯: %s" % (step_data.get('step_number', 0), step_data.get('step_name', 'æœªçŸ¥æ­¥éª¤'), final_error))
    
    return {
        "status": "failed",
        "message": final_error,
        "retry_count": max_retries - 1,
        "total_attempts": max_retries,
        "screenshots": {
            "before_execution": step_data.get('before_execution_screenshot_path'),
            "after_execution": None
        }
    }


def is_coordinates_valid(target_x, target_y, device):
    """
    æ£€æŸ¥åæ ‡æ˜¯å¦åœ¨æœ‰æ•ˆèŒƒå›´å†…ï¼ˆç®€åŒ–ç‰ˆï¼‰
    
    Args:
        target_x: ç›®æ ‡Xåæ ‡
        target_y: ç›®æ ‡Yåæ ‡
        device: è®¾å¤‡å¯¹è±¡
    
    Returns:
        bool: åæ ‡æ˜¯å¦æœ‰æ•ˆ
    """
    if target_x is None or target_y is None:
        return False
    
    try:
        # è·å–è®¾å¤‡ä¿¡æ¯éªŒè¯åæ ‡èŒƒå›´
        device_info = get_device_info(device)
        screen_width = device_info.get('display_width', 1920)
        screen_height = device_info.get('display_height', 1080)
        
        return (0 <= target_x <= screen_width and 0 <= target_y <= screen_height)
        
    except Exception as e:
        logging.warning(f"åæ ‡éªŒè¯å¼‚å¸¸: {e}")
        return True  # å¼‚å¸¸æ—¶å‡è®¾åæ ‡æœ‰æ•ˆ 