import numpy.testing as npt
import pytest

import pynbody
import pynbody.test_utils


@pytest.fixture(scope='module', autouse=True)
def get_data():
    pynbody.test_utils.ensure_test_data_available("gasoline_ahf")


@pytest.fixture(scope='module')
def snap_and_halos():
    f = pynbody.load("testdata/gasoline_ahf/g15784.lr.01024")
    h = f.halos()
    return f, h


@pytest.mark.filterwarnings("ignore:No log file found:UserWarning")
def test_sb_profile(snap_and_halos):
    f, h = snap_and_halos
    r, sb, scale, norm = pynbody.plot.stars.sbprofile(h[0], fit_exp=0.5, rmax="10 kpc")

    r0 = [0.08668786, 0.20363257, 0.26737341, 0.31765363, 0.36105263,
          0.40083022, 0.43837936, 0.47334848, 0.50596223, 0.53760338,
          0.56816831, 0.59795692, 0.62673996, 0.65395354, 0.68057819,
          0.70709073, 0.73298487, 0.75822424, 0.7836805, 0.8093996,
          0.83507254, 0.8610379, 0.88669761, 0.91176888, 0.93723952,
          0.96312922, 0.9881676, 1.01312917, 1.03909138, 1.06520541,
          1.09182385, 1.11933554, 1.14695448, 1.17487413, 1.20366801,
          1.23260409, 1.26163128, 1.29136675, 1.32160995, 1.35234374,
          1.38408093, 1.41684422, 1.4499145, 1.48448826, 1.52011305,
          1.5555254, 1.5921512, 1.62962286, 1.66861317, 1.70949596,
          1.75156766, 1.79610226, 1.84239039, 1.88923863, 1.93738947,
          1.98675962, 2.03921791, 2.09416529, 2.15075787, 2.20951908,
          2.26993596, 2.33221602, 2.3980376, 2.46568193, 2.5343601,
          2.60701291, 2.68318206, 2.76228225, 2.84401692, 2.92896421,
          3.01747621, 3.11133564, 3.21078164, 3.31458753, 3.42435416,
          3.53680731, 3.65264094, 3.77713345, 3.90884893, 4.04963752,
          4.20147324, 4.35771223, 4.51605302, 4.68337016, 4.85789164,
          5.0384083, 5.22711524, 5.42946145, 5.64529882, 5.87271965,
          6.10884874, 6.36566983, 6.64798635, 6.95208341, 7.28470793,
          7.63983852, 8.02516699, 8.46691225, 9.00212771, 9.64897665]
    sb0 = [17.334743703903918, 17.44640560565276, 17.28822550700346, 17.103101649615084, 17.4360902586635,
           17.348904705845023, 17.504795829178008, 17.372358256744704, 17.5232381788712, 17.449537172260285,
           17.55132169343717, 17.64793531537077, 17.44051287907555, 17.70692710025005, 17.57943072594359,
           17.750409551355727, 17.623533738149078, 17.644552499422723, 18.029472675640964, 17.85357307392847,
           17.962055213379525, 17.865915461528136, 17.96858137387311, 18.034826241931828, 18.231053904117257,
           18.170464669664547, 18.15391008760113, 18.03622656425078, 18.311612357041263, 18.21490849731027,
           18.448381912456828, 18.485173932779436, 18.50599906930946, 18.414570414565397, 18.630804268454398,
           18.645149798866555, 18.775583679379075, 18.774727045339393, 18.810122644196984, 18.85641944121841,
           18.976177897886835, 19.04416095648541, 19.083401369360082, 19.166776658747043, 19.125788016045558,
           19.28154814861099, 19.18988692916119, 19.33626891898893, 19.497340587870372, 19.495992236560436,
           19.674592447312094, 19.73472077582014, 19.749053120180584, 19.752869099984018, 19.799401366082385,
           19.826315102029465, 19.98740351057631, 20.00246225217145, 19.659098870772798, 20.145193846060113,
           20.231453320032557, 20.22335730898034, 20.27239027998416, 20.279023514245566, 20.377239688296008,
           20.20653807671308, 20.49564649009517, 20.526943771588595, 20.546109832590574, 20.61173926363751,
           20.5401135793297, 20.799908591506128, 20.586461400575104, 20.729447242896683, 20.979441864366635,
           20.97887668914343, 21.186886401066328, 21.010415959607936, 21.32811143876343, 21.402705292096066,
           21.52977251644326, 21.045135183775194, 21.50688514658828, 21.63090670278109, 21.596918009362543,
           21.2821262598732, 21.39881604516278, 21.883079032682975, 21.90771036232132, 21.979153358392658,
           21.807918599579118, 22.094533295868057, 21.992201570651563, 22.415879417468663, 22.299581962288716,
           22.344801876689292, 22.268970809770046, 23.050266981755293, 23.059453070454644, 23.85030335143449]
    scale0 = 1.598896
    norm0 = 17.968044

    npt.assert_allclose(r, r0, rtol=1e-7)
    npt.assert_allclose(sb, sb0, rtol=1e-7)
    npt.assert_allclose(scale, scale0, rtol=1e-7)
    npt.assert_allclose(norm, norm0, rtol=1e-7)

@pytest.mark.filterwarnings("ignore:No log file found:UserWarning")
def test_sfh(snap_and_halos):
    f, h = snap_and_halos
    t, sfh = pynbody.plot.stars.sfh(h[0])

    t0 = [0.23160894, 0.36657633, 0.50154373, 0.63651112, 0.77147851,
          0.9064459, 1.04141329, 1.17638068, 1.31134807, 1.44631546,
          1.58128285, 1.71625024, 1.85121763, 1.98618502, 2.12115241,
          2.25611981, 2.3910872, 2.52605459, 2.66102198, 2.79598937,
          2.93095676, 3.06592415, 3.20089154, 3.33585893, 3.47082632,
          3.60579371, 3.7407611, 3.8757285, 4.01069589, 4.14566328,
          4.28063067, 4.41559806, 4.55056545, 4.68553284, 4.82050023,
          4.95546762, 5.09043501, 5.2254024, 5.36036979, 5.49533718,
          5.63030458, 5.76527197, 5.90023936, 6.03520675, 6.17017414,
          6.30514153, 6.44010892, 6.57507631, 6.7100437, 6.84501109,
          6.97997848, 7.11494587, 7.24991326, 7.38488066, 7.51984805,
          7.65481544, 7.78978283, 7.92475022, 8.05971761, 8.194685,
          8.32965239, 8.46461978, 8.59958717, 8.73455456, 8.86952195,
          9.00448935, 9.13945674, 9.27442413, 9.40939152, 9.54435891,
          9.6793263, 9.81429369, 9.94926108, 10.08422847, 10.21919586,
          10.35416325, 10.48913064, 10.62409803, 10.75906543, 10.89403282,
          11.02900021, 11.1639676, 11.29893499, 11.43390238, 11.56886977,
          11.70383716, 11.83880455, 11.97377194, 12.10873933, 12.24370672,
          12.37867412, 12.51364151, 12.6486089, 12.78357629, 12.91854368,
          13.05351107, 13.18847846, 13.32344585, 13.45841324, 13.59338063,
          13.72834802]

    sfh0 = [0.35855347, 1.56101938, 3.4456114, 5.32119741, 15.19657074,
            21.22159318, 30.07963412, 43.70868589, 47.28474849, 42.75664328,
            52.92601364, 62.54722538, 46.71281852, 52.67547379, 41.99851596,
            30.39877028, 28.04710316, 28.90193334, 27.98081876, 26.34093023,
            24.81153507, 21.75968903, 20.0778341, 19.11956184, 17.9305885,
            16.6756488, 17.96513369, 15.78863045, 12.36869897, 11.55602824,
            11.47672118, 10.2917112, 9.70704, 9.71972978, 10.27028945,
            9.74930048, 9.36958484, 8.53044963, 8.66610515, 8.51290009,
            8.54317933, 8.25448224, 7.86579607, 7.39748441, 7.15336397,
            6.89119156, 6.53635068, 6.78163586, 6.36162173, 6.18236408,
            5.74970147, 5.46508479, 5.73229865, 5.58381441, 5.44771686,
            5.10256262, 4.80111842, 4.93139337, 5.52204463, 5.02788058,
            4.40733215, 4.21518958, 4.1403365, 4.4552328, 4.11007103,
            4.03525989, 3.56364822, 3.68580178, 4.06211697, 3.69896696,
            3.47161382, 3.81267958, 3.57678949, 3.30952793, 3.49371003,
            3.30099964, 3.12186234, 3.15215854, 3.24447164, 3.26196206,
            3.11306531, 2.98182771, 3.04333189, 2.98204232, 3.20074561,
            3.07375322, 2.98641521, 2.824613, 2.74526299, 3.19163668,
            2.92078668, 3.08228986, 3.12615621, 3.33629631, 3.36681181,
            3.37122513, 3.33166896, 3.39289043, 3.49792132, 3.42365663]

    npt.assert_allclose(t, t0, atol=1e-5)
    npt.assert_allclose(sfh, sfh0, atol=1e-5)
