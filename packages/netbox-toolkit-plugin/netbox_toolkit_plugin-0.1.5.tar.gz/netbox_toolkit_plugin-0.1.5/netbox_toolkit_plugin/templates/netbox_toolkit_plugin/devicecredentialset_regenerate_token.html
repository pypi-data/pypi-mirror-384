{% extends 'generic/object.html' %}
{% load helpers %}

{% block breadcrumbs %}
  {{ block.super }}
  <li class="breadcrumb-item"><a href="{% url 'plugins:netbox_toolkit_plugin:devicecredentialset_list' %}">Credential Sets</a></li>
  <li class="breadcrumb-item"><a href="{{ object.get_absolute_url }}">{{ object.name }}</a></li>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col col-md-8 offset-md-2">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="mdi mdi-refresh text-warning"></i>
                    Regenerate Credential Token
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-warning">
                    <h6><i class="mdi mdi-alert"></i> Warning</h6>
                    <p>You are about to regenerate the credential token for credential set <strong>{{ object.name }}</strong>.</p>
                    <ul class="mb-0">
                        <li>This will invalidate the current token immediately</li>
                        <li>Any applications using the current token will need to be updated</li>
                        <li>The new token will be displayed only once</li>
                        <li>This action cannot be undone</li>
                    </ul>
                </div>

                <form method="post">
                    {% csrf_token %}

                    <div class="row">
                        <div class="col-md-6">
                            <h6>Current Token Information</h6>
                            <table class="table table-sm">
                                <tr>
                                    <th>Token (truncated):</th>
                                    <td><code>{{ object.access_token|truncatechars:20 }}...</code></td>
                                </tr>
                                <tr>
                                    <th>Created:</th>
                                    <td>{{ object.created|date:"SHORT_DATETIME_FORMAT" }}</td>
                                </tr>
                                {% if object.last_used %}
                                <tr>
                                    <th>Last Used:</th>
                                    <td>{{ object.last_used|date:"SHORT_DATETIME_FORMAT" }}</td>
                                </tr>
                                {% else %}
                                <tr>
                                    <th>Last Used:</th>
                                    <td><span class="text-muted">Never</span></td>
                                </tr>
                                {% endif %}
                            </table>
                        </div>

                        <div class="col-md-6">
                            <h6>Security Recommendations</h6>
                            <ul class="text-muted small">
                                <li>Only regenerate if the token is compromised</li>
                                <li>Store the new token securely immediately</li>
                                <li>Update all applications using this token</li>
                                <li>Consider using environment variables for token storage</li>
                                <li>Monitor usage after regeneration</li>
                            </ul>
                        </div>
                    </div>

                    <hr>

                    <div class="form-group">
                        <label for="confirm" class="form-label">
                            <strong>Type "REGENERATE" to confirm:</strong>
                        </label>
                        <input type="text"
                               class="form-control"
                               id="confirm"
                               name="confirm"
                               required
                               placeholder="Type REGENERATE to confirm"
                               style="max-width: 300px;">
                        <small class="form-text text-muted">
                            This confirmation is required to prevent accidental token regeneration.
                        </small>
                    </div>

                    <div class="form-group">
                        <button type="submit" class="btn btn-warning">
                            <i class="mdi mdi-refresh"></i> Regenerate Token
                        </button>
                        <a href="{{ object.get_absolute_url }}" class="btn btn-secondary">
                            <i class="mdi mdi-arrow-left"></i> Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Add confirmation validation
document.querySelector('form').addEventListener('submit', function(e) {
    const confirmInput = document.getElementById('confirm');
    if (confirmInput.value !== 'REGENERATE') {
        e.preventDefault();
        alert('Please type "REGENERATE" exactly to confirm token regeneration.');
        confirmInput.focus();
        return false;
    }

    // Final confirmation dialog
    if (!confirm('Are you absolutely sure you want to regenerate this credential token? This action cannot be undone.')) {
        e.preventDefault();
        return false;
    }
});
</script>
{% endblock %}