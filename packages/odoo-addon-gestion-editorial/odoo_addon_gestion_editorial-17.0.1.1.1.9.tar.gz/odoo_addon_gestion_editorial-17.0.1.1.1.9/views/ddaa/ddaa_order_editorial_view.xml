<?xml version="1.0" encoding="UTF-8"?>
<odoo>
  <record id="ddaa_order_form_editorial_view" model="ir.ui.view">
    <field name="name">ddaa.order.editorial.form.view</field>
    <field name="model">purchase.order</field>
    <field name="mode">primary</field>
    <field name="priority">100</field>
    <field name="inherit_id" ref="purchase.purchase_order_form"/>
    <field name="arch" type="xml">

      <xpath expr="//field[@name='picking_type_id']" position="after">
        <field name="available_products" invisible="1" />
        <field name="is_ddaa_order" invisible="1"/>
      </xpath>

      <!-- Hide all products in DDAA orders-->
      <xpath expr="//field[@name='order_line']/tree//field[@name='product_id']" position="attributes">
        <attribute name="domain">[('id', 'in', [])]</attribute> <!-- Empty domain -->
      </xpath>

      <xpath expr="//field[@name='date_order']" position="before">
        <field name="picking_type_id" domain="[('code','=','incoming'), '|', ('warehouse_id', '=', False), ('warehouse_id.company_id', '=', company_id)]" options="{'no_create': True}" groups="stock.group_stock_multi_locations"/>
      </xpath>

      <!-- Show order date when purchase done in DDAA orders-->
      <xpath expr="//field[@name='date_approve']" position="before">
        <field name="date_order" invisible="is_ddaa_order == False or state != 'purchase'" />
      </xpath>

      <!-- Show confirmation date when purchase status is purchase/done -->
      <xpath expr="//field[@name='date_approve']" position="replace">
        <field name="date_approve" invisible="state not in ['purchase', 'done']"/>
      </xpath>

      <xpath expr="//page/field[@name='order_line']/tree/field[@name='product_barcode']" position="attributes">
            <attribute name="optional">hide</attribute>
        </xpath>

      <xpath expr="//page/field[@name='order_line']/tree/field[@name='product_id']" position="after">
          <field name="contact_type" optional="show"/>
      </xpath>

      <xpath expr="//page/field[@name='order_line']/tree/field[@name='contact_type']" position="after">
          <field name="start_date" optional="show"/>
      </xpath>

      <xpath expr="//page/field[@name='order_line']/tree/field[@name='start_date']" position="after">
          <field name="end_date" optional="show"/>
      </xpath>

      <xpath expr="//page/field[@name='order_line']/tree/field[@name='name']" position="replace">
        <field name="name" invisible="display_type != 'line_section'"/>
      </xpath>
    </field>
  </record>

  <record id="ddaa_purchase_order_view_tree" model="ir.ui.view">
    <field name="name">ddaa.purchase.order.view.tree</field>
    <field name="model">purchase.order</field>
    <field name="inherit_id" ref="purchase.purchase_order_tree"/>
    <field name="arch" type="xml">
      <xpath expr="//tree" position="replace">
        <tree decoration-muted="state=='cancel'" decoration-info="state in ('wait','confirmed')" string="Purchase Order" class="o_purchase_order">
          <field name="partner_ref" optional="hide"/>
          <field name="is_ddaa_order" optional="hide"/>
          <field name="name" string="Referencia" readonly="1"/>
          <field name="partner_id" string="Autor"/>
          <field name="date_order" optional="show"/>
          <field name="date_approve" optional="show"/>
          <field name="amount_untaxed" sum="Total Untaxed amount" string="Untaxed" widget="monetary" optional="hide"/>
          <field name="amount_total" sum="Total amount" widget="monetary" optional="show"/>
          <field name="currency_id" invisible="1"/>
          <field name="state" optional="show"/>
        </tree>
      </xpath>
    </field>
  </record>

  <record id="action_ddaa_purchase_orders" model="ir.actions.act_window">
      <field name="name">Albaranes de autoría</field>
      <field name="res_model">purchase.order</field>
      <field name="view_mode">tree,kanban,form</field>
      <field name="view_ids" eval="[(5, 0, 0),
                (0, 0, {'view_mode': 'tree', 'view_id': ref('ddaa_purchase_order_view_tree')}),
                (0, 0, {'view_mode': 'form', 'view_id': ref('ddaa_order_form_editorial_view')})]"/>
      <field name="search_view_id" ref="purchase.purchase_order_view_search"/>
      <field name="domain">[('is_ddaa_order','=',True)]</field>
      <field name="context">{}</field>
      <field name="help" type="html">
        <p class="o_view_nocontent_smiling_face">
          Crear un nuevo albarán de autoría
        </p>
      </field>
  </record>

</odoo>
