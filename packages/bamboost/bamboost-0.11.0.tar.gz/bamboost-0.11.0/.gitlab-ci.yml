stages:
  - test
  - docs

test:
  stage: test
  image: python:$PYTHON_VERSION
  variables:
    UV_VERSION: latest
  before_script:
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - mv $HOME/.local/bin/uv /usr/local/bin
    - uv sync --active --group test
  script:
    - uv run pytest --cov=bamboost tests
  cache:
    key: "$CI_JOB_NAME-$PYTHON_VERSION"
    paths:
      - .venv/
  parallel:
    matrix:
      - PYTHON_VERSION: ["3.10"]
  coverage: /(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/
  rules:
    - if: '$CI_COMMIT_BRANCH != "next"'

trigger_github_docs:
  stage: docs
  image: curlimages/curl:latest
  script:
    - |
      TAG_NAME="${CI_COMMIT_TAG}"
      echo "Triggering GitHub workflow for tag $TAG_NAME"
      curl -X POST \
        -H "Accept: application/vnd.github+json" \
        -H "Authorization: Bearer $GITHUB_BAMBOOST_DOCS_WF_TOKEN" \
        https://api.github.com/repos/zrlf/bamboost-docs/actions/workflows/deploy.yml/dispatches
  only:
    - tags
