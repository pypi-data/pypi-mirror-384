Description: Update DER Program Poll Rate
Category: Control
Classes:
  - A
  - DR-A

TargetVersions:
  - v1.2
  - v1.3-beta/storage

Criteria:
  checks:
    - type: all-steps-complete
      parameters: {}

Preconditions:
  init_actions:
    - type: set-comms-rate
      parameters:
        dcap_poll_seconds: 60
        edev_list_poll_seconds: 60
        fsa_list_poll_seconds: 60
        der_list_poll_seconds: 60
        derp_list_poll_seconds: 60
        mup_post_seconds: 60
    - type: create-der-program
      parameters:
        primacy: 0
  checks:
    - type: end-device-contents
      parameters: {}
    
Steps:

  # (a, b)
  WAIT-POLL-UPDATE:
    event:
      type: wait
      parameters:
        duration_seconds: 60
    actions:
      - type: set-comms-rate
        parameters:
          derp_list_poll_seconds: 120
      - type: enable-steps
        parameters:
          steps:
            - GET-DERP-LIST-1
            - WAIT-10-MINS
      - type: remove-steps
        parameters:
          steps:
            - WAIT-POLL-UPDATE
    
  # (c)
  GET-DERP-LIST-1:
    event:
      type: GET-request-received
      parameters:
        endpoint: /edev/1/fsa/1/derp
    actions:
      - type: remove-steps
        parameters:
          steps:
            - GET-DERP-LIST-1

  # (a, e)
  WAIT-10-MINS:
    event:
      type: wait
      parameters:
        duration_seconds: 600
    actions:
      - type: enable-steps
        parameters:
          steps:
            - GET-DERP-LIST-2
      - type: remove-steps
        parameters:
          steps:
            - WAIT-10-MINS
    instructions:
      - Client shall maintain changed DERProgramList poll rate of 120s

  # (h)
  # We will start a "timer" as soon as the client picks up the updated poll rate
  GET-DERP-LIST-2:
    event:
      type: GET-request-received
      parameters:
        endpoint: /edev/1/fsa/1/derp
    actions:
      - type: set-comms-rate
        parameters:
          derp_list_poll_seconds: 60
      - type: enable-steps
        parameters:
          steps:
            - GET-DERP-LIST-3
            - WAIT-TEST-END
      - type: remove-steps
        parameters:
          steps:
            - GET-DERP-LIST-2


  # (h)
  # This step waiting for an updated poll and WAIT-TEST-END will ensure it happens within 60 seconds (the new poll rate)
  GET-DERP-LIST-3:
    event:
      type: GET-request-received
      parameters:
        endpoint: /edev/1/fsa/1/derp
    actions:
      - type: remove-steps
        parameters:
          steps:
            - GET-DERP-LIST-3

  # (g)
  WAIT-TEST-END:
    event:
      type: wait
      parameters:
        duration_seconds: 90
    actions:
      - type: remove-steps
        parameters:
          steps:
            - WAIT-TEST-END
      - type: finish-test
        parameters: {}
    instructions:
      - Client shall return to 60s polling

  
