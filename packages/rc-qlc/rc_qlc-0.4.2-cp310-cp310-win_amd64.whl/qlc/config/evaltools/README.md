# QLC Evaltools Integration

## Overview

This directory contains the configuration and tools to create evaltools plots from qlc-py collocation output.

The workflow uses qlc-py's collocation output directly, **bypassing the need for additional interpolation**. This ensures consistency between qlc-py and evaltools plots.

## Key Features

1. **Direct Conversion**: Uses qlc-py collocation output (no additional interpolation)
2. **Consistent Data**: Evaltools plots use the same collocated data as qlc-py
3. **Simple Workflow**: Two commands - one for collocation, one for plotting
4. **Automatic Processing**: Variable discovery from configuration

## Workflow

```bash
cd ~/qlc/run

# Step 1: Create collocated station data using qlc-py
qlc b2ro b2rn 2018-12-01 2018-12-21 qpy

# Step 2: Create evaltools plots
qlc b2ro b2rn 2018-12-01 2018-12-21 evaltools
```

The evaltools task runs three subscripts:
- **E1 (qlc_E1.sh)**: Converts qlc-py collocation to evaluators
- **E2 (qlc_E2.sh)**: Generates evaltools plots using aqtool
- **Z1 (qlc_Z1.sh)**: Creates final qlc presentation PDF

## Data Flow

```
qlc-py (qpy task)
    ↓
    Produces: qlc_D1_*_collocated_obs_*_mod_*.nc
    ↓
E1 (qlc_evaluator4evaltools.py)
    ↓
    Produces: {region}_{model}_{dates}_{species}.evaluator.evaltools
    ↓
E2 (qlc_aqtool_1.0.9.py)
    ↓
    Produces: evaltools plots (PNG/PDF)
```

## Input Format

The converter expects qlc-py collocated NetCDF files with this structure:

```
dimensions:
    index = N_RECORDS
variables:
    site_id(index)        - Station identifiers
    time(index)           - Time dimension (days since reference)
    lat(index), lon(index) - Station coordinates
    {SPECIES}_obs(index)  - Observation values
    {SPECIES}_{exp1}(index) - Model experiment 1 values
    {SPECIES}_{exp2}(index) - Model experiment 2 values
```

Example file:
```
Plots/b2ro-b2rn_20181201-20181221/qlc_D1_IFS_EU_ebas_station-locations-208101_stations_NH3_20181201-20181221_daily_collocated_obs_ebas_daily_mod_b2ro_b2rn_daily.nc
```

## Output Format

Evaltools Evaluator objects (pickle format):
```
Analysis/evaluators/EU_b2rn_20181201-20181221_NH3_daily.evaluator.evaltools
Analysis/evaluators/EU_b2ro_20181201-20181221_NH3_daily.evaluator.evaltools
```

Each evaluator contains:
- **Observations**: Time series from observation network (e.g., EBAS)
- **Simulations**: Time series from model experiment
- **Metadata**: Station coordinates, time range, species info
- **Color**: Plot color for the model

## Configuration

The converter is configured via JSON file (auto-generated by `qlc_E1.sh`):

```json
{
  "general": {
    "start_date": "2018-12-01",
    "end_date": "2018-12-21",
    "species_list": "NH3,O3,NO2",
    "models": "b2ro,b2rn",
    "region": "Europe",
    "forecast_horizon": 1,
    "availability_ratio": 0.25
  },
  "listing": {
    "listing_name": "Ebas_station-locations.csv",
    "listing_dir": "/path/to/station/listings"
  },
  "input_output": {
    "plots_dir": "/path/to/Plots/b2ro-b2rn_20181201-20181221",
    "output_dir": "/path/to/Analysis/evaluators",
    "output_file_pattern": "{region}_{model}_{start}-{end}_{species}_{time-average}.evaluator.evaltools"
  }
}
```

## Configuration

Edit `qlc_evaltools.conf` to customize:

```bash
# Variable definitions (what to process)
MARS_RETRIEVALS=("B1_pl" "C1_sfc")
myvar_B1_pl=("NH3")
myvar_C1_sfc=("NH4_as")

# Output settings
EVALTOOLS_OUTPUT_DIR="${ANALYSIS_DIRECTORY}/evaluators"
EVALTOOLS_REGION="Europe"

# Processing parameters
EVALTOOLS_FORECAST_HORIZON=1
EVALTOOLS_AVAILABILITY_RATIO=0.25

# Debug mode
EVALTOOLS_DEBUG=0  # Set to 1 for verbose output
```

## Manual Debugging

For debugging the converter or plotting:

```bash
# Activate evaltools environment
conda activate evaltools

# Run E1 converter manually
python3 qlc_evaluator4evaltools.py --config /path/to/config.json --debug

# Run E2 plotting manually
python3 qlc_aqtool_1.0.9.py plot time_series evaluator1.evaltools evaluator2.evaltools -of output.png
```

## Environment Setup

Evaltools requires manual download and installation. See `qlc/doc/EVALTOOLS.md` for complete installation instructions.

Quick summary:
```bash
# Download evaltools v1.0.9 from official repository
cd ~/download_evaltools
wget https://redmine.umr-cnrm.fr/attachments/download/5300/evaltools_v1.0.9.zip
# ... (see EVALTOOLS.md for complete setup)

# Create conda environment with dependencies
conda env create -f environment.yml
conda activate evaltools
```

**Full instructions**: See `qlc/doc/EVALTOOLS.md`

## File Locations

- **Configuration**: `qlc/config/evaltools/qlc_evaltools.conf`
- **Converter script**: `qlc/config/evaltools/qlc_evaluator4evaltools.py`
- **Plotting script**: `qlc/config/evaltools/qlc_aqtool_1.0.9.py`
- **Shell scripts**: `qlc/bin/qlc_E1.sh`, `qlc/bin/qlc_E2.sh`, `qlc/bin/qlc_Z1.sh`
- **Input files**: `~/qlc/Plots/{exp1}-{exp2}_{dates}/qlc_D1_*_collocated_*.nc`
- **Evaluators**: `~/qlc/Analysis/evaluators/*.evaluator.evaltools`
- **Output plots**: `~/qlc/Plots/{exp1}-{exp2}_{dates}/qlc_E2_evaltools_*.png`
- **Logs**: `~/qlc/log/qlc_E1_*.log`, `~/qlc/log/qlc_E2_*.log`

## Files in This Directory

- **qlc_evaltools.conf**: Main configuration file
- **qlc_evaluator4evaltools.py**: Converter from qlc-py collocation to evaltools
- **qlc_aqtool_1.0.9.py**: Evaltools plotting wrapper (aqtool)
- **README.md**: This file

## Troubleshooting

### No collocated files found

**Error**: `No collocated files found in Plots directory`

**Solution**:
- Ensure the `qpy` task has been run first: `qlc b2ro b2rn 2018-12-01 2018-12-21 qpy`
- Check that collocation is enabled in config
- Verify files exist: `ls ~/qlc/Plots/b2ro-b2rn_*/qlc_D1_*_collocated_*.nc`

### Missing evaltools environment

**Error**: `evaltools conda environment not found`

**Solution**: Install evaltools following the instructions in `qlc/doc/EVALTOOLS.md`

Quick steps:
```bash
cd ~/download_evaltools
# Download evaltools v1.0.9 (see EVALTOOLS.md for URLs)
# Create environment from environment.yml
conda env create -f environment.yml
conda activate evaltools
```

### No plots generated

**Problem**: E2 script completes but no plots are created

**Solution**:
- Check E1 created evaluators: `ls ~/qlc/Analysis/evaluators/*.evaluator.evaltools`
- Enable debug mode: Set `EVALTOOLS_DEBUG=1` in config
- Check log files: `tail -f ~/qlc/log/qlc_E2_*.log`

## Logging and Debugging

Enable detailed logging by setting debug mode in config:

```bash
# In qlc_evaltools.conf
EVALTOOLS_DEBUG=1
```

Check log files:
```bash
# E1 converter log
tail -f ~/qlc/log/qlc_E1_b2ro-b2rn_20181201-20181221.log

# E2 plotting log
tail -f ~/qlc/log/qlc_E2_b2ro-b2rn_20181201-20181221.log

# Search for errors
grep -i error ~/qlc/log/qlc_E*.log
```

## Technical Notes

### Data Structure Conversion

The converter transforms data from "long format" (one row per station-time pair) to "wide format" (time x station matrix) required by evaltools:

**Input (qlc-py collocated NetCDF)**:
```
index | time       | station | NH3_obs | NH3_b2ro | NH3_b2rn
------|------------|---------|---------|----------|----------
0     | 2018-12-01 | AT0002R | 1.23    | 1.45     | 1.38
1     | 2018-12-02 | AT0002R | 1.34    | 1.52     | 1.41
2     | 2018-12-01 | DE0001R | 2.45    | 2.67     | 2.58
...
```

**Output (evaltools Evaluator)**:
```
Observations.data:
           AT0002R  DE0001R  ...
2018-12-01   1.23     2.45   ...
2018-12-02   1.34     NaN    ...
...

Simulations.data:
           AT0002R  DE0001R  ...
2018-12-01   1.45     2.67   ...
2018-12-02   1.52     NaN    ...
...
```

### Memory Efficiency

The converter processes files sequentially and uses pandas pivot operations, which are memory-efficient for typical station datasets (10-100 stations, 20-365 days).

For very large datasets (>1000 stations or >1 year), consider:
- Processing species in batches
- Using dask for parallel processing (or use qlc-py)
- Increasing system memory allocation

## Related Scripts

- **qlc/bin/qlc_E1.sh**: Converts collocation to evaluators (uses `qlc_evaluator4evaltools.py`)
- **qlc/bin/qlc_E2.sh**: Generates plots from evaluators (uses `qlc_aqtool_1.0.9.py`)
- **qlc/bin/qlc_Z1.sh**: Creates final PDF presentation
- **qlc/py/stations.py**: qlc-py collocation implementation (`merge_obs_mod()`)

## Support

For issues or questions:
- Check log files: `~/qlc/log/qlc_E*.log`
- Enable debug mode: Set `EVALTOOLS_DEBUG=1` in config
- Contact: Swen Metzger, ResearchConcepts io GmbH, <sm@researchconcepts.io>  
