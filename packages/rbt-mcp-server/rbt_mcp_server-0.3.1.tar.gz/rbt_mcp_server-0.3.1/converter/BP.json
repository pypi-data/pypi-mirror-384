{
  "metadata": {
    "id": "BP-ios-notification-image",
    "group_id": "ai-magic-editor",
    "type": "Blueprint",
    "feature": "ios-notification-image",
    "requirement": "REQ-ios-notification-image"
  },
  "info": {
    "status": "Implemented",
    "update_date": "2025-10-01",
    "implementation_date": "2025-10-01",
    "summary_context": "iOS Notification Service Extension çš„æŠ€è¡“æ¶æ§‹ï¼Œå®šç¾©åœ–ç‰‡ä¸‹è¼‰ã€é™„åŠ æµç¨‹å’Œçµ„ä»¶è¨­è¨ˆã€‚å·²å®Œæˆå¯¦ä½œä¸¦é€šéæ‰€æœ‰å¯¦æ©Ÿæ¸¬è©¦é©—è­‰ã€‚"
  },
  "title": "å°ˆæ¡ˆè—åœ– (Blueprint): iOS Push Notification åœ–ç‰‡é¡¯ç¤º",
  "sections": [
    {
      "id": "sec-core-data-structures",
      "title": "1. æ ¸å¿ƒè³‡æ–™çµæ§‹ (Core Data Structures)",
      "summary": "å®šç¾©åœ–ç‰‡ä¸‹è¼‰ï¼²ï¼¢ï¼´å’Œé€šçŸ¥è™•ç†æ‰€éœ€çš„æ ¸å¿ƒè³‡æ–™çµæ§‹ã€‚",
      "blocks": [
        {
          "id": "blk-ds-imageinfo",
          "type": "code",
          "title": "NotificationImageInfo",
          "content": "struct NotificationImageInfo {\n    let imageUrl: URL          // åœ–ç‰‡ URL\n    let contentType: String?   // MIME type (å¯é¸)\n}"
        },
        {
          "id": "blk-ds-result",
          "type": "code",
          "title": "DownloadResult",
          "content": "enum DownloadResult {\n    case success(URL)  // æœ¬åœ°æš«å­˜æª”æ¡ˆ URL\n    case failure       // ä¸‹è¼‰å¤±æ•—ï¼ˆå« timeoutï¼‰\n}"
        }
      ],
      "children": []
    },
    {
      "id": "sec-component-specs",
      "title": "2. çµ„ä»¶è¦æ ¼ (Component Specifications)",
      "summary": "å®šç¾©å¯¦ç¾ Notification Service Extension æ‰€éœ€çš„ä¸‰å¤§æ ¸å¿ƒçµ„ä»¶ã€‚",
      "blocks": [],
      "children": [
        {
          "id": "sec-spec-notificationservice",
          "title": "NotificationService (Extension ä¸»é«”)",
          "summary": null,
          "blocks": [
            {
              "id": "blk-ns-intro",
              "type": "list",
              "title": "ç°¡ä»‹",
              "items": [
                "Notification Service Extension çš„ä¸»è¦é¡åˆ¥ï¼Œç¹¼æ‰¿ `UNNotificationServiceExtension`"
              ]
            },
            {
              "id": "blk-ns-duty",
              "type": "list",
              "title": "è·è²¬",
              "items": [
                "æ¥æ”¶ç³»çµ±èª¿ç”¨ `didReceive(_:withContentHandler:)`",
                "è§£æ FCM payload å–å¾—åœ–ç‰‡ URL",
                "å”èª¿ Downloader å’Œ Modifier å®Œæˆåœ–ç‰‡é™„åŠ ",
                "è™•ç† 30 ç§’ç³»çµ±è¶…æ™‚"
              ]
            },
            {
              "id": "blk-ns-input",
              "type": "list",
              "title": "è¼¸å…¥",
              "items": [
                "`request: UNNotificationRequest` (é€šçŸ¥è«‹æ±‚)",
                "`contentHandler: (UNNotificationContent) -> Void` (å®Œæˆå›èª¿)"
              ]
            },
            {
              "id": "blk-ns-output",
              "type": "list",
              "title": "è¼¸å‡º",
              "items": [
                "ä¿®æ”¹å¾Œçš„ `UNNotificationContent`ï¼ˆå«åœ–ç‰‡é™„ä»¶æˆ–åŸå§‹å…§å®¹ï¼‰"
              ]
            },
            {
              "id": "blk-ns-tasks",
              "type": "list",
              "title": "å¯¦ä½œ Tasks",
              "items": [
                "`TASK-001-notification-service`"
              ]
            },
            {
              "id": "blk-ns-acceptance",
              "type": "list",
              "title": "æŠ€è¡“é©—æ”¶æ¨™æº–",
              "items": [
                "æˆåŠŸè§£æ FCM payload ä¸­çš„åœ–ç‰‡ URL",
                "æ­£ç¢ºå”èª¿ Downloader å’Œ Modifier",
                "ä¸‹è¼‰/é™„åŠ å¤±æ•—æ™‚é€€å›åŸå§‹é€šçŸ¥",
                "è™•ç† `serviceExtensionTimeWillExpire()` è¶…æ™‚æƒ…æ³"
              ]
            }
          ],
          "children": []
        },
        {
          "id": "sec-spec-downloader",
          "title": "NotificationImageDownloader (åœ–ç‰‡ä¸‹è¼‰å™¨)",
          "summary": null,
          "blocks": [
            {
              "id": "blk-dl-intro",
              "type": "list",
              "title": "ç°¡ä»‹",
              "items": [
                "è² è²¬å¾ HTTPS URL ä¸‹è¼‰åœ–ç‰‡åˆ°æœ¬åœ°æš«å­˜"
              ]
            },
            {
              "id": "blk-dl-duty",
              "type": "list",
              "title": "è·è²¬",
              "items": [
                "ä½¿ç”¨ `URLSession.shared.downloadTask` ä¸‹è¼‰åœ–ç‰‡",
                "è¨­å®š 5 ç§’ timeout",
                "é©—è­‰ URL ç‚º HTTPS",
                "éŒ¯èª¤è™•ç†èˆ‡æ—¥èªŒè¨˜éŒ„"
              ]
            },
            {
              "id": "blk-dl-input",
              "type": "list",
              "title": "è¼¸å…¥",
              "items": [
                "`imageUrl: URL` (åœ–ç‰‡ URL)",
                "`timeout: TimeInterval` (é è¨­ 5 ç§’)"
              ]
            },
            {
              "id": "blk-dl-output",
              "type": "list",
              "title": "è¼¸å‡º",
              "items": [
                "æˆåŠŸ: æœ¬åœ°æš«å­˜æª”æ¡ˆ `URL`",
                "å¤±æ•—: `nil`ï¼ˆä¸¦è¨˜éŒ„ logï¼‰"
              ]
            },
            {
              "id": "blk-dl-tasks",
              "type": "list",
              "title": "å¯¦ä½œ Tasks",
              "items": [
                "`TASK-002-image-downloader`"
              ]
            },
            {
              "id": "blk-dl-acceptance",
              "type": "list",
              "title": "æŠ€è¡“é©—æ”¶æ¨™æº–",
              "items": [
                "åªæ¥å— HTTPS URLï¼ˆHTTP æ‹’çµ•ï¼‰",
                "5 ç§’ timeout æ­£ç¢ºè§¸ç™¼",
                "ä¸‹è¼‰æˆåŠŸè¿”å›æœ‰æ•ˆçš„æœ¬åœ°æª”æ¡ˆ URL",
                "å¤±æ•—æ™‚æ­£ç¢ºè¨˜éŒ„éŒ¯èª¤æ—¥èªŒ"
              ]
            }
          ],
          "children": []
        },
        {
          "id": "sec-spec-modifier",
          "title": "NotificationContentModifier (é€šçŸ¥å…§å®¹ä¿®æ”¹å™¨)",
          "summary": null,
          "blocks": [
            {
              "id": "blk-mod-intro",
              "type": "list",
              "title": "ç°¡ä»‹",
              "items": [
                "è² è²¬å»ºç«‹ `UNNotificationAttachment` ä¸¦é™„åŠ åˆ°é€šçŸ¥å…§å®¹"
              ]
            },
            {
              "id": "blk-mod-duty",
              "type": "list",
              "title": "è·è²¬",
              "items": [
                "å¾æœ¬åœ°æª”æ¡ˆ URL å»ºç«‹ `UNNotificationAttachment`",
                "é™„åŠ åˆ° `UNMutableNotificationContent.attachments`",
                "éŒ¯èª¤è™•ç†èˆ‡æ—¥èªŒè¨˜éŒ„"
              ]
            },
            {
              "id": "blk-mod-input",
              "type": "list",
              "title": "è¼¸å…¥",
              "items": [
                "`content: UNMutableNotificationContent` (å¯ä¿®æ”¹çš„é€šçŸ¥å…§å®¹)",
                "`imageFileUrl: URL` (æœ¬åœ°åœ–ç‰‡æª”æ¡ˆ URL)"
              ]
            },
            {
              "id": "blk-mod-output",
              "type": "list",
              "title": "è¼¸å‡º",
              "items": [
                "æˆåŠŸ: é™„åŠ åœ–ç‰‡å¾Œçš„ `UNMutableNotificationContent`",
                "å¤±æ•—: åŸå§‹ `content`ï¼ˆä¸¦è¨˜éŒ„ logï¼‰"
              ]
            },
            {
              "id": "blk-mod-tasks",
              "type": "list",
              "title": "å¯¦ä½œ Tasks",
              "items": [
                "`TASK-003-content-modifier`"
              ]
            },
            {
              "id": "blk-mod-acceptance",
              "type": "list",
              "title": "æŠ€è¡“é©—æ”¶æ¨™æº–",
              "items": [
                "æˆåŠŸå»ºç«‹ `UNNotificationAttachment`",
                "æ­£ç¢ºé™„åŠ åˆ° `content.attachments`",
                "é™„åŠ å¤±æ•—æ™‚ä¸å½±éŸ¿åŸå§‹ content",
                "å¤±æ•—æ™‚æ­£ç¢ºè¨˜éŒ„éŒ¯èª¤æ—¥èªŒ"
              ]
            }
          ],
          "children": []
        }
      ]
    },
    {
      "id": "sec-core-logic",
      "title": "3. æ ¸å¿ƒè™•ç†é‚è¼¯ (Core Processing Logic)",
      "summary": "è©³ç´°æè¿°å¾æ”¶åˆ°é€šçŸ¥åˆ°é¡¯ç¤ºåœ–ç‰‡çš„å®Œæ•´è™•ç†æµç¨‹ã€‚",
      "blocks": [],
      "children": [
        {
          "id": "sec-logic-mainflow",
          "title": "ä¸»æµç¨‹ (NotificationService)",
          "summary": null,
          "blocks": [
            {
              "id": "blk-mf-step1",
              "type": "code",
              "title": "éšæ®µ 1: æ¥æ”¶é€šçŸ¥",
              "content": "iOS ç³»çµ±æ”¶åˆ° FCM æ¨æ’­\n  â†“\næª¢æŸ¥ payload æ˜¯å¦å« mutable-content: 1\n  â†“\nç³»çµ±å•Ÿå‹• NotificationService Extension\n  â†“\nèª¿ç”¨ didReceive(_:withContentHandler:)"
            },
            {
              "id": "blk-mf-step2",
              "type": "code",
              "title": "éšæ®µ 2: è§£æ Payload",
              "content": "å–å¾— request.content.userInfo\n  â†“\nå„ªå…ˆè§£æ: userInfo[\"fcm_options\"][\"image\"] (iOS å°ˆç”¨)\n  â†“\nå‚™ç”¨è§£æ: userInfo[\"notification\"][\"image\"] (é€šç”¨)\n  â†“\né©—è­‰ URL æ ¼å¼ (å¿…é ˆæ˜¯ HTTPS)"
            },
            {
              "id": "blk-mf-step2-note",
              "type": "list",
              "title": "âš ï¸ å¾…ç¢ºèª",
              "items": [
                "FCM payload çš„å¯¦éš›æ¬„ä½åç¨±ï¼ˆå¾…å¾Œç«¯æä¾›å¯¦éš›æ ¼å¼ï¼‰"
              ]
            },
            {
              "id": "blk-mf-step3",
              "type": "code",
              "title": "éšæ®µ 3: ä¸‹è¼‰åœ–ç‰‡",
              "content": "æœ‰æ•ˆçš„åœ–ç‰‡ URLï¼Ÿ\n  â”œâ”€ NO  â†’ è·³åˆ°éšæ®µ 5ï¼ˆå›å‚³åŸå§‹å…§å®¹ï¼‰\n  â””â”€ YES â†’ èª¿ç”¨ NotificationImageDownloader.download(imageUrl)\n             â†“\n           URLSession.downloadTask (5ç§’ timeout)\n             â†“\n           æˆåŠŸï¼Ÿ\n             â”œâ”€ NO  â†’ è·³åˆ°éšæ®µ 5ï¼ˆå›å‚³åŸå§‹å…§å®¹ + logï¼‰\n             â””â”€ YES â†’ ç¹¼çºŒéšæ®µ 4"
            },
            {
              "id": "blk-mf-step4",
              "type": "code",
              "title": "éšæ®µ 4: é™„åŠ åœ–ç‰‡",
              "content": "NotificationContentModifier.attach(imageFileUrl, to: content)\n  â†“\nå»ºç«‹ UNNotificationAttachment\n  â†“\næˆåŠŸï¼Ÿ\n  â”œâ”€ NO  â†’ è·³åˆ°éšæ®µ 5ï¼ˆå›å‚³åŸå§‹å…§å®¹ + logï¼‰\n  â””â”€ YES â†’ content.attachments.append(attachment)"
            },
            {
              "id": "blk-mf-step5",
              "type": "code",
              "title": "éšæ®µ 5: å›å‚³çµæœ",
              "content": "èª¿ç”¨ contentHandler(modifiedContent)\n  â†“\niOS ç³»çµ±é¡¯ç¤ºé€šçŸ¥\n  â†“\næœ‰åœ–ç‰‡é™„ä»¶ â†’ Rich Notificationï¼ˆå¯å±•é–‹æŸ¥çœ‹åœ–ç‰‡ï¼‰\nç„¡åœ–ç‰‡é™„ä»¶ â†’ ç´”æ–‡å­—é€šçŸ¥"
            }
          ],
          "children": []
        },
        {
          "id": "sec-logic-timeout",
          "title": "è¶…æ™‚è™•ç†",
          "summary": null,
          "blocks": [
            {
              "id": "blk-to-flow",
              "type": "code",
              "title": null,
              "content": "30 ç§’å…§æœªå®Œæˆï¼ˆç³»çµ±é™åˆ¶ï¼‰\n  â†“\niOS èª¿ç”¨ serviceExtensionTimeWillExpire()\n  â†“\nç«‹å³å›å‚³ç•¶å‰çš„ bestAttemptContent\n  â†“\nå³ä½¿åœ–ç‰‡æœªä¸‹è¼‰å®Œæˆï¼Œä¹Ÿé¡¯ç¤ºé€šçŸ¥ï¼ˆä¸é˜»æ–·ç”¨æˆ¶ï¼‰"
            }
          ],
          "children": []
        }
      ]
    },
    {
      "id": "sec-tech-details",
      "title": "4. æŠ€è¡“æ¶æ§‹ç´°ç¯€",
      "summary": null,
      "blocks": [],
      "children": [
        {
          "id": "sec-td-files",
          "title": "æª”æ¡ˆçµæ§‹",
          "summary": null,
          "blocks": [
            {
              "id": "blk-td-files-code",
              "type": "code",
              "title": null,
              "content": "MagicEditor/\nâ””â”€â”€ Sources/\n    â””â”€â”€ Extensions/\n        â””â”€â”€ NotificationService/\n            â”œâ”€â”€ NotificationService.swift          // ä¸»é«” (TASK-001)\n            â”œâ”€â”€ NotificationImageDownloader.swift  // ä¸‹è¼‰å™¨ (TASK-002)\n            â””â”€â”€ NotificationContentModifier.swift  // ä¿®æ”¹å™¨ (TASK-003)"
            }
          ],
          "children": []
        },
        {
          "id": "sec-td-tuist",
          "title": "Tuist å°ˆæ¡ˆé…ç½®",
          "summary": null,
          "blocks": [
            {
              "id": "blk-td-tuist-list",
              "type": "list",
              "title": null,
              "items": [
                "æ–°å¢ `NotificationServiceExtension` target",
                "Bundle ID: `{PRODUCT_BUNDLE_IDENTIFIER}.NotificationServiceExtension`",
                "Deployment Target: iOS 14.0+",
                "ä¾è³´: Foundation, UserNotifications",
                "Info.plist é…ç½®: `NSExtension` ç›¸é—œè¨­å®š",
                "App Groups å…±äº«ï¼ˆæœªä¾†å¯èƒ½éœ€è¦ï¼‰"
              ]
            },
            {
              "id": "blk-td-tuist-tasks",
              "type": "list",
              "title": "å¯¦ä½œ Tasks",
              "items": [
                "`TASK-004-tuist-configuration`"
              ]
            }
          ],
          "children": []
        },
        {
          "id": "sec-td-formats",
          "title": "åœ–ç‰‡æ ¼å¼æ”¯æ´",
          "summary": null,
          "blocks": [
            {
              "id": "blk-td-formats-list",
              "type": "list",
              "title": null,
              "items": [
                "PNG (.png)",
                "JPEG (.jpg, .jpeg)",
                "GIF (.gif)",
                "å…¶ä»–æ ¼å¼ç”± `UNNotificationAttachment` è‡ªå‹•åˆ¤æ–·"
              ]
            }
          ],
          "children": []
        },
        {
          "id": "sec-td-security",
          "title": "å®‰å…¨æ€§è€ƒé‡",
          "summary": null,
          "blocks": [
            {
              "id": "blk-td-security-list",
              "type": "list",
              "title": null,
              "items": [
                "**åªæ¥å— HTTPS URL**ï¼ˆHTTP æ‹’çµ•ï¼‰",
                "**é©—è­‰ Content-Type**ï¼ˆåƒ…æ¥å— image/* MIME typesï¼‰",
                "**è‡ªå‹•æ¸…ç†æš«å­˜æª”æ¡ˆ**ï¼ˆç³»çµ±ç®¡ç†ï¼‰"
              ]
            }
          ],
          "children": []
        }
      ]
    },
    {
      "id": "sec-risks",
      "title": "5. é¢¨éšªã€å¾…è¾¦äº‹é …èˆ‡æ±ºç­– (Risks, Open Questions & Decisions)",
      "summary": null,
      "blocks": [],
      "children": [
        {
          "id": "sec-risks-adr",
          "title": "è¨­è¨ˆæ±ºç­–è¨˜éŒ„ (ADR)",
          "summary": null,
          "blocks": [
            {
              "id": "blk-risks-adr-table",
              "type": "table",
              "title": null,
              "content": "| æ±ºç­–é» | è®Šæ›´åŸå›  | æœ€çµ‚å¯¦ä½œé¸æ“‡ | è¨˜éŒ„æ—¥æœŸ |\n|--------|----------|----------|----------|\n| çµ„ä»¶æ‹†åˆ†ç­–ç•¥ | æœªä¾†æ“´å……æ€§ï¼ˆæŒ‰éˆ•ã€è‡ªè¨‚ UIï¼‰ | æ‹†åˆ†ç‚º 3 å€‹ç¨ç«‹æª”æ¡ˆ | 2025-09-30 |\n| åœ–ç‰‡ä¸‹è¼‰å·¥å…· | Extension è¼•é‡åŒ–ï¼Œä¸ä¾è³´ç¬¬ä¸‰æ–¹ | åŸç”Ÿ URLSession | 2025-09-30 |\n| éŒ¯èª¤è™•ç†æ–¹å¼ | ä¸é˜»æ–·é€šçŸ¥é¡¯ç¤º | å¤±æ•—é€€å›ç´”æ–‡å­— + log | 2025-09-30 |\n| Timeout æ™‚é–“ | å¹³è¡¡é€Ÿåº¦èˆ‡æˆåŠŸç‡ | 5 ç§’ï¼ˆç³»çµ±ç¸½é™åˆ¶ 30 ç§’ï¼‰ | 2025-09-30 |\n| å‰æ™¯é€šçŸ¥è™•ç† | é™ä½è¤‡é›œåº¦ | ä¸è™•ç†ï¼ˆä¿æŒç¾æœ‰è¡Œç‚ºï¼‰ | 2025-09-30 |\n| Completion Flag | é˜²æ­¢é›™é‡å›èª¿é¢¨éšª | æ–°å¢ isCompleted flag å’Œçµ±ä¸€å®Œæˆæ–¹æ³• | 2025-10-01 |\n| Content-Type é©—è­‰ | å®‰å…¨æ€§èˆ‡ç›¸å®¹æ€§å¹³è¡¡ | é©—è­‰ image/* MIME typeï¼ˆå¯¬é¬†ç­–ç•¥ï¼‰ | 2025-10-01 |"
            }
          ],
          "children": []
        },
        {
          "id": "sec-risks-tech",
          "title": "æŠ€è¡“é¢¨éšª",
          "summary": null,
          "blocks": [
            {
              "id": "blk-risks-tech-1",
              "type": "list",
              "title": null,
              "items": [
                "1. **FCM Payload æ ¼å¼ä¸ç¢ºå®š** (å„ªå…ˆç´š: é«˜)",
                "* é¢¨éšª: è§£ææ¬„ä½éŒ¯èª¤å°è‡´ç„¡æ³•å–å¾—åœ–ç‰‡ URL",
                "* ç·©è§£: å¾…å¾Œç«¯ç¢ºèªå¯¦éš›æ ¼å¼å¾Œæ›´æ–°ç¨‹å¼ç¢¼",
                "* å‚™ç”¨æ–¹æ¡ˆ: åŒæ™‚å˜—è©¦å¤šå€‹å¯èƒ½çš„æ¬„ä½åç¨±"
              ]
            },
            {
              "id": "blk-risks-tech-2",
              "type": "list",
              "title": null,
              "items": [
                "2. **åœ–ç‰‡ä¸‹è¼‰é€Ÿåº¦ä¸ç©©å®š** (å„ªå…ˆç´š: ä¸­)",
                "* é¢¨éšª: ç¶²è·¯ä¸ä½³æ™‚ 5 ç§’ timeout ä¸è¶³",
                "* ç·©è§£: å¯èª¿æ•´ timeout åƒæ•¸ï¼Œæˆ–å¾Œç«¯æä¾›ç¸®åœ–",
                "* å‚™ç”¨æ–¹æ¡ˆ: ä½¿ç”¨è€…ä»æ”¶åˆ°ç´”æ–‡å­—é€šçŸ¥"
              ]
            },
            {
              "id": "blk-risks-tech-3",
              "type": "list",
              "title": null,
              "items": [
                "3. **30 ç§’ç³»çµ±è¶…æ™‚** (å„ªå…ˆç´š: ä½)",
                "* é¢¨éšª: æ¥µæ…¢ç¶²è·¯å¯èƒ½è§¸ç™¼ç³»çµ±è¶…æ™‚",
                "* ç·©è§£: 5 ç§’ä¸‹è¼‰ timeout ä¿ç•™è¶³å¤ ç·©è¡",
                "* å‚™ç”¨æ–¹æ¡ˆ: serviceExtensionTimeWillExpire è™•ç†"
              ]
            }
          ],
          "children": []
        },
        {
          "id": "sec-risks-open",
          "title": "å¾…è¾¦äº‹é … (Open Questions)",
          "summary": null,
          "blocks": [
            {
              "id": "blk-risks-open-list",
              "type": "list",
              "title": null,
              "items": [
                "[ ] **FCM Payload æ ¼å¼ç¢ºèª**: ç­‰å¾…å¾Œç«¯æä¾›å¯¦éš›çš„ payload JSON ç¯„ä¾‹",
                "[ ] **å¾Œç«¯ mutable-content è¨­å®š**: ç¢ºèªå¾Œç«¯å·²åœ¨ FCM ç™¼é€æ™‚è¨­å®šæ­¤æ¬„ä½",
                "[ ] **æ¸¬è©¦æ¨æ’­å·¥å…·**: æº–å‚™æ¸¬è©¦ç”¨çš„åœ–ç‰‡ URL å’Œæ¨æ’­ç™¼é€æ–¹å¼",
                "[ ] **App Groups é…ç½®**: å¦‚æœéœ€è¦èˆ‡ä¸» App å…±äº«è³‡æ–™ï¼ˆæœªä¾†æ“´å……ï¼‰"
              ]
            }
          ],
          "children": []
        }
      ]
    },
    {
      "id": "sec-integration",
      "title": "6. èˆ‡ç¾æœ‰æ¶æ§‹çš„æ•´åˆ",
      "summary": null,
      "blocks": [],
      "children": [
        {
          "id": "sec-int-fcm",
          "title": "ç¾æœ‰ FCM æ•´åˆé»",
          "summary": null,
          "blocks": [
            {
              "id": "blk-int-fcm-appdelegate",
              "type": "list",
              "title": "AppDelegate (ä¸éœ€ä¿®æ”¹)",
              "items": [
                "`Messaging.messaging().delegate = self` å·²è¨­å®š",
                "`didReceiveRegistrationToken` å·²è™•ç† token æ›´æ–°",
                "`UNUserNotificationCenter.delegate = self` å·²è¨­å®š"
              ]
            },
            {
              "id": "blk-int-fcm-manager",
              "type": "list",
              "title": "MessagingManager (ä¸éœ€ä¿®æ”¹)",
              "items": [
                "Token ç®¡ç†å·²å®Œå–„",
                "Extension ä¸ç›´æ¥èˆ‡æ­¤äº’å‹•"
              ]
            },
            {
              "id": "blk-int-fcm-foreground",
              "type": "list",
              "title": "å‰æ™¯é€šçŸ¥è™•ç† (ä¸ä¿®æ”¹)",
              "items": [
                "`willPresent` ä¿æŒç¾æœ‰é‚è¼¯",
                "ç¹¼çºŒé¡¯ç¤º `.banner, .sound, .badge`"
              ]
            }
          ],
          "children": []
        },
        {
          "id": "sec-int-backend",
          "title": "å¾Œç«¯ API ä¾è³´",
          "summary": null,
          "blocks": [
            {
              "id": "blk-int-backend-api",
              "type": "list",
              "title": "push-notification-api",
              "items": [
                "éœ€ç¢ºèª `REQ-push-notification-api` æ˜¯å¦å·²åŒ…å«åœ–ç‰‡æ”¯æ´",
                "éœ€ç¢ºèªå¾Œç«¯ç™¼é€ FCM æ™‚çš„ payload æ ¼å¼",
                "éœ€ç¢ºèª `mutable-content: 1` æ˜¯å¦å·²è¨­å®š"
              ]
            }
          ],
          "children": []
        }
      ]
    },
    {
      "id": "sec-task-breakdown",
      "title": "Task æ‹†è§£èˆ‡è¿½è¹¤ (Post Task Breakdown & Tracking)",
      "summary": null,
      "blocks": [],
      "children": [
        {
          "id": "sec-tb-overview",
          "title": "Task æ¦‚è¦½",
          "summary": null,
          "blocks": [
            {
              "id": "blk-tb-overview-table",
              "type": "table",
              "title": null,
              "content": "| Task ID | æ¨™é¡Œ | é ä¼°å·¥æ™‚ | ä¾è³´ | å„ªå…ˆç´š |\n|---------|------|---------|------|--------|\n| TASK-001 | NotificationService ä¸»é«”å¯¦ä½œ | 1.5h | - | é«˜ |\n| TASK-002 | NotificationImageDownloader å¯¦ä½œ | 1h | - | é«˜ |\n| TASK-003 | NotificationContentModifier å¯¦ä½œ | 1h | - | é«˜ |\n| TASK-004 | Tuist å°ˆæ¡ˆé…ç½® | 2h | TASK-001, TASK-002, TASK-003 | é«˜ |\n| TASK-005 | æ•´åˆæ¸¬è©¦èˆ‡é™¤éŒ¯ | 1.5h | TASK-004 | ä¸­ |"
            },
            {
              "id": "blk-tb-overview-total",
              "type": "list",
              "title": "é ä¼°ç¸½å·¥æ™‚",
              "items": [
                "7 å°æ™‚"
              ]
            }
          ],
          "children": []
        },
        {
          "id": "sec-tb-tracking",
          "title": "å¯¦ä½œé€²åº¦è¿½è¹¤",
          "summary": null,
          "blocks": [
            {
              "id": "blk-tb-tracking-table",
              "type": "table",
              "title": null,
              "content": "| çµ„ä»¶åç¨± | å°æ‡‰ Tasks | å¯¦ä½œç‹€æ…‹ | å®Œæˆåº¦ | å‚™è¨» |\n|----------|------------|--------|--------|------|\n| NotificationImageDownloader | TASK-002 | Done | 100% | å·²å¯¦ä½œå®Œæˆ |\n| NotificationContentModifier | TASK-003 | Done | 100% | å·²å¯¦ä½œå®Œæˆ |\n| NotificationService | TASK-001 | Done | 100% | å·²å¯¦ä½œå®Œæˆï¼ˆ123 è¡Œï¼‰|\n| Tuist å°ˆæ¡ˆé…ç½® | TASK-004 | Done | 100% | å·²å®Œæˆï¼ŒExtension target é…ç½®æˆåŠŸä¸¦ç·¨è­¯é€šé |\n| æ•´åˆæ¸¬è©¦ | TASK-005 | Done | 100% | å·²å®Œæˆå¯¦æ©Ÿæ¸¬è©¦ï¼Œæ‰€æœ‰æ¸¬è©¦é …ç›®é€šéï¼ˆ2025-10-01ï¼‰|\n\n---"
            }
          ],
          "children": []
        }
      ]
    },
    {
      "id": "sec-post-validation",
      "title": "å¯¦ä½œå¾Œé©—è­‰èˆ‡ç¸½çµ (Post-Implementation Validation & Summary)",
      "summary": null,
      "blocks": [],
      "children": [
        {
          "id": "sec-pv-completion",
          "title": "å¯¦ä½œå®Œæˆåº¦",
          "summary": null,
          "blocks": [
            {
              "id": "blk-pv-completion-code",
              "type": "list",
              "title": "ç¨‹å¼ç¢¼å¯¦ä½œ: 100% âœ…",
              "items": [
                "NotificationImageDownloader (105 lines)",
                "NotificationContentModifier (47 lines)",
                "NotificationService (123 lines)",
                "Tuist å°ˆæ¡ˆé…ç½®å®Œæˆ",
                "Bundle ID: `com.cardinalblue.magiceditor.notificationserviceextension`"
              ]
            },
            {
              "id": "blk-pv-completion-test",
              "type": "list",
              "title": "æ•´åˆæ¸¬è©¦: 50% ğŸ”„",
              "items": [
                "æ¸¬è©¦è¨ˆç•«å·²å®Œæˆ",
                "ç­‰å¾… Apple Developer Portal é…ç½®",
                "éœ€å¯¦æ©Ÿæ¸¬è©¦ç’°å¢ƒ"
              ]
            },
            {
              "id": "blk-pv-completion-total",
              "type": "list",
              "title": "ç¸½é€²åº¦: 90%",
              "items": [
                "ï¼ˆç¨‹å¼ç¢¼å®Œæˆï¼Œå¾…å¯¦æ©Ÿé©—è­‰ï¼‰"
              ]
            }
          ],
          "children": []
        },
        {
          "id": "sec-pv-acceptance",
          "title": "æŠ€è¡“é©—æ”¶",
          "summary": null,
          "blocks": [],
          "children": [
            {
              "id": "sec-pv-acceptance-done",
              "title": "å·²é©—æ”¶é …ç›® âœ…",
              "summary": null,
              "blocks": [
                {
                  "id": "blk-pv-acceptance-done-list",
                  "type": "list",
                  "title": null,
                  "items": [
                    "âœ… NotificationService æˆåŠŸè§£æ FCM payloadï¼ˆæ”¯æ´é›™æ ¼å¼ï¼‰",
                    "âœ… NotificationImageDownloader æ­£ç¢ºå”èª¿ Downloader å’Œ Modifier",
                    "âœ… HTTPS-only URL é©—è­‰æ©Ÿåˆ¶",
                    "âœ… 5 ç§’ timeout è¨­å®š",
                    "âœ… å¤±æ•—é™ç´šæ©Ÿåˆ¶ï¼ˆé€€å›ç´”æ–‡å­—é€šçŸ¥ï¼‰",
                    "âœ… 30 ç§’ç³»çµ±è¶…æ™‚è™•ç†",
                    "âœ… Extension target æˆåŠŸç·¨è­¯",
                    "âœ… æ‰€æœ‰ç¨‹å¼ç¢¼åŒ…å«è¿½æº¯è¨»è§£"
                  ]
                }
              ],
              "children": []
            },
            {
              "id": "sec-pv-acceptance-pending",
              "title": "å¾…é©—æ”¶é …ç›® â³",
              "summary": null,
              "blocks": [
                {
                  "id": "blk-pv-acceptance-pending-list",
                  "type": "list",
                  "title": null,
                  "items": [
                    "â³ å¯¦æ©Ÿæ¨æ’­åœ–ç‰‡é¡¯ç¤ºæ¸¬è©¦",
                    "â³ PNG/JPG/GIF æ ¼å¼æ”¯æ´é©—è­‰",
                    "â³ éŒ¯èª¤å ´æ™¯å¯¦æ©Ÿæ¸¬è©¦ï¼ˆHTTP URL, 404, è¶…æ™‚ï¼‰",
                    "â³ å‰æ™¯è¡Œç‚ºé©—è­‰",
                    "â³ FCM payload å¯¦éš›æ ¼å¼ç¢ºèªï¼ˆå¾…å¾Œç«¯æä¾›ï¼‰"
                  ]
                }
              ],
              "children": []
            }
          ]
        },
        {
          "id": "sec-pv-lessons",
          "title": "çŸ¥è­˜æ²‰æ¾±èˆ‡æ•™è¨“ (Lessons Learned)",
          "summary": null,
          "blocks": [],
          "children": [
            {
              "id": "sec-pv-lessons-debts",
              "title": "è¨­è¨ˆè² å‚µèˆ‡æŠ€è¡“å‚µå‹™",
              "summary": null,
              "blocks": [
                {
                  "id": "blk-pv-lessons-debts-list",
                  "type": "list",
                  "title": null,
                  "items": [
                    "**FCM Payload æ ¼å¼å¾…ç¢ºèª**: ç•¶å‰ä½¿ç”¨å‡è¨­æ ¼å¼å¯¦ä½œï¼Œéœ€å¾Œç«¯æä¾›å¯¦éš› payload ç¯„ä¾‹",
                    "**æ—¥èªŒæ©Ÿåˆ¶**: ä½¿ç”¨ print è€Œé os_logï¼Œæœªä¾†å¯çµ±ä¸€æ”¹ç‚ºçµæ§‹åŒ–æ—¥èªŒ",
                    "**Timeout å€¼ç¡¬ç·¨ç¢¼**: 5 ç§’ timeout å¯«æ­»åœ¨ç¨‹å¼ç¢¼ä¸­ï¼Œæœªä¾†å¯è€ƒæ…®å¯é…ç½®"
                  ]
                }
              ],
              "children": []
            },
            {
              "id": "sec-pv-lessons-design",
              "title": "ä½ä¼°èˆ‡éåº¦è¨­è¨ˆ",
              "summary": null,
              "blocks": [
                {
                  "id": "blk-pv-lessons-design-list",
                  "type": "list",
                  "title": null,
                  "items": [
                    "**Bundle ID æ ¼å¼**: åˆæœŸä½¿ç”¨å‹•æ…‹è®Šæ•¸ï¼Œå¾Œæ”¹ç‚ºç¡¬ç·¨ç¢¼ï¼ˆå¯¦éš›å•é¡Œè¼ƒé æœŸç°¡å–®ï¼‰",
                    "**æ‹†åˆ†è¨­è¨ˆæ­£ç¢º**: ä¸‰å€‹çµ„ä»¶ï¼ˆDownloader, Modifier, Serviceï¼‰æ‹†åˆ†å¾—å®œï¼Œåˆ©æ–¼æ¸¬è©¦å’Œç¶­è­·",
                    "**ç„¡éåº¦è¨­è¨ˆ**: å¯¦ä½œä¿æŒç°¡æ½”ï¼Œæœªå¼•å…¥ä¸å¿…è¦çš„è¤‡é›œåº¦"
                  ]
                }
              ],
              "children": []
            },
            {
              "id": "sec-pv-lessons-reusable",
              "title": "å¯å¾©ç”¨æ¨¡å¼/çµ„ä»¶",
              "summary": null,
              "blocks": [
                {
                  "id": "blk-pv-lessons-reusable-1",
                  "type": "list",
                  "title": "Notification Service Extension æ¶æ§‹æ¨¡å¼",
                  "items": [
                    "çµ„ä»¶æ‹†åˆ†: Downloader â†’ Modifier â†’ Service",
                    "éŒ¯èª¤è™•ç†: å¤±æ•—é™ç´šæ©Ÿåˆ¶",
                    "è¶…æ™‚ç®¡ç†: é›™å±¤ timeoutï¼ˆ5s ä¸‹è¼‰ + 30s ç³»çµ±ï¼‰"
                  ]
                },
                {
                  "id": "blk-pv-lessons-reusable-2",
                  "type": "list",
                  "title": "URLSession ä¸‹è¼‰è™•ç†æ¨¡å¼",
                  "items": [
                    "HTTPS-only é©—è­‰",
                    "Timeout æ§åˆ¶",
                    "æª”æ¡ˆæš«å­˜ç®¡ç†"
                  ]
                },
                {
                  "id": "blk-pv-lessons-reusable-3",
                  "type": "list",
                  "title": "UNNotificationAttachment å»ºç«‹æ¨¡å¼",
                  "items": [
                    "do-catch éŒ¯èª¤è™•ç†",
                    "å„ªé›…é™ç´š"
                  ]
                }
              ],
              "children": []
            }
          ]
        },
        {
          "id": "sec-pv-suggestions",
          "title": "å¾ŒçºŒå»ºè­°",
          "summary": null,
          "blocks": [],
          "children": [
            {
              "id": "sec-pv-suggestions-immediate",
              "title": "ç«‹å³è¡Œå‹•ï¼ˆå¯¦æ©Ÿæ¸¬è©¦å‰ï¼‰",
              "summary": null,
              "blocks": [
                {
                  "id": "blk-pv-suggestions-immediate-1",
                  "type": "list",
                  "title": "Apple Developer Portal é…ç½®",
                  "items": [
                    "å»ºç«‹ App ID: `com.cardinalblue.magiceditor.notificationserviceextension`",
                    "å•Ÿç”¨ Push Notifications capability",
                    "å»ºç«‹ Development Provisioning Profile"
                  ]
                },
                {
                  "id": "blk-pv-suggestions-immediate-2",
                  "type": "list",
                  "title": "å¾Œç«¯å”èª¿",
                  "items": [
                    "ç¢ºèª FCM payload å¯¦éš›æ ¼å¼",
                    "ç¢ºèªå¾Œç«¯ç™¼é€æ™‚å·²è¨­å®š `mutable-content: 1`",
                    "æä¾›æ¸¬è©¦ç”¨åœ–ç‰‡ URL"
                  ]
                }
              ],
              "children": []
            },
            {
              "id": "sec-pv-suggestions-testing",
              "title": "å¯¦æ©Ÿæ¸¬è©¦éšæ®µ âœ…",
              "summary": null,
              "blocks": [
                {
                  "id": "blk-pv-suggestions-testing-list",
                  "type": "list",
                  "title": null,
                  "items": [
                    "âœ… å®‰è£ App åˆ°æ¸¬è©¦è¨­å‚™",
                    "âœ… åŸ·è¡Œå®Œæ•´æ¸¬è©¦å¥—ä»¶ï¼ˆæ­£å¸¸ + éŒ¯èª¤å ´æ™¯ï¼‰",
                    "âœ… è¨˜éŒ„æ¸¬è©¦çµæœå’Œæˆªåœ–",
                    "âœ… æ›´æ–° TASK-005 æ¸¬è©¦è¦†è“‹æ¸…å–®"
                  ]
                },
                {
                  "id": "blk-pv-suggestions-results",
                  "type": "list",
                  "title": "æ¸¬è©¦çµæœ (2025-10-01)",
                  "items": [
                    "âœ… å¯¦æ©Ÿæ¨æ’­åœ–ç‰‡é¡¯ç¤ºæ¸¬è©¦é€šé",
                    "âœ… PNG/JPG/GIF æ ¼å¼æ”¯æ´é©—è­‰é€šé",
                    "âœ… éŒ¯èª¤å ´æ™¯å¯¦æ©Ÿæ¸¬è©¦é€šéï¼ˆHTTP URL, 404, è¶…æ™‚ï¼‰",
                    "âœ… å‰æ™¯/èƒŒæ™¯è¡Œç‚ºé©—è­‰é€šé",
                    "âœ… FCM payload å¯¦éš›æ ¼å¼ç¢ºèªé€šé"
                  ]
                }
              ],
              "children": []
            },
            {
              "id": "sec-pv-suggestions-future",
              "title": "æœªä¾†æ“´å……å»ºè­°",
              "summary": null,
              "blocks": [
                {
                  "id": "blk-pv-suggestions-future-list",
                  "type": "list",
                  "title": null,
                  "items": [
                    "**App Groups æ”¯æ´**: å¦‚éœ€èˆ‡ä¸» App å…±äº«åœ–ç‰‡å¿«å–",
                    "**é€šçŸ¥ Action æŒ‰éˆ•**: è‡ªè¨‚æ“ä½œæŒ‰éˆ•",
                    "**åœ–ç‰‡å¤§å°é©—è­‰**: é˜²æ­¢ä¸‹è¼‰éå¤§æª”æ¡ˆ",
                    "**é€²éšæ—¥èªŒ**: æ•´åˆ Firebase Analytics æˆ– Crashlytics"
                  ]
                }
              ],
              "children": []
            }
          ]
        },
        {
          "id": "sec-pv-summary",
          "title": "é–‹ç™¼æ•ˆç‡ç¸½çµ",
          "summary": null,
          "blocks": [
            {
              "id": "blk-pv-summary-hours",
              "type": "list",
              "title": "é ä¼°å·¥æ™‚",
              "items": [
                "7 å°æ™‚"
              ]
            },
            {
              "id": "blk-pv-summary-actual",
              "type": "list",
              "title": "å¯¦éš›å·¥æ™‚",
              "items": [
                "~3 å°æ™‚ï¼ˆç¨‹å¼ç¢¼å¯¦ä½œ + å¯¦æ©Ÿæ¸¬è©¦ + bug ä¿®å¾©ï¼‰"
              ]
            },
            {
              "id": "blk-pv-summary-reasons",
              "type": "list",
              "title": "æ•ˆç‡æå‡åŸå› ",
              "items": [
                "Task æ‹†åˆ†æ¸…æ™°ï¼Œç„¡ç›¸ä¾é˜»å¡",
                "ä½¿ç”¨ task-coding-agent ä¸¦è¡ŒåŸ·è¡Œ TASK-001~003",
                "Tuist é…ç½®å·²é å…ˆæº–å‚™",
                "SwiftLint è‡ªå‹•ä¿®æ­£ç¯€çœæ™‚é–“"
              ]
            },
            {
              "id": "blk-pv-summary-factors",
              "type": "list",
              "title": "é—œéµæˆåŠŸå› ç´ ",
              "items": [
                "Blueprint è¨­è¨ˆå®Œæ•´ï¼Œæ¸›å°‘è¿”å·¥",
                "çµ„ä»¶æ‹†åˆ†å¾—å®œï¼Œæ˜“æ–¼å¯¦ä½œ",
                "è¿½æº¯è¨»è§£å®Œæ•´ï¼Œä¾¿æ–¼æœªä¾†ç¶­è­·",
                "å¯¦æ©Ÿæ¸¬è©¦ç™¼ç¾ä¸¦ä¿®å¾© URL-encoded è·¯å¾‘å•é¡Œ"
              ]
            },
            {
              "id": "blk-pv-summary-timeline",
              "type": "list",
              "title": "å¯¦ä½œå®Œæˆæ™‚é–“ç·š",
              "items": [
                "2025-09-30: å®Œæˆ TASK-001~004 ç¨‹å¼ç¢¼å¯¦ä½œ",
                "2025-10-01: å®Œæˆ TASK-005 å¯¦æ©Ÿæ¸¬è©¦èˆ‡é©—è­‰",
                "2025-10-01: ä¿®å¾©æª”åè§£æ bug ä¸¦ç§»é™¤ debug logs"
              ]
            }
          ],
          "children": []
        },
        {
          "id": "sec-pv-deploy",
          "title": "ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²ç‹€æ…‹ âœ…",
          "summary": null,
          "blocks": [
            {
              "id": "blk-pv-deploy-prs",
              "type": "list",
              "title": "Pull Requests",
              "items": [
                "PR #377: iOS NotificationServiceExtension â†’ `dev` branch",
                "PR #378: Backend Push Notification System â†’ `dev` branch"
              ]
            },
            {
              "id": "blk-pv-deploy-checklist",
              "type": "list",
              "title": "éƒ¨ç½²æª¢æŸ¥æ¸…å–®",
              "items": [
                "âœ… ç¨‹å¼ç¢¼å¯¦ä½œå®Œæˆ",
                "âœ… æ‰€æœ‰æ¸¬è©¦é€šé",
                "âœ… SwiftLint é©—è­‰é€šé",
                "âœ… Apple Developer Portal é…ç½®å®Œæˆ",
                "âœ… Provisioning Profiles å»ºç«‹å®Œæˆ",
                "âœ… å¯¦æ©Ÿæ¸¬è©¦é©—è­‰å®Œæˆ",
                "âœ… æ–‡æª”æ›´æ–°å®Œæˆ"
              ]
            },
            {
              "id": "blk-pv-deploy-final",
              "type": "paragraph",
              "title": "åŠŸèƒ½å·²é”åˆ°ç”Ÿç”¢ç’°å¢ƒæ¨™æº–ï¼Œå¯ä»¥æº–å‚™ä¸Šç·šã€‚",
              "content": ""
            }
          ],
          "children": []
        }
      ]
    }
  ]
}