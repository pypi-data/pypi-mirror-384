name: Test UiPath Langchain

on:
  pull_request:
    types: [ opened, synchronize, reopened, labeled ]

jobs:
  test-uipath-langchain:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        python-version: [ "3.10", "3.11", "3.12", "3.13" ]
        os: [ ubuntu-latest, windows-latest ]

    permissions:
      contents: read

    # Only run if PR has the test:uipath-langchain label
    if: contains(github.event.pull_request.labels.*.name, 'test:uipath-langchain')

    steps:
      - name: Checkout uipath-python
        uses: actions/checkout@v4
        with:
          path: 'uipath-python'

      - name: Setup uv
        uses: astral-sh/setup-uv@v5

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Build uipath-python package
        run: |
          cd uipath-python
          uv build

      - name: Checkout uipath-langchain-python
        uses: actions/checkout@v4
        with:
          repository: 'UiPath/uipath-langchain-python'
          path: 'uipath-langchain-python'

      - name: Update uipath-python version
        shell: bash
        run: |
          cd uipath-langchain-python
          uv add ../uipath-python/dist/*.whl --dev

      - name: Run uipath-langchain tests
        run: |
          cd uipath-langchain-python
          uv sync
          uv run pytest

  discover-testcases:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    needs: [test-uipath-langchain]
    outputs:
      testcases: ${{ steps.discover.outputs.testcases }}
    steps:
      - name: Checkout uipath-langchain-python
        uses: actions/checkout@v4
        with:
          repository: 'UiPath/uipath-langchain-python'
          path: 'uipath-langchain-python'

      - name: Discover testcases
        id: discover
        run: |
          cd uipath-langchain-python

          # Find all testcase folders (excluding common folders like README, etc.)
          testcase_dirs=$(find testcases -maxdepth 1 -type d -name "*-*" | sed 's|testcases/||' | sort)

          echo "Found testcase directories:"
          echo "$testcase_dirs"

          # Convert to JSON array for matrix
          testcases_json=$(echo "$testcase_dirs" | jq -R -s -c 'split("\n")[:-1]')
          echo "testcases=$testcases_json" >> $GITHUB_OUTPUT

  run-uipath-langchain-integration-tests:
    runs-on: ubuntu-latest
    needs: [discover-testcases]
    permissions:
      contents: read
    strategy:
      matrix:
        testcase: ${{ fromJson(needs.discover-testcases.outputs.testcases) }}
        environment: [alpha, cloud]
        use_azure_chat: [true, false]
    steps:

      - name: Checkout uipath-python
        uses: actions/checkout@v4
        with:
          path: 'uipath-python'

      - name: Setup uv
        uses: astral-sh/setup-uv@v5

      - name: Build uipath-python package
        run: |
          cd uipath-python
          uv build

      - name: Checkout uipath-langchain-python
        uses: actions/checkout@v4
        with:
          repository: 'UiPath/uipath-langchain-python'
          path: 'uipath-langchain-python'

      - name: Copy wheel to uipath-langchain
        run: |
          mkdir -p uipath-langchain-python/wheels
          cp uipath-python/dist/*.whl uipath-langchain-python/wheels/

      - name: Update uipath-python version
        shell: bash
        run: |
          cd uipath-langchain-python
          WHL=$(ls wheels/*.whl | head -n1)
          WHL_NAME=$(basename "$WHL")
          echo "Using wheel: $WHL_NAME"
          sed -i "s|uipath>=.*|uipath @ file:///app/wheels/$WHL_NAME\",|" pyproject.toml

          if ! grep -q '\[tool.hatch.metadata\]' pyproject.toml; then
            echo -e '\n[tool.hatch.metadata]\nallow-direct-references = true' >> pyproject.toml
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          cd uipath-langchain-python
          echo "Building Docker image at $(date)"
          docker build -f testcases/Dockerfile \
            -t uipath-langchain-testbase:latest .
          echo "Docker image built at $(date)"

      - name: Run integration test
        env:
          ALPHA_TEST_CLIENT_ID: ${{ secrets.ALPHA_TEST_CLIENT_ID }}
          ALPHA_TEST_CLIENT_SECRET: ${{ secrets.ALPHA_TEST_CLIENT_SECRET }}
          ALPHA_BASE_URL: ${{ secrets.ALPHA_BASE_URL }}
          CLOUD_TEST_CLIENT_ID: ${{ secrets.CLOUD_TEST_CLIENT_ID }}
          CLOUD_TEST_CLIENT_SECRET: ${{ secrets.CLOUD_TEST_CLIENT_SECRET }}
          CLOUD_BASE_URL: ${{ secrets.CLOUD_BASE_URL }}
        run: |
          cd uipath-langchain-python

          testcase="${{ matrix.testcase }}"
          environment="${{ matrix.environment }}"
          use_azure_chat="${{ matrix.use_azure_chat }}"

          echo "Running testcase: $testcase"
          echo "Environment: $environment"
          echo "LLM: $( [ $use_azure_chat == "true" ] && echo "UiPathAzureChatOpenAI" || echo "UiPathChat" )"
          echo "USE_AZURE_CHAT: $use_azure_chat"

          if [ "$environment" == "alpha" ]; then
            CLIENT_ID=$ALPHA_TEST_CLIENT_ID
            CLIENT_SECRET=$ALPHA_TEST_CLIENT_SECRET
            BASE_URL=$ALPHA_BASE_URL
          else
            CLIENT_ID=$CLOUD_TEST_CLIENT_ID
            CLIENT_SECRET=$CLOUD_TEST_CLIENT_SECRET
            BASE_URL=$CLOUD_BASE_URL
          fi

          docker run --rm \
            -e CLIENT_ID="$CLIENT_ID" \
            -e CLIENT_SECRET="$CLIENT_SECRET" \
            -e BASE_URL="$BASE_URL" \
            -e USE_AZURE_CHAT="$use_azure_chat" \
            uipath-langchain-testbase:latest \
            bash "/app/testcases/$testcase/run.sh"

