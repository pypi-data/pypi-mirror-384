name: Test PR builds

on:
  pull_request:
    branches:
      - main
      - dev
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-and-test-linux:
    name: Test build on Linux (x86_64)
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install cibuildwheel==2.21.3

      - name: Build wheels
        env:
          CIBW_BUILD_VERBOSITY: 1
          CIBW_ARCHS_LINUX: x86_64
          # Only build latest Python version for PR testing
          CIBW_BUILD: cp313-manylinux_x86_64
          CIBW_BEFORE_ALL_LINUX: "curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y && source ~/.cargo/env"
          CIBW_ENVIRONMENT: "PATH=$HOME/.cargo/bin:$PATH"
          CIBW_TEST_COMMAND: "python -c 'import jieba_next;  from jieba_next import analyse;print(jieba_next.__version__)'"
        run: |
          python -m cibuildwheel --output-dir wheelhouse

      - name: Upload wheels artifact
        uses: actions/upload-artifact@v4
        with:
          name: test-wheels-linux
          path: wheelhouse/*.whl
          retention-days: 7

  build-and-test-windows:
    name: Test build on Windows
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install cibuildwheel==2.21.3

      - name: Build wheels
        env:
          CIBW_BUILD_VERBOSITY: 1
          # Only build latest Python version for PR testing
          CIBW_BUILD: cp313-*
          CIBW_BEFORE_ALL_WINDOWS: "curl --proto =https --tlsv1.2 -sSf https://win.rustup.rs/x86_64 -o rustup-init.exe && rustup-init.exe -y"
          CIBW_BEFORE_BUILD_WINDOWS: "pip install setuptools-rust"
          CIBW_TEST_COMMAND_WINDOWS: 'python -c "import jieba_next;  from jieba_next import analyse;print(jieba_next.__version__)"'
        run: |
          python -m cibuildwheel --output-dir wheelhouse

      - name: Upload wheels artifact
        uses: actions/upload-artifact@v4
        with:
          name: test-wheels-windows
          path: wheelhouse/*.whl
          retention-days: 7

  build-and-test-macos:
    name: Test build on macOS (Apple Silicon)
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install cibuildwheel==2.21.3

      - name: Build wheels
        env:
          CIBW_BUILD_VERBOSITY: 1
          # Only build latest Python version for PR testing
          CIBW_BUILD: cp313-*
          MACOSX_DEPLOYMENT_TARGET: "10.12"
          CIBW_BEFORE_ALL_MACOS: "curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y"
          CIBW_BEFORE_BUILD_MACOS: "source ~/.cargo/env && pip install setuptools-rust"
          CIBW_TEST_COMMAND: "python -c 'import jieba_next; from jieba_next import analyze; print(jieba_next.__version__)'"
        run: |
          python -m cibuildwheel --output-dir wheelhouse

      - name: Upload wheels artifact
        uses: actions/upload-artifact@v4
        with:
          name: test-wheels-macos
          path: wheelhouse/*.whl
          retention-days: 7

  test-sdist:
    name: Test source distribution build
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build sdist
        run: |
          python -m pip install --upgrade pip
          pip install build
          python -m build --sdist --outdir dist

      - name: Verify sdist
        run: |
          pip install dist/*.tar.gz
          python -c "import jieba_next; from jieba_next import analyse; print(f'Version: {jieba_next.__version__}')"

      - name: Upload sdist artifact
        uses: actions/upload-artifact@v4
        with:
          name: test-sdist
          path: dist/*.tar.gz
          retention-days: 7

  lint:
    name: Lint check
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff

      - name: Run ruff
        run: |
          ruff check .
          ruff format --check .
