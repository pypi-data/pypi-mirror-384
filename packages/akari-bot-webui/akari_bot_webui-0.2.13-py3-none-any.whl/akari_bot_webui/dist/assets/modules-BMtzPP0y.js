import{_ as U,c as h,e as r,w as o,a as i,A as F,d as m,t as n,E as $,L as j,n as z,aA as R,i as g,F as D,y as k,x as p,M as K,aC as C,f as u,u as O,o as a}from"./index-B83Nj5wy.js";import{_ as N}from"./VisibleEditor-C0Ev4ivA.js";import{E as A}from"./empty-CWpByPlA.js";import{E as H,a as q}from"./collapse-item-CBex9jK3.js";import{E as x}from"./card-DrdRfsqF.js";import{b as G,a as J,E as Q}from"./pagination-DR65BV4_.js";import{d as X}from"./select-DWPJjTK6.js";import{E as Y}from"./col-BQ0dJrnG.js";import{E as Z}from"./index-CIlHu57m.js";import"./form-item-BTA-ycNk.js";import"./_baseClone-BOzpZ_uO.js";import"./_initCloneObject-D0WUAqkw.js";import"./index-D5UIxO6G.js";import"./index-nma4EivO.js";import"./validator-r28DD-hG.js";import"./raf-BESGV2Sv.js";const ee={name:"ModulesManager",components:{VisibleEditor:N},data(){const{t:e}=O();return{modules:[],searchKeyword:"",loading:!1,showBaseModules:!1,helpDialogVisible:!1,helpDoc:null,activeSections:["commands","options","regexp"],currentPage:1,pageSize:10,moduleConfigDialogWidth:"90%",debounceTimer:null,configDialogVisible:!1,configModuleName:"",configContent:"",initialConfigContent:"",unsavedConfigChanges:!1,configNotFound:!1,t:e}},computed:{filteredModules(){let e=this.modules;return this.searchKeyword&&(e=e.filter(s=>s.bind_prefix.toLowerCase().includes(this.searchKeyword.toLowerCase()))),this.showBaseModules||(e=e.filter(s=>!s.base)),e},pagedModules(){const e=(this.currentPage-1)*this.pageSize,s=e+this.pageSize;return this.filteredModules.slice(e,s)},totalModules(){return this.filteredModules.length},hasAnyHelp(){return this.helpDoc?.desc||this.helpDoc?.commands?.args?.length>0||this.helpDoc?.commands?.options?.length>0||this.helpDoc?.regexp?.length>0}},mounted(){this.refreshData(),window.addEventListener("resize",this.updateModuleConfigDialogWidth),this.updateModuleConfigDialogWidth()},beforeUnmount(){window.removeEventListener("resize",this.updateModuleConfigDialogWidth)},watch:{configContent(e){this.unsavedConfigChanges=e!==this.initialConfigContent}},methods:{debouncedRefresh(){clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>this.refreshData(),300)},handleSizeChange(e){this.pageSize=e,this.currentPage=1},handleCurrentChange(e){this.currentPage=e},async refreshData(){this.loading=!0;try{const e=localStorage.getItem("language")||"zh_cn",s=await C.get("/api/modules",{params:{locale:e}});s.status===200&&s.data.modules&&(this.modules=Object.entries(s.data.modules).map(([d,f])=>{const l=f?._db_load!==!1;return{name:d,bind_prefix:f?.bind_prefix||d,desc:f?.desc||"",developers:f?.developers||[],loaded:l,base:f?.base===!0,...f}}).sort((d,f)=>d.name.localeCompare(f.name)))}catch(e){u.error(this.$t("message.error.fetch")+e.message)}finally{this.loading=!1}},async getRelatedModules(e){try{return(await C.get(`/api/module/${e}/related`)).data.modules||[]}catch{return u.error(this.$t("message.error.fetch")+error.message),[]}},async handleHelp(e){try{const s=localStorage.getItem("language")||"zh_cn",d=await C.get(`/api/module/${e.name}/helpdoc`,{params:{locale:s}});d.status===200&&(this.helpDoc=d.data,this.helpDialogVisible=!0)}catch(s){u.error(this.$t("message.error.fetch")+s.message)}},async handleReload(e){let s="";if(e.base)s=this.t("modules.confirm.message.reload.base");else{const d=await this.getRelatedModules(e.name);d.length===0?s=this.t("modules.confirm.message.reload"):s=this.t("modules.confirm.message.reload.extra",{modules:d.map(f=>this.t("format.quote",{msg:f})).join(this.t("format.delimiter"))})}try{await Z.confirm(s,this.t("confirm.warning"),{confirmButtonText:this.t("button.confirm"),cancelButtonText:this.t("button.cancel"),type:"warning"}),(await C.post(`/api/module/${e.name}/reload`)).status===204&&(u.success(this.t("modules.message.reload.success")),this.refreshData())}catch(d){if(d==="cancel"||d?.message==="cancel")return;d.response?.status===422?(u.error(this.t("modules.message.reload.error.failed")),this.refreshData()):u.error(this.$t("message.error.fetch")+d.message)}},async handleUnload(e){try{(await C.post(`/api/module/${e.name}/unload`)).status===204&&(u.success(this.t("modules.message.unload.success")),this.refreshData())}catch(s){s.response?.status===422?(u.error(this.t("modules.message.unload.error.failed")),this.refreshData()):u.error(this.$t("message.error.fetch")+s.message)}},async handleLoad(e){try{(await C.post(`/api/module/${e.name}/load`)).status===204&&(u.success(this.t("modules.message.load.success")),this.refreshData())}catch(s){s.response?.status===422?(u.error(this.t("modules.message.load.error.failed")),this.refreshData()):u.error(this.$t("message.error.fetch")+s.message)}},updateModuleConfigDialogWidth(){const e=window.innerWidth;if(e<1024)this.moduleConfigDialogWidth="90%";else{const s=e*.9-400;this.moduleConfigDialogWidth=`${s}px`}},async openConfigEditor(e){this.configModuleName=e._py_module_name,this.configDialogVisible=!0,this.unsavedConfigChanges=!1,this.configNotFound=!1;try{const s=await C.get(`/api/config/module_${this.configModuleName}.toml`);this.configContent=s.data.content,this.initialConfigContent=s.data.content}catch(s){s.response?.status===404?this.configNotFound=!0:(u.error(this.t("message.error.fetch")+s.message),this.configDialogVisible=!1)}},async applyConfig(){try{await C.put(`/api/config/module_${this.configModuleName}.toml`,{content:this.configContent}),u.success(this.t("config.message.save.success")),this.initialConfigContent=this.configContent,this.unsavedConfigChanges=!1,this.configDialogVisible=!1}catch(e){u.error(this.t("message.error.fetch")+e.message)}},resetConfigDialog(){this.configDialogVisible=!1,this.configModuleName="",this.configContent="",this.initialConfigContent="",this.unsavedConfigChanges=!1,this.configNotFound=!1}}},se={class:"header-container"},te={class:"filter-container"},le={class:"filter-item"},oe={style:{"margin-bottom":"15px"}},ie={class:"pagination-wrapper"},ne={key:0},ae={class:"help-code"},re={key:0},de={class:"help-code"},ue={key:0},me={class:"help-code"},ce={key:0};function ge(e,s,d,f,l,c){const b=$,B=j,S=Y,_=G,w=X,T=J,W=Q,V=x,v=H,L=q,M=A,E=K,I=N,P=R;return a(),h("div",null,[r(V,{class:"module-card",shadow:"never"},{default:o(()=>[i("div",se,[i("h3",null,[s[9]||(s[9]=i("i",{class:"mdi mdi-puzzle"},null,-1)),m(" "+n(e.$t("modules.title")),1)]),r(b,{onClick:c.refreshData,type:"primary",size:"small",disabled:l.loading,style:{float:"right","margin-left":"10px"}},{default:o(()=>[s[10]||(s[10]=i("i",{class:"mdi mdi-refresh"},null,-1)),m(" "+n(e.$t("button.refresh")),1)]),_:1},8,["onClick","disabled"])]),i("div",te,[r(S,{span:6},{default:o(()=>[i("div",le,[r(B,{modelValue:l.searchKeyword,"onUpdate:modelValue":s[0]||(s[0]=t=>l.searchKeyword=t),placeholder:e.$t("modules.input.module_name"),clearable:"",onInput:c.debouncedRefresh,"prefix-icon":e.Search},{prefix:o(()=>[...s[11]||(s[11]=[i("i",{class:"mdi mdi-magnify"},null,-1)])]),_:1},8,["modelValue","placeholder","onInput","prefix-icon"])])]),_:1})]),i("div",oe,[r(b,{type:"info",size:"small",onClick:s[1]||(s[1]=t=>l.showBaseModules=!l.showBaseModules)},{default:o(()=>[i("i",{class:z(l.showBaseModules?"mdi mdi-eye-off-outline":"mdi mdi-eye-outline")},null,2),m(" "+n(l.showBaseModules?e.$t("modules.button.hide_base"):e.$t("modules.button.show_base")),1)]),_:1})]),F((a(),g(T,{data:c.pagedModules,style:{width:"100%"},stripe:""},{default:o(()=>[r(_,{label:e.$t("modules.table.name"),"min-width":"140"},{default:o(({row:t})=>[i("span",{class:z({unloaded:!t.loaded})},n(t.bind_prefix),3)]),_:1},8,["label"]),r(_,{label:e.$t("modules.table.desc"),"min-width":"800"},{default:o(({row:t})=>[m(n(t.desc||"-"),1)]),_:1},8,["label"]),r(_,{label:e.$t("modules.table.developers"),"min-width":"400"},{default:o(({row:t})=>[(a(!0),h(D,null,k(t.developers,y=>(a(),g(w,{key:y,type:"info",style:{margin:"2px"}},{default:o(()=>[m(n(y),1)]),_:2},1024))),128))]),_:1},8,["label"]),r(_,{label:e.$t("session.table.status"),"min-width":"100"},{default:o(({row:t})=>[r(w,{type:t.base?"warning":t.loaded?"success":"danger"},{default:o(()=>[m(n(t.base?e.$t("modules.tag.base"):t.loaded?e.$t("modules.tag.loaded"):e.$t("modules.tag.unloaded")),1)]),_:2},1032,["type"])]),_:1},8,["label"]),r(_,{label:e.$t("table.operation"),"min-width":"420"},{default:o(({row:t})=>[r(b,{size:"small",type:"info",onClick:y=>c.handleHelp(t)},{default:o(()=>[s[12]||(s[12]=i("i",{class:"mdi mdi-help-circle-outline"},null,-1)),m(" "+n(e.$t("modules.button.helpdoc")),1)]),_:1},8,["onClick"]),t.base?p("",!0):(a(),g(b,{key:0,size:"small",type:"primary",onClick:y=>c.openConfigEditor(t)},{default:o(()=>[s[13]||(s[13]=i("i",{class:"mdi mdi-cog"},null,-1)),m(" "+n(e.$t("modules.button.config")),1)]),_:1},8,["onClick"])),!t.base&&t.loaded?(a(),g(b,{key:1,size:"small",type:"warning",onClick:y=>c.handleUnload(t)},{default:o(()=>[s[14]||(s[14]=i("i",{class:"mdi mdi-puzzle-remove"},null,-1)),m(" "+n(e.$t("modules.button.unload")),1)]),_:1},8,["onClick"])):p("",!0),!t.base&&!t.loaded?(a(),g(b,{key:2,size:"small",type:"success",onClick:y=>c.handleLoad(t)},{default:o(()=>[s[15]||(s[15]=i("i",{class:"mdi mdi-puzzle-plus"},null,-1)),m(" "+n(e.$t("modules.button.load")),1)]),_:1},8,["onClick"])):p("",!0),r(b,{size:"small",type:"danger",onClick:y=>c.handleReload(t)},{default:o(()=>[s[16]||(s[16]=i("i",{class:"mdi mdi-reload"},null,-1)),m(" "+n(e.$t("modules.button.reload")),1)]),_:1},8,["onClick"])]),_:1},8,["label"])]),_:1},8,["data"])),[[P,l.loading]]),i("div",ie,[c.totalModules>0?(a(),g(W,{key:0,background:"",layout:"prev, pager, next","current-page":l.currentPage,"onUpdate:currentPage":s[2]||(s[2]=t=>l.currentPage=t),"page-size":l.pageSize,total:c.totalModules,style:{"margin-top":"20px"},onCurrentChange:e.handlePageChange},null,8,["current-page","page-size","total","onCurrentChange"])):p("",!0)])]),_:1}),r(E,{modelValue:l.helpDialogVisible,"onUpdate:modelValue":s[5]||(s[5]=t=>l.helpDialogVisible=t),title:e.$t("modules.helpdoc.title",{module:l.helpDoc?.module_name}),width:"600px"},{footer:o(()=>[r(b,{onClick:s[4]||(s[4]=t=>l.helpDialogVisible=!1)},{default:o(()=>[m(n(e.$t("button.close")),1)]),_:1})]),default:o(()=>[l.helpDoc?(a(),h("div",ne,[c.hasAnyHelp?(a(),g(L,{key:0,modelValue:l.activeSections,"onUpdate:modelValue":s[3]||(s[3]=t=>l.activeSections=t)},{title:o(()=>[i("b",null,n(e.$t("modules.helpdoc.subtitle.desc")),1)]),default:o(()=>[i("p",null,n(l.helpDoc.desc),1),l.helpDoc.commands?.args?.length?(a(),g(v,{key:0,name:"commands"},{title:o(()=>[i("b",null,n(e.$t("modules.helpdoc.subtitle.command")),1)]),default:o(()=>[i("ul",null,[(a(!0),h(D,null,k(l.helpDoc.commands.args,t=>(a(),h("li",{key:t.args},[i("code",ae,n(t.args),1),t.desc?(a(),h("span",re," - "+n(t.desc),1)):p("",!0)]))),128))])]),_:1})):p("",!0),l.helpDoc.commands?.options?.length?(a(),g(v,{key:1,name:"options"},{title:o(()=>[i("b",null,n(e.$t("modules.helpdoc.subtitle.option")),1)]),default:o(()=>[i("ul",null,[(a(!0),h(D,null,k(l.helpDoc.commands.options,t=>(a(),h("li",{key:Object.keys(t)[0]},[i("code",de,n(Object.keys(t)[0]),1),Object.values(t)[0]?(a(),h("span",ue," - "+n(Object.values(t)[0]),1)):p("",!0)]))),128))])]),_:1})):p("",!0),l.helpDoc.regexp?.length?(a(),g(v,{key:2,name:"regexp"},{title:o(()=>[i("b",null,n(e.$t("modules.helpdoc.subtitle.regex")),1)]),default:o(()=>[i("ul",null,[(a(!0),h(D,null,k(l.helpDoc.regexp,t=>(a(),h("li",{key:t.pattern},[i("code",me,n(t.pattern),1),t.desc?(a(),h("span",ce," - "+n(t.desc),1)):p("",!0)]))),128))])]),_:1})):p("",!0)]),_:1},8,["modelValue"])):(a(),g(M,{key:1,description:e.$t("modules.helpdoc.none")},null,8,["description"]))])):p("",!0)]),_:1},8,["modelValue","title"]),r(E,{modelValue:l.configDialogVisible,"onUpdate:modelValue":s[8]||(s[8]=t=>l.configDialogVisible=t),title:e.$t("modules.config.title",{module:l.configModuleName}),width:l.moduleConfigDialogWidth,"close-on-press-escape":!1,"close-on-click-modal":!1,onClose:c.resetConfigDialog},{footer:o(()=>[r(b,{onClick:s[7]||(s[7]=t=>l.configDialogVisible=!1)},{default:o(()=>[m(n(e.$t("button.cancel")),1)]),_:1}),r(b,{type:"primary",onClick:c.applyConfig,disabled:!l.unsavedConfigChanges},{default:o(()=>[m(n(e.$t("button.apply")),1)]),_:1},8,["onClick","disabled"])]),default:o(()=>[l.configNotFound?(a(),g(V,{key:0,shadow:"never"},{default:o(()=>[r(M,{description:e.$t("modules.config.none")},null,8,["description"])]),_:1})):l.configDialogVisible?(a(),g(I,{key:1,modelValue:l.configContent,"onUpdate:modelValue":s[6]||(s[6]=t=>l.configContent=t),ref:"visibleEditor"},null,8,["modelValue"])):p("",!0)]),_:1},8,["modelValue","title","width","onClose"])])}const Be=U(ee,[["render",ge],["__scopeId","data-v-faf48ac0"]]);export{Be as default};
