name: "main"

on:
  workflow_dispatch:
  push:

permissions:
  id-token: write
  contents: read
  statuses: write

jobs:
  format:
    name: Format
    runs-on: [self-hosted, Linux]
    continue-on-error: true
    env:
      COLUMNS: 120
    steps:
    - uses: imandra-ai/imandra-build-config/actions/self-hosted-linux-runner-setup-ssh@46c4c21f5e783fc4b9bc172cf900a5f62ea285bf
    - uses: actions/checkout@v4
    - name: Checkout submodules
      run: git submodule update --init -j 8 --recursive
    - uses: rrbutani/use-nix-shell-action@v1
      with:
        extraNixOptions: --impure
    - name: Install dependencies
      run: uv sync
    - name: Run format
      run: make cicd-format

  lint:
    name: Lint
    runs-on: [self-hosted, Linux]
    continue-on-error: true
    env:
      COLUMNS: 120
    steps:
    - uses: imandra-ai/imandra-build-config/actions/self-hosted-linux-runner-setup-ssh@46c4c21f5e783fc4b9bc172cf900a5f62ea285bf
    - uses: actions/checkout@v4
    - name: Checkout submodules
      run: git submodule update --init -j 8 --recursive
    - uses: rrbutani/use-nix-shell-action@v1
      with:
        extraNixOptions: --impure
    - name: Install dependencies
      run: uv sync
    - name: Run lint
      run: make cicd-lint

  type-check:
    name: Type Check
    runs-on: [self-hosted, Linux]
    continue-on-error: true
    env:
      COLUMNS: 120
    steps:
    - uses: imandra-ai/imandra-build-config/actions/self-hosted-linux-runner-setup-ssh@46c4c21f5e783fc4b9bc172cf900a5f62ea285bf
    - uses: actions/checkout@v4
    - name: Checkout submodules
      run: git submodule update --init -j 8 --recursive
    - uses: rrbutani/use-nix-shell-action@v1
      with:
        extraNixOptions: --impure
    - name: Install dependencies
      run: uv sync
    - name: Run type check
      run: make cicd-type-check

  tests:
    name: Test
    runs-on: [self-hosted, Linux]
    continue-on-error: true
    env:
      COLUMNS: 120
    steps:
    - uses: imandra-ai/imandra-build-config/actions/self-hosted-linux-runner-setup-ssh@46c4c21f5e783fc4b9bc172cf900a5f62ea285bf
    - uses: actions/checkout@v4
    - name: Checkout submodules
      run: git submodule update --init -j 8 --recursive
    - uses: rrbutani/use-nix-shell-action@v1
      with:
        extraNixOptions: --impure
    - name: Install dependencies
      run: uv sync
    - name: Run tests
      run: make cicd-test