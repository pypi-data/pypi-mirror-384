<!DOCTYPE html>

<head>
    <script>
        var MY_GRAPH_DATA = {{ graph_data | tojson(indent = 4) }};
    </script>
    {% raw %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.23.0/cytoscape.min.js"></script>
    <script src="https://unpkg.com/webcola@3.4.0/WebCola/cola.min.js"></script>
    <script src="https://unpkg.com/cytoscape-cola@2.5.1/cytoscape-cola.js"></script>
    <style>
        body {
            font-family: helvetica neue, helvetica, liberation sans, arial, sans-serif;
            font-size: 12px;
            margin: 0;
            padding: 0;
        }

        #search-container {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        #search-input {
            padding: 5px 10px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 14px;
            width: 200px;
        }

        #search-results {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
            background: white;
            display: none;
        }

        .search-result-item {
            padding: 5px 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .search-result-item:hover {
            background-color: #f0f0f0;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        #clear-search, #reset-zoom {
            margin-left: 5px;
            padding: 5px 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        #clear-search:hover, #reset-zoom:hover {
            background: #0056b3;
        }

        #cy {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            right: 0;
            z-index: 1;
        }

        h1 {
            font-size: 1em;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div id="search-container">
        <input type="text" id="search-input" placeholder="Search nodes by name..." />
        <button id="clear-search">Clear</button>
        <button id="reset-zoom">Reset Zoom</button>
        <div id="search-results"></div>
    </div>
    <div id="cy"></div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            console.log(JSON.stringify(MY_GRAPH_DATA));
            var cy = window.cy = cytoscape({
                container: document.getElementById('cy'),
                autounselectify: true,
                boxSelectionEnabled: false,
                layout: {
                    name: 'cola'
                },
                style: [
                    {
                        selector: 'node',
                        css: {
                            'label': 'data(label)',
                            'color': 'black',
                            'width': 'data(size)',
                            'height': 'data(size)',
                            'background-color': 'blue',
                            'text-halign': 'center',
                            'text-valign': 'top',
                            'font-size': 'data(font_size)',
                            'content': 'data(content)'
                        }
                    },
                    {
                        selector: 'node.highlighted',
                        css: {
                            'background-color': '#ff6b6b',
                            'border-width': 3,
                            'border-color': '#ff0000',
                            'color': 'white'
                        }
                    },
                    {
                        selector: 'node.dimmed',
                        css: {
                            'background-color': '#cccccc',
                            'opacity': 0.3
                        }
                    },
                    {
                        selector: 'node:parent',
                        css: {
                            'label': 'data(label)',
                            'background-opacity': 0.1
                        }
                    },
                    {
                        selector: 'edge',
                        css: {
                            'width': 1,
                        }
                    },
                    {
                        selector: 'edge.highlighted',
                        css: {
                            'width': 1,
                            'line-color': '#ff6b6b',
                            'target-arrow-color': '#ff6b6b',
                            'source-arrow-color': '#ff6b6b',
                            'opacity': 1
                        }
                    },
                    {
                        selector: 'edge.dimmed',
                        css: {
                            'opacity': 0.2
                        }
                    }
                ],
                elements: MY_GRAPH_DATA,
                zoomingEnabled: true
            });

            // Search functionality
            const searchInput = document.getElementById('search-input');
            const searchResults = document.getElementById('search-results');
            const clearButton = document.getElementById('clear-search');
            const resetZoomButton = document.getElementById('reset-zoom');
            let currentMatches = [];

            function getAllNodes() {
                return cy.nodes().filter(function(node) {
                    return !node.isParent();
                });
            }

            function searchNodes(query) {
                if (!query || query.trim() === '') {
                    return [];
                }

                const lowerQuery = query.toLowerCase();
                return getAllNodes().filter(function(node) {
                    const label = node.data('label') || '';
                    const content = node.data('content') || '';
                    const id = node.data('id') || '';

                    return label.toLowerCase().includes(lowerQuery) ||
                           content.toLowerCase().includes(lowerQuery) ||
                           id.toLowerCase().includes(lowerQuery);
                });
            }

            function highlightNodes(nodes) {
                // Clear previous highlights
                cy.nodes().removeClass('highlighted dimmed');
                cy.edges().removeClass('highlighted dimmed');

                if (nodes.length === 0) {
                    return;
                }

                // Highlight matching nodes
                nodes.addClass('highlighted');

                // Get all edges connected to the highlighted nodes
                const connectedEdges = nodes.connectedEdges();
                connectedEdges.addClass('highlighted');

                // Dim non-matching nodes and edges
                getAllNodes().difference(nodes).addClass('dimmed');
                cy.edges().difference(connectedEdges).addClass('dimmed');

                // Center on first match if there are results
                if (nodes.length > 0) {
                    cy.center(nodes[0]);
                    cy.zoom(1.5);
                }
            }

            function clearSearch() {
                searchInput.value = '';
                searchResults.style.display = 'none';
                cy.nodes().removeClass('highlighted dimmed');
                cy.edges().removeClass('highlighted dimmed');
                cy.fit();
                currentMatches = [];
            }

            function updateSearchResults(matches) {
                searchResults.innerHTML = '';

                if (matches.length === 0) {
                    searchResults.style.display = 'none';
                    return;
                }

                searchResults.style.display = 'block';

                matches.forEach(function(node, index) {
                    const item = document.createElement('div');
                    item.className = 'search-result-item';
                    item.textContent = node.data('label') || node.data('id') || 'Unnamed';

                    item.addEventListener('click', function() {
                        cy.center(node);
                        cy.zoom(2);
                        searchResults.style.display = 'none';
                    });

                    searchResults.appendChild(item);
                });
            }

            searchInput.addEventListener('input', function() {
                const query = this.value;
                currentMatches = searchNodes(query);
                highlightNodes(currentMatches);
                updateSearchResults(currentMatches);
            });

            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    clearSearch();
                }
            });

            clearButton.addEventListener('click', clearSearch);

            resetZoomButton.addEventListener('click', function() {
                cy.fit();
                cy.center();
            });

            // Hide search results when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('#search-container')) {
                    searchResults.style.display = 'none';
                }
            });
        });
    </script>
</body>

</html>

{% endraw %}
