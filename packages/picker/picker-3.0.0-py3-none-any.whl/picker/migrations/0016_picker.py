# Generated by Django 5.2.6 on 2024-10-01 12:00

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models
from django.db.models import F


def create_pickers(apps, schema_editor):
    app, user_model = settings.AUTH_USER_MODEL.rsplit(".", 1)
    User = apps.get_model(app, user_model)
    Picker = apps.get_model("picker", "Picker")

    users = list(User.objects.values_list("id", "username", "is_active"))
    data = [
        Picker(id=id, name=username, is_active=is_active, user_id=id)
        for id, username, is_active in users
    ]

    Picker.objects.bulk_create(data)


def switch_to_picker(apps, schema_editor):
    for model_name in ["PickerFavorite", "PickSet", "PickerMembership"]:
        model = apps.get_model("picker", model_name)
        model.objects.update(picker_id=F("user_id"))
        model.objects.update(user=None)

        if model_name == "PickSet":
            model.objects.filter(strategy="USER").update(strategy="PICK")


class Migration(migrations.Migration):
    dependencies = [
        ("picker", "0015_alter_for_big_int"),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.AlterField(
            model_name="league",
            name="logo",
            field=models.ImageField(blank=True, null=True, upload_to="picker/logos"),
        ),
        migrations.AlterField(
            model_name="pickerfavorite",
            name="user",
            field=models.ForeignKey(
                blank=True,
                default=None,
                null=True,
                on_delete=django.db.models.deletion.CASCADE,
                to=settings.AUTH_USER_MODEL,
            ),
        ),
        migrations.AlterField(
            model_name="pickermembership",
            name="user",
            field=models.ForeignKey(
                blank=True,
                default=None,
                null=True,
                on_delete=django.db.models.deletion.CASCADE,
                to=settings.AUTH_USER_MODEL,
            ),
        ),
        migrations.AlterField(
            model_name="pickset",
            name="strategy",
            field=models.CharField(
                choices=[
                    ("PICK", "Picker"),
                    ("RAND", "Random"),
                    ("HOME", "Home Team"),
                    ("BEST", "Best Record"),
                ],
                default="PICK",
                max_length=4,
            ),
        ),
        migrations.AlterField(
            model_name="pickset",
            name="user",
            field=models.ForeignKey(
                blank=True,
                default=None,
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                to=settings.AUTH_USER_MODEL,
            ),
        ),
        migrations.AlterField(
            model_name="team",
            name="logo",
            field=models.ImageField(blank=True, null=True, upload_to="picker/logos"),
        ),
        migrations.CreateModel(
            name="Picker",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
                    ),
                ),
                ("name", models.CharField(max_length=50, unique=True)),
                ("is_active", models.BooleanField()),
                (
                    "user",
                    models.OneToOneField(
                        blank=True,
                        null=True,
                        on_delete=django.db.models.deletion.SET_NULL,
                        related_name="picker",
                        to=settings.AUTH_USER_MODEL,
                    ),
                ),
                ("autopick_enabled", models.BooleanField(default=False)),
            ],
        ),
        migrations.AlterUniqueTogether(
            name="pickset",
            unique_together=set(),
        ),
        migrations.AddField(
            model_name="pickerfavorite",
            name="picker",
            field=models.ForeignKey(
                blank=True,
                default=None,
                null=True,
                on_delete=django.db.models.deletion.CASCADE,
                related_name="picker_favorites",
                to="picker.picker",
            ),
        ),
        migrations.AddField(
            model_name="pickermembership",
            name="picker",
            field=models.ForeignKey(
                blank=True,
                default=None,
                null=True,
                on_delete=django.db.models.deletion.CASCADE,
                related_name="picker_memberships",
                to="picker.picker",
            ),
        ),
        migrations.AddField(
            model_name="pickset",
            name="picker",
            field=models.ForeignKey(
                blank=True,
                default=None,
                null=True,
                on_delete=django.db.models.deletion.CASCADE,
                related_name="picksets",
                to="picker.picker",
            ),
        ),
        migrations.AlterUniqueTogether(
            name="pickset",
            unique_together={("picker", "gameset")},
        ),
        migrations.RunPython(create_pickers),
        migrations.RunPython(switch_to_picker),
        migrations.AlterField(
            model_name="league",
            name="logo",
            field=models.ImageField(blank=True, null=True, upload_to="picker/logos/nfl"),
        ),
        migrations.AlterField(
            model_name="team",
            name="logo",
            field=models.ImageField(blank=True, null=True, upload_to="picker/logos/nfl"),
        ),
    ]
