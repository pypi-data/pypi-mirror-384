#!/bin/sh
set -e

if [ -z "$PYTEST" ]; then
    PYTEST=pytest
fi


COV_PKG_OPTIONS="--cov hgext3rd.hgitaly --cov hgitaly"
if test -n "$GITALY_INSTALL_DIR"; then
    COV_PKG_OPTIONS="$COV_PKG_OPTIONS --cov tests_with_gitaly"
fi

set -u

$PYTEST --doctest-modules \
       $COV_PKG_OPTIONS \
       --cov-config=.coveragerc \
       --ignore rust \
       --cov-fail-under 100 \
       --ignore rust \
       --log-level DEBUG \
       --cov-report term-missing \
       -v $@
