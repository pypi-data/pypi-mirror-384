#!/usr/bin/env ruby
# Derived from Gitaly support script (MIT license):
#     _support/generate-proto-ruby
# with changes copyright 2021 Georges Racinet <georges.racinet@octobus.net>

require 'erb'
require 'fileutils'
require 'pathname'

require_relative 'run.rb'

PROTO_INCLUDE = '../protos'
PROTO_FILES = Dir[File.join(PROTO_INCLUDE, 'mercurial-*.proto')].sort.map { |f| File.absolute_path(f) }
RUBY_PREFIX = 'lib'
RUBY_VERSION_FILE = 'hgitaly/version.rb'

def main
  ruby_lib_gitaly = File.join(RUBY_PREFIX, 'hgitaly')
  FileUtils.rm(Dir[File.join(ruby_lib_gitaly, '**/*_pb.rb')])
  FileUtils.mkdir_p(ruby_lib_gitaly)

  Dir.chdir(RUBY_PREFIX) do
    # Using an absolute path make sure the prefixes match, or the passed in file
    # locations. `protoc` requires this.
    proto_include_abs = File.absolute_path(File.join('..', PROTO_INCLUDE))

    run!(%W[bundle exec grpc_tools_ruby_protoc -I #{proto_include_abs} --ruby_out=../#{ruby_lib_gitaly} --grpc_out=../#{ruby_lib_gitaly}] + PROTO_FILES)
  end

  write_ruby_version
  write_ruby_requires
end

def write_ruby_requires
  requires = Dir.chdir(RUBY_PREFIX) { Dir['hgitaly/*_services_pb.rb'] }.sort
  abort "No auto-generated Ruby service files found" if requires.empty?
  requires.unshift(RUBY_VERSION_FILE)
  gem_root = File.join(RUBY_PREFIX, 'hgitaly.rb')
  gem_root_template = ERB.new <<~EOT
    # This file is generated by #{File.basename($0)}. Do not edit.
    $:.unshift(File.expand_path('../hgitaly', __FILE__))
    <% requires.each do |f| %>
    require '<%= f.sub(/\.rb$/, '') %>'
    <% end %>
  EOT
  open(gem_root, 'w') { |f| f.write(gem_root_template.result(binding)) }
end

def write_ruby_version
  version = File.read('../hgitaly/VERSION').chomp

  Dir.chdir(RUBY_PREFIX) do
    version_ruby = <<~EOT
    # This file is generated by #{File.basename($0)}. Do not edit.
    module Hgitaly
      VERSION = '#{version}'
    end
    EOT
    File.write(RUBY_VERSION_FILE, version_ruby)
  end
end

main
