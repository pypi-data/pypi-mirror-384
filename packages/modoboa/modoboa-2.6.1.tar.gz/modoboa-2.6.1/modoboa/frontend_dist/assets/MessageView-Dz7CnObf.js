import{b as j,u as P,n as W,h as p,i as x,B as J,g as A,l as f,e as M,a as s,t as _,f as u,c as y,m as b,w as n,F as R,s as B,q as K,o as i,k as H,j as E}from"./index-D9OmnhdE.js";import{u as O}from"./amavis-BOgLfXLH.js";import{_ as X}from"./ConfirmDialog-CnWM982L.js";import{a as h}from"./amavis-w7390k8i.js";import{V as Y}from"./VToolbar-CILwTR5O.js";import{V as Z}from"./VAlert-BWUQvs3i.js";import{V as k,c as ee}from"./VAvatar-Wz1UmZ2b.js";import{V as ae}from"./VMenu-BPG7b7dT.js";import{V as te,a as N}from"./forwardRefs-GE5Osi9V.js";import{a as z,V as se}from"./VRow-DGPh2Qmm.js";import{a as le,V as re}from"./VRadioGroup-BdEZyWNi.js";import"./permissions-B-P8ks2E.js";import"./parameters-DlTg3gyZ.js";import"./VCard-BrQzTMsm.js";import"./tag-jImTUiWx.js";import"./VSpacer-Pa16wvUF.js";/* empty css              */import"./VDialog-BF9xR7BQ.js";import"./VProgressCircular-Bdwj7JuI.js";import"./ssrBoot-DaeAGyhc.js";import"./VSelectionControl-BIXXUgD4.js";import"./VInput-ssnfbpwr.js";const ie={class:"text-h5 ml-4"},ne={class:"bg-white rounded-lg pa-4 position-relative mt-6 h-100"},oe={key:0},ue={key:1},me={class:"pa-4 bg-grey-lighten-3 rounded"},ce=["innerHTML"],Ne={__name:"MessageView",async setup(de){let o,V;const e=J(),C=K(),{$gettext:t}=j(),q=P(),{displayNotification:w}=W(),m=p(null),v=p(null),L=p(null),r=p(!1),c=p(null),U=x(()=>m.value?m.value:c.value.headers),d=x(()=>{var a;return((a=e.query)==null?void 0:a.secret_id)!==void 0});if(d.value)p(!1);else{const{manualLearningEnabled:a}=([o,V]=A(()=>O()),o=await o,V(),o)}const D=()=>{C.go(-1)},T=async()=>{if(m.value){m.value=null;return}r.value=!0;try{const a=await h.getMessageHeaders(e.params.mailid,e.params.rcpt,e.query.secret_id);m.value=a.data.headers}finally{r.value=!1}},F=async()=>{r.value=!0;const a={rcpt:e.params.rcpt,mailid:e.params.mailid};d.value&&(a.secret_id=e.query.secret_id);try{(await h.releaseMessage(e.params.mailid,a)).data.status==="pending"?w({msg:t("Release request sent")}):w({msg:t("Message released")})}finally{r.value=!1}},I=async()=>{r.value=!0;const a={rcpt:e.params.rcpt,mailid:e.params.mailid};d.value&&(a.secret_id=e.query.secret_id);try{await h.deleteMessage(e.params.mailid,a),w({msg:t("Message deleted")}),d.value||C.push({name:"QuarantineView"})}finally{r.value=!1}},S=async(a,g)=>{manualLearningEnabled.value&&q.authUser.role!==E.USER&&(v.value=q.authUser.role===E.SUPER_ADMIN?"global":"domain",await L.value.open(t("Learning database"),t("Which database should be used for this learning:"),{width:600,noconfirm:!0})),r.value=!0;const l={type:a,selection:[{rcpt:e.params.rcpt,mailid:e.params.mailid}]};v.value&&(l.database=v.value);try{await h.markMessageSelection(l),w({msg:g})}finally{r.value=!1}},G=async()=>{await S("spam",t("Message marked as spam"))},Q=async()=>{await S("ham",t("Message marked as non-spam"))},$=([o,V]=A(()=>h.getMessageContent(e.params.mailid,e.params.rcpt,e.query.secret_id)),o=await o,V(),o);return c.value=$.data,(a,g)=>(i(),f("div",null,[M("div",ie,_(u(t)("Quarantined message")),1),M("div",ne,[s(Y,{color:"white"},{default:n(()=>[d.value?b("",!0):(i(),y(k,{key:0,icon:"mdi-arrow-left",size:"small",variant:"flat",onClick:D})),s(k,{class:"ml-2",color:"success",variant:"tonal",icon:"mdi-check",size:"small",title:u(t)("Release message"),loading:r.value,onClick:F},null,8,["title","loading"]),s(k,{class:"ml-2",color:"error",variant:"tonal",icon:"mdi-trash-can",size:"small",title:u(t)("Delete message"),loading:r.value,onClick:I},null,8,["title","loading"]),d.value?b("",!0):(i(),f(R,{key:1},[a.manualLearningEnabled?(i(),y(k,{key:0,class:"ml-2",variant:"tonal",icon:"",size:"small"},{default:n(()=>[s(ee,{icon:"mdi-cog"}),s(ae,{activator:"parent"},{default:n(()=>[s(te,{density:"compact"},{default:n(()=>[s(N,{title:u(t)("Mark as spam"),onClick:G},null,8,["title"]),s(N,{title:u(t)("Mark as non-spam"),onClick:Q},null,8,["title"])]),_:1})]),_:1})]),_:1})):b("",!0)],64)),s(k,{class:"ml-2",variant:"tonal",size:"small",loading:r.value,onClick:T},{default:n(()=>[m.value?(i(),f("span",ue,_(u(t)("Hide full headers")),1)):(i(),f("span",oe,_(u(t)("View full headers")),1))]),_:1},8,["loading"])]),_:1}),c.value.qtype?(i(),y(Z,{key:0,title:c.value.qtype,text:c.value.qreason,type:"error",variant:"tonal",class:"mb-4",density:"compact"},null,8,["title","text"])):b("",!0),M("div",me,[(i(!0),f(R,null,B(U.value,l=>(i(),y(se,{key:l.name,"no-gutters":""},{default:n(()=>[s(z,{cols:"2",class:"font-weight-bold"},{default:n(()=>[H(_(l.name),1)]),_:2},1024),s(z,{cols:"10"},{default:n(()=>[H(_(l.value),1)]),_:2},1024)]),_:2},1024))),128))]),M("div",{class:"mt-4",innerHTML:c.value.body},null,8,ce)]),s(u(X),{ref_key:"learningRecipientRef",ref:L},{default:n(()=>[s(le,{modelValue:v.value,"onUpdate:modelValue":g[0]||(g[0]=l=>v.value=l),class:"mt-4","hide-details":""},{default:n(()=>[(i(!0),f(R,null,B(a.learningRecipients,l=>(i(),y(re,{key:l.value,value:l.value,label:l.title},null,8,["value","label"]))),128))]),_:1},8,["modelValue"])]),_:1},512)]))}};export{Ne as default};
