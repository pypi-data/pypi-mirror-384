name: Tests & Checks

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]
  schedule:
    - cron: "0 8 * * 1" # Weekly on Monday at 08:00 UTC

permissions:
  contents: read
  pull-requests: read

env:
  default-python: "3.13"
  FORCE_COLOR: "1"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"

jobs:
  test:
    name: üß™ Test Python ${{ matrix.python-version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        python-version: ["3.10", "3.11", "3.12", "3.13"]
        include:
          - os: windows-latest
            python-version: "3.13"
          - os: macos-latest
            python-version: "3.13"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install Nox
        run: |
          echo "::group::Installing Nox"
          pip install nox
          echo "::endgroup::"

      - name: Run tests
        run: |
          echo "::group::Running tests (Python ${{ matrix.python-version }} on ${{ matrix.os }})"
          nox --error-on-missing-interpreters --non-interactive --session tests-${{ matrix.python-version }}
          echo "::endgroup::"

  check:
    name: üîç Type Checking
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Python ${{ env.default-python }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.default-python }}
          cache: pip

      - name: Install Nox
        run: |
          echo "::group::Installing Nox"
          pip install nox
          echo "::endgroup::"

      - name: Run type checking
        run: |
          echo "::group::Running type checking"
          nox --error-on-missing-interpreters --non-interactive --session typecheck
          echo "::endgroup::"

  changelog:
    name: üìù Changelog Fragment Check
    if: github.event_name == 'pull_request' && !contains(github.event.pull_request.labels.*.name, 'no-changelog')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (full history)
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Verify changelog fragment presence
        run: |
          echo "::group::Checking changelog fragment"
          if git diff --name-only --diff-filter=A ${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }} | grep -q "^changelog\.d/"; then
            echo "‚úÖ Changelog fragment found."
          else
            echo "‚ùå No changelog fragment found."
            echo "Please add a changelog fragment in changelog.d/ or add the 'no-changelog' label."
            exit 1
          fi
          echo "::endgroup::"

  all-green:
    name: ‚úÖ Core Checks Passed
    if: always()
    needs: [test, check]
    runs-on: ubuntu-latest
    steps:
      - name: Verify all core jobs succeeded
        uses: re-actors/alls-green@v1.2.2
        with:
          jobs: ${{ toJSON(needs) }}
