.build-ci-image:
  extends: .tuxmake
  stage: build-ci-images
  only:
    refs:
      - master
    changes:
      - support/docker/Dockerfile.ci
      - support/docker/tuxmake-ci-images.yml
  image: docker:20.10-dind
  services:
      - name: docker:20.10-dind
  script:
    - 'docker build --network host --build-arg=BASE=$BASE -t $CI_REGISTRY/linaro/tuxmake/$CI_JOB_NAME -f support/docker/Dockerfile.ci .'
    - 'docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY'
    - 'docker push $CI_REGISTRY/linaro/tuxmake/$CI_JOB_NAME'

.publish-ci-image:
  extends: .tuxmake
  stage: publish-ci-images
  only:
    refs:
      - master
    changes:
      - support/docker/Dockerfile.ci
      - support/docker/tuxmake-ci-images.yml
  image: docker:20.10-dind
  services:
      - name: docker:20.10-dind
  variables:
      DOCKER_CLI_EXPERIMENTAL: "enabled"
  script:
    - 'docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY'
    - 'docker manifest create $CI_REGISTRY/linaro/tuxmake/$CI_JOB_NAME $CI_REGISTRY/linaro/tuxmake/$CI_JOB_NAME-amd64 $CI_REGISTRY/linaro/tuxmake/$CI_JOB_NAME-arm64'
    - 'docker manifest push $CI_REGISTRY/linaro/tuxmake/$CI_JOB_NAME'

.build-ci-image-amd64:
  extends: .build-ci-image
  variables:
    ARCH: amd64

.build-ci-image-arm64:
  extends: .build-ci-image
  tags:
    - saas-linux-medium-arm64
  variables:
    ARCH: arm64

ci-debian-10-amd64:
  extends: .build-ci-image-amd64
  variables:
    BASE: docker.io/library/debian:buster-slim

ci-debian-10-arm64:
  extends: .build-ci-image-arm64
  variables:
    BASE: docker.io/library/debian:buster-slim

ci-debian-10:
  extends: .publish-ci-image

ci-debian-11-amd64:
  extends: .build-ci-image-amd64
  variables:
    BASE: docker.io/library/debian:bullseye-slim

ci-debian-11-arm64:
  extends: .build-ci-image-arm64
  variables:
    BASE: docker.io/library/debian:bullseye-slim

ci-debian-11:
  extends: .publish-ci-image

ci-debian-12-amd64:
  extends: .build-ci-image-amd64
  variables:
    BASE: docker.io/library/debian:bookworm-slim

ci-debian-12-arm64:
  extends: .build-ci-image-arm64
  variables:
    BASE: docker.io/library/debian:bookworm-slim

ci-debian-12:
  extends: .publish-ci-image

ci-ubuntu-18.04-amd64:
  extends: .build-ci-image-amd64
  variables:
    BASE: docker.io/library/ubuntu:18.04

ci-ubuntu-18.04-arm64:
  extends: .build-ci-image-arm64
  variables:
    BASE: docker.io/library/ubuntu:18.04

ci-ubuntu-18.04:
  extends: .publish-ci-image

ci-ubuntu-20.04-amd64:
  extends: .build-ci-image-amd64
  variables:
    BASE: docker.io/library/ubuntu:20.04

ci-ubuntu-20.04-arm64:
  extends: .build-ci-image-arm64
  variables:
    BASE: docker.io/library/ubuntu:20.04

ci-ubuntu-20.04:
  extends: .publish-ci-image

ci-ubuntu-22.04-amd64:
  extends: .build-ci-image-amd64
  variables:
    BASE: docker.io/library/ubuntu:22.04

ci-ubuntu-22.04-arm64:
  extends: .build-ci-image-arm64
  variables:
    BASE: docker.io/library/ubuntu:22.04

ci-ubuntu-22.04:
  extends: .publish-ci-image

ci-ubuntu-24.04-amd64:
  extends: .build-ci-image-amd64
  variables:
    BASE: docker.io/library/ubuntu:24.04

ci-ubuntu-24.04-arm64:
  extends: .build-ci-image-arm64
  variables:
    BASE: docker.io/library/ubuntu:24.04

ci-ubuntu-24.04:
  extends: .publish-ci-image
