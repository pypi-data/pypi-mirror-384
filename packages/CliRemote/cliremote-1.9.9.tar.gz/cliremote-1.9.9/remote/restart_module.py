import os
import logging
import asyncio
from typing import List
from .client_manager import stop_all_clients

# ============================================================
# âš™ï¸ ØªÙ†Ø¸ÛŒÙ… Ù„Ø§Ú¯
# ============================================================
logger = logging.getLogger(__name__)
logger.setLevel(logging.INFO)

# root logger Ù‡Ù… Ø§Ú¯Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯:
root_logger = logging.getLogger()

# ============================================================
# ğŸ“ Ù…Ø³ÛŒØ±Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ (Ù†Ø³Ø¨Øª Ø¨Ù‡ Ù‡Ù…ÛŒÙ† Ù…Ø§Ú˜ÙˆÙ„)
# ============================================================
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
LOGS_FOLDER = os.path.join(BASE_DIR, "logs")

# Ù„ÛŒØ³Øª Ø¯Ù‚ÛŒÙ‚ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ø¨Ø§ÛŒØ¯ ÙÙ‚Ø· Ø®Ø§Ù„ÛŒ Ø´ÙˆÙ†Ø¯ (Ø­Ø°Ù Ù†Ø´ÙˆÙ†Ø¯)
TARGET_LOG_FILES: List[str] = [
    "spam_log.txt",
    "client_debug_log.txt",
    "admins_log.txt",
    "analytics_log.txt",
    "sqlite_health.log",   # ØªÙˆØ¬Ù‡: Ø§ÛŒÙ† ÛŒÚ©ÛŒ Ù¾Ø³ÙˆÙ†Ø¯ .log Ø¯Ø§Ø±Ø¯
]

# ============================================================
# ğŸ§° Ø§Ø¨Ø²Ø§Ø±Ú©â€ŒÙ‡Ø§ÛŒ Ú©Ù…Ú©ÛŒ
# ============================================================
def _all_file_handlers() -> List[logging.Handler]:
    """ØªÙ…Ø§Ù… FileHandler Ù‡Ø§ÛŒ Ù…ØªØµÙ„ Ø¨Ù‡ Ø§ÛŒÙ† Ù„Ø§Ú¯Ø± Ùˆ Ø±ÙˆØªâ€ŒÙ„Ø§Ú¯Ø± Ø±Ø§ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø§Ù†Ø¯."""
    handlers = []
    for lg in {logger, root_logger}:
        for h in getattr(lg, "handlers", []):
            # ÙÙ‚Ø· Ù‡Ù†Ø¯Ù„Ø±Ù‡Ø§ÛŒÛŒ Ú©Ù‡ ÙØ§ÛŒÙ„ Ø¯Ø§Ø±Ù†Ø¯
            if isinstance(h, logging.FileHandler):
                handlers.append(h)
    return handlers

def _flush_file_handlers():
    """Ù¾ÛŒØ´ Ø§Ø² Ø¯Ø³Øªâ€ŒÚ©Ø§Ø±ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ØŒ Ø¨Ø§ÙØ± Ù„Ø§Ú¯â€ŒÙ‡Ø§ Ø±Ø§ Ø®Ø§Ù„ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯."""
    for h in _all_file_handlers():
        try:
            h.flush()
        except Exception:
            pass

# ============================================================
# ğŸ§¹ ØªØ§Ø¨Ø¹ Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ù„Ø§Ú¯â€ŒÙ‡Ø§ (Ø®Ø§Ù„ÛŒâ€ŒÚ©Ø±Ø¯Ù† Ø¨Ø¯ÙˆÙ† Ø­Ø°Ù)
# ============================================================
async def clear_logs() -> int:
    """
    Ù…Ø­ØªÙˆÛŒØ§Øª ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…Ø´Ø®Øµâ€ŒØ´Ø¯Ù‡ Ø¯Ø± TARGET_LOG_FILES Ø±Ø§ Ø¨Ù‡ Ø§Ù†Ø¯Ø§Ø²Ù‡ ØµÙØ± truncate Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
    Ø§Ú¯Ø± ÙØ§ÛŒÙ„ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´ØªØŒ ÛŒÚ© ÙØ§ÛŒÙ„ Ø®Ø§Ù„ÛŒ Ù…ÛŒâ€ŒØ³Ø§Ø²Ø¯.
    Ø®Ø±ÙˆØ¬ÛŒ: ØªØ¹Ø¯Ø§Ø¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ ÙˆØ§Ù‚Ø¹Ø§ Ø®Ø§Ù„ÛŒ Ø´Ø¯Ù†Ø¯/Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù†Ø¯.
    """
    os.makedirs(LOGS_FOLDER, exist_ok=True)

    _flush_file_handlers()

    cleared = 0
    for name in TARGET_LOG_FILES:
        path = os.path.join(LOGS_FOLDER, name)
        try:
            # 'w' ÙØ§ÛŒÙ„ Ø±Ø§ Ø§ÛŒØ¬Ø§Ø¯/Ø®Ø§Ù„ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ø¨Ø¯ÙˆÙ† Ø­Ø°Ù ÙÛŒØ²ÛŒÚ©ÛŒ ÙØ§ÛŒÙ„
            with open(path, "w", encoding="utf-8") as f:
                f.truncate(0)
            cleared += 1
            logger.info(f"ğŸ§¹ Log cleared â†’ {name}")
        except Exception as e:
            logger.error(f"âš ï¸ Error clearing log {name}: {e}")

    logger.info(f"âœ… {cleared} log file(s) cleared.")
    return cleared

# ============================================================
# ğŸ› ï¸ Ø±ÛŒØ³Øª ØªÙ†Ø¸ÛŒÙ…Ø§Øª
# ============================================================
# async def reset_config() -> bool:
#     """
#     Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ ÙØ§ÛŒÙ„ config.py Ú©Ù†Ø§Ø± Ù‡Ù…ÛŒÙ† Ù…Ø§Ú˜ÙˆÙ„ Ø¨Ø§ Ù…Ù‚Ø§Ø¯ÛŒØ± Ù¾ÛŒØ´â€ŒÙØ±Ø¶.
#     Ù†Ú©ØªÙ‡: Ù†Ø§Ù… Ù…ØªØºÛŒØ± Ø±Ø§ Ø¨Ø§ Ø§ÛŒÙ…Ù¾ÙˆØ±Øª Ù‡Ù…â€ŒÙ†Ø§Ù… Ù†Ú©Ù†ÛŒØ¯ ØªØ§ shadow Ù†Ø´ÙˆØ¯.
#     """
#     try:
#         default_config_py = '''# AUTO-GENERATED BY restart module
# # -*- coding: utf-8 -*-

# spam_config = {
#     "spamTarget": "",
#     "TimeSleep": 5.0,
#     "caption": "",
#     "run": False,
#     "useridMen": 1,
#     "textMen": "",
#     "is_menshen": False,
#     "BATCH_SIZE": 1,
# }
# '''
#         config_path = os.path.join(BASE_DIR, "config.py")
#         with open(config_path, "w", encoding="utf-8") as f:
#             f.write(default_config_py)
#         logger.info("âš™ï¸ config.py has been reset to defaults.")
#         return True
#     except Exception as e:
#         logger.error(f"âš ï¸ Error resetting config.py: {e}")
#         return False

# ============================================================
# ğŸ”„ Ø±ÛŒØ³Øª Ú©Ø§Ù…Ù„ Ø³ÛŒØ³ØªÙ…
# ============================================================
async def restart_all() -> None:
    """
    ØªÙˆÙ‚Ù ØªÙ…Ø§Ù… Ú©Ù„Ø§ÛŒÙ†Øªâ€ŒÙ‡Ø§ + Ø®Ø§Ù„ÛŒ Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯â€ŒÙ‡Ø§ + Ø±ÛŒØ³Øª ØªÙ†Ø¸ÛŒÙ…Ø§Øª
    """
    logger.info("ğŸš€ Starting full system restart...")

    # # ØªÙˆÙ‚Ù Ú©Ù„Ø§ÛŒÙ†Øªâ€ŒÙ‡Ø§
    # try:
    #     await stop_all_clients()
    #     logger.info("ğŸ§© All clients stopped successfully.")
    # except Exception as e:
    #     logger.warning(f"âš ï¸ stop_all_clients error: {e}")

    # Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ù„Ø§Ú¯â€ŒÙ‡Ø§
    try:
        cleared = await clear_logs()
        logger.info(f"ğŸ§¹ Cleared {cleared} log files.")
    except Exception as e:
        logger.warning(f"âš ï¸ clear_logs error: {e}")

    # # Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª
    # try:
    #     success = await reset_config()
    #     if success:
    #         logger.info("âš™ï¸ Config reset completed.")
    #     else:
    #         logger.warning("âš ï¸ Config reset failed.")
    # except Exception as e:
        # logger.warning(f"âš ï¸ reset_config error: {e}")

    logger.info("âœ… System restart completed successfully.")
