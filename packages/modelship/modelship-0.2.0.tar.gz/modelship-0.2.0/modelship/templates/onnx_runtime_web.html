<!DOCTYPE html>
<html data-bs-theme="dark" data-bs-core="modern">
<head>
  <title>{{ model_metadata.name }} | modelship</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="./vendor/bootstrap-icons/bootstrap-icons.min.css" rel="stylesheet">
  <link href="./vendor/halfmoon/halfmoon.min.css" rel="stylesheet">
  <link href="./vendor/halfmoon/halfmoon.modern.css" rel="stylesheet">
</head>

<body class="d-flex flex-column min-vh-100">
  <main class="container py-3 py-sm-4 px-3 px-sm-4 flex-grow-1">
    <div class="row justify-content-center">
      <div class="col-12 col-md-8 col-lg-6">
        <h1>{{ model_metadata.name }}</h1>

        {% if model_metadata.description %}
        <p>{{ model_metadata.description }}</p>
        {% endif %}

        <div id="modelLoadingIndicator" class="text-center my-5">
          <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="text-muted">Loading ONNX model...</p>
        </div>

        <div id="modelInterface" style="display: none;">
          <h2>Inputs</h2>
          <form id="inferenceForm">
            {% for model_input_key, model_input in model_metadata.inputs.items() %}
            <div class="mb-3">
              <label for="{{ model_input_key }}Input" class="form-label">{{ model_input.name }}</label>
              <input
                id="{{ model_input_key }}Input"
                type="{% if model_input.type == 'float32' %}number{% else %}text{% endif %}"
                class="form-control"
                {% if model_input.min %}min="{{ model_input.min }}"{% endif %}
                {% if model_input.max %}max="{{ model_input.max }}"{% endif %}
                {% if model_input.step %}step="{{ model_input.step }}"{% endif %}
                {% if model_input.default %}value="{{ model_input.default }}"{%endif %}
              >
            </div>
            {% endfor %}
            <div class="d-flex align-items-center">
              <input type="submit" class="btn btn-primary ms-auto" value="Run">
            </div>
          </form>

          <h2>Outputs</h2>
          <form id="resultsForm">
            {% for model_output_key, model_output in model_metadata.outputs.items() %}
            <div class="mb-3">
              <label for="{{ model_output_key }}Output" class="form-label">{{ model_output.name }}</label>
              <input
                id="{{ model_output_key }}Output"
                type="{% if model_output.type == 'float32' %}number{% else %}text{% endif %}"
                class="form-control"
                disabled
              >
            </div>
            {% endfor %}
          </form>
        </div>
      </div>
    </div>
  </main>

  <footer class="mt-auto py-3 border-top" style="background-color: var(--bs-secondary-bg);">
    <div class="container">
      <div class="text-center">
        <small class="text-muted">
          Generated with
          <a href="{{ app_metadata.github_repo_url }}"
              target="_blank"
              class="text-muted text-decoration-none">
            {{ app_metadata.app_name }}
          </a>
          <a href="{{ app_metadata.github_repo_url }}/releases/tag/{{ app_metadata.app_version }}"
              target="_blank"
              class="text-muted text-decoration-none">
            v{{ app_metadata.app_version }}
            <i class="bi-box-arrow-up-right ms-1" style="font-size: 0.8em; vertical-align: text-top;"></i>
          </a>
        </small>
      </div>
    </div>
  </footer>

  <script type="importmap">
    {
      "imports": {
        "bootstrap": "./vendor/bootstrap/bootstrap.esm.min.js",
        "onnxruntime-web": "./vendor/onnxruntime-web/ort.bundle.min.js"
      }
    }
  </script>

  <!--
  <script type="module">
    import * as bootstrap from "bootstrap"
  </script>
  -->

  <script type="module">
    import * as ort from "onnxruntime-web"
    console.info(`onnxruntime-web version: ${ort.env.versions.web}`)

    const modelMetadata = {{ model_metadata_json | safe }}

    console.info('loading model using onnx runtime web')
    const sessionOption = { executionProviders: ['webgpu', 'wasm'] };

    let session;
    try {
      session = await ort.InferenceSession.create('{{ model_path }}', sessionOption)

      document.getElementById('modelLoadingIndicator').style.display = 'none'
      document.getElementById('modelInterface').style.display = 'block'

      console.info('model loaded successfully')
    } catch (error) {
      console.error('failed to load ONNX model:', error)

      const loadingIndicator = document.getElementById('modelLoadingIndicator')
      const errorMessage = error.message || String(error)
      loadingIndicator.innerHTML = `
        <div class="alert alert-danger" role="alert">
          <h4 class="alert-heading"><i class="bi-exclamation-triangle"></i> Failed to load model</h4>
          <p class="mb-0">An error occurred while loading the ONNX model.</p>
          <pre class="mt-3 mb-0 p-3 bg-body-secondary border rounded"><code>${errorMessage}</code></pre>
        </div>
      `
      throw error
    }

    function getTensor(value, inputMetadata) {
      const shape = inputMetadata.shape.map((item, index, arr) => item === null ? 1 : item)
      const array = (inputMetadata.type === 'float32') ? Float32Array.from([value]) : [value]
      return new ort.Tensor(inputMetadata.type, array, shape)
    }

    async function performModelInference(inputs) {
      try {
        const inputTensors = Object.fromEntries(
          Object.entries(inputs).map(
            ([key, value]) => [key, getTensor(value, modelMetadata.inputs[key])]
          )
        )

        const results = await session.run(inputTensors)
        console.debug(`'results': ${JSON.stringify(results, null, 4)}`)

        return Object.fromEntries(
          Object.entries(results).map(([key, value]) => [key, value.data])
        )
      } catch (e) {
        console.error(`failed to inference ONNX model: ${e}.`)
      }
    }

    function main() {
      document.getElementById('inferenceForm').addEventListener('submit', async event => {
        event.preventDefault()

        const formInputs = {
          {% for model_input_key, model_input in model_metadata.inputs.items() %}
          {{ model_input_key }}: document.getElementById('{{ model_input_key}}Input').value,
          {% endfor %}
        }

        console.debug(`performing model inference with inputs: ${JSON.stringify(formInputs, null, 4)}`)
        const formOutputs = await performModelInference(formInputs)
        console.debug(`output model predictions: ${JSON.stringify(formOutputs, null, 4)}`)

        {% for model_output_key in model_metadata.outputs.keys() %}
        document.getElementById('{{ model_output_key }}Output').value = formOutputs.{{ model_output_key }}
        {% endfor %}
      })
    }

    main()
  </script>
</body>

</html>