var se=Object.defineProperty;var ie=(l,e,i)=>e in l?se(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i;var b=(l,e,i)=>ie(l,typeof e!="symbol"?e+"":e,i);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))n(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const t of o.addedNodes)t.tagName==="LINK"&&t.rel==="modulepreload"&&n(t)}).observe(document,{childList:!0,subtree:!0});function i(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerPolicy&&(o.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?o.credentials="include":a.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(a){if(a.ep)return;a.ep=!0;const o=i(a);fetch(a.href,o)}})();class Y extends Error{constructor(i,n){super(i);b(this,"status");this.name="ApiError",this.status=n}}const F=Object.freeze({"Content-Type":"application/json"});async function R(l,e={},i=!1){const{parseJson:n=!0,...a}=e;console.log("requestJson",l,a);const o=await fetch(l,a);if(o.status===404&&i)return null;if(!o.ok){let t=o.statusText||`Request failed (${o.status})`;try{const s=await o.json();s!=null&&s.error&&(t=s.error)}catch{}throw new Y(t,o.status)}return!n||o.status===204?null:await o.json()}class ne{async fetchTree(){return await R("/api/tree",{method:"GET"})}async readFile(e){const i=encodeURIComponent(e);return await R(`/api/file?path=${i}`,{method:"GET"})}async writeFile(e,i){await R("/api/file",{method:"PUT",headers:F,body:JSON.stringify({path:e,content:i}),parseJson:!1},!1)}async deleteFile(e){const i=encodeURIComponent(e);await R(`/api/file?path=${i}`,{method:"DELETE",parseJson:!1},!1)}async fileExists(e){const i=encodeURIComponent(e);try{const n=await R(`/api/file?path=${i}`,{method:"GET"},!0)}catch(n){return console.error(n),!1}return payload!==null}async search(e,i,n){const a=encodeURIComponent(e);return await R(`/api/search?query=${a}&limit=${i}`,{method:"GET",signal:n})}async vectorStatus(){return await R("/api/vector/status",{method:"GET"})}async vectorEmbeddings(e){const i=new URLSearchParams({limit:String(Math.max(1,e.limit)),offset:String(Math.max(0,e.offset))});return e.path&&i.set("path",e.path),await R(`/api/vector/embeddings?${i.toString()}`,{method:"GET"})}async vectorQueryEmbedding(e){const i=new URLSearchParams({query:e});return await R(`/api/vector/query_embedding?${i.toString()}`,{method:"GET"})}async vectorReindex(){return await R("/api/vector/reindex",{method:"POST",headers:F})}async vectorRefit(){return await R("/api/vector/refit",{method:"POST",headers:F})}}const M=new ne;function re(){const l=document.getElementById("file-tree"),e=document.getElementById("editor"),i=document.getElementById("current-path"),n=document.getElementById("save"),a=document.getElementById("cancel"),o=document.getElementById("delete"),t=document.getElementById("status"),s=document.getElementById("new-file"),r=document.getElementById("search-input"),h=document.getElementById("search-limit"),c=document.getElementById("search-clear"),S=document.getElementById("search-results"),m=document.getElementById("menu-browse"),C=document.getElementById("menu-vectors"),v=document.getElementById("browse-view"),p=document.getElementById("vectors-view");if(!l||!e||!i||!n||!a||!o||!t||!s||!r||!h||!c||!S||!m||!C||!v||!p)throw new Error("UI markup missing required elements");return{tree:l,editor:e,path:i,save:n,cancel:a,del:o,status:t,newFile:s,searchInput:r,searchLimit:h,searchClear:c,searchResults:S,browseBtn:m,vectorBtn:C,browseView:v,vectorsView:p}}class ae{constructor(e){b(this,"elements",re());b(this,"vector");b(this,"state",{currentPath:"",originalContent:"",lastSearchTerm:"",lastSearchLimit:10,activeSearchController:null,resultPaths:new Set});b(this,"triggerSearch");this.vector=e,this.triggerSearch=this.buildSearchScheduler()}async start(){this.wireMenu(),this.wireEditor(),this.wireSearch(),await this.loadTree(),this.updateButtons()}setStatus(e){this.elements.status.textContent=e??""}hasChanges(){const{currentPath:e,originalContent:i}=this.state;return e?this.elements.editor.value!==i:!1}updateButtons(){const e=this.hasChanges();this.elements.save.toggleAttribute("disabled",!e),this.elements.cancel.toggleAttribute("disabled",!e),this.elements.del.toggleAttribute("disabled",!this.state.currentPath)}async loadTree(){try{const e=await M.fetchTree();this.renderTree(e),this.state.resultPaths.size>0&&this.filterTreeWithResults(this.state.resultPaths)}catch(e){this.setStatus(this.errorMessage(e,"Failed to load file tree")),console.error(e)}}renderTree(e){const{tree:i}=this.elements;i.textContent="",this.buildTree(e,i)}buildTree(e,i){if(e.children)for(const n of e.children)if(n.type==="dir"){const a=document.createElement("li");a.className="dir",a.textContent=`${n.name}/`,i.appendChild(a);const o=document.createElement("ul");o.className="tree",i.appendChild(o),this.buildTree(n,o)}else{const a=document.createElement("li");a.className="file",a.textContent=n.name,a.dataset.path=n.path,a.addEventListener("click",()=>void this.selectFile(n.path,a)),i.appendChild(a)}}errorMessage(e,i){return e instanceof Y&&e.message||e instanceof Error&&e.message?e.message:i}async selectFile(e,i,n,a){var o;try{const t=await M.readFile(e);this.state.currentPath=t.path,this.state.originalContent=t.content??"",this.elements.editor.value=this.state.originalContent,this.elements.path.textContent=t.path,this.markActive(i),this.setStatus(""),this.updateButtons(),(o=this.vector)==null||o.onTreeSelect(t.path),typeof n=="number"&&n>0&&requestAnimationFrame(()=>this.highlightLineInEditor(n,a))}catch(t){const s=this.errorMessage(t,`Unable to load "${e}"`);this.setStatus(s),console.error(t)}}markActive(e){for(const i of this.elements.tree.querySelectorAll(".file.active"))i.classList.remove("active");e&&e.classList.add("active")}async saveCurrentFile(){if(this.state.currentPath){this.setStatus("Saving…");try{await M.writeFile(this.state.currentPath,this.elements.editor.value),this.state.originalContent=this.elements.editor.value,this.setStatus("Saved"),await this.loadTree(),this.updateButtons()}catch(e){const i=this.errorMessage(e,"Save failed");this.setStatus(i),console.error(e)}}}revertChanges(){this.elements.editor.value=this.state.originalContent,this.setStatus("Reverted"),this.updateButtons()}async deleteCurrentFile(){if(!this.state.currentPath)return;const e=this.hasChanges()?" (unsaved changes will be lost)":"";if(window.confirm(`Soft delete "${this.state.currentPath}"?${e}`)){this.setStatus("Deleting…");try{await M.deleteFile(this.state.currentPath),this.state.currentPath="",this.state.originalContent="",this.elements.editor.value="",this.elements.path.textContent="",await this.loadTree(),this.setStatus("Deleted"),this.updateButtons()}catch(n){const a=this.errorMessage(n,"Delete failed");this.setStatus(a),console.error(n)}}}async createNewFile(){const e=this.state.currentPath.replace(/[^/]+$/,""),n=(window.prompt("Enter new file path (relative to root):",e)??"").replace(/^\/+/,"").trim();if(n){this.setStatus("Creating…");try{if(await M.fileExists(n)&&!window.confirm("File exists. Overwrite?")){this.setStatus("");return}await M.writeFile(n,""),await this.loadTree(),await this.selectFile(n,this.findTreeItem(n)),this.setStatus("Created")}catch(a){const o=this.errorMessage(a,"Create failed");this.setStatus(o),console.error(a)}}}highlightLineInEditor(e,i){const{editor:n}=this.elements,a=n.value.split(`
`);console.log("highlightLineInEditor",e,i,a.length),console.log(a),(i===void 0||i<e)&&(i=e);let o=0;for(let s=1;s<=e;s+=1)console.log("add line",s-1,"to start"),o+=(a[s-1]??"").length+1;let t=o;for(let s=e;s<=i;s+=1)console.log("add line",s,"to end"),t+=(a[s]??"").length+1;console.log("highlightLineInEditor2",o,t),n.focus(),n.setSelectionRange(o,t),n.value.length>0&&(n.scrollTop=n.scrollHeight*(o/n.value.length)),n.classList.add("flash"),window.setTimeout(()=>n.classList.remove("flash"),800)}wireEditor(){this.elements.editor.addEventListener("input",()=>this.updateButtons()),this.elements.save.addEventListener("click",()=>void this.saveCurrentFile()),this.elements.cancel.addEventListener("click",()=>this.revertChanges()),this.elements.del.addEventListener("click",()=>void this.deleteCurrentFile()),this.elements.newFile.addEventListener("click",()=>void this.createNewFile())}wireMenu(){const{browseBtn:e,vectorBtn:i,browseView:n,vectorsView:a}=this.elements;e.addEventListener("click",()=>{var o;e.classList.add("active"),e.setAttribute("aria-pressed","true"),i.classList.remove("active"),i.setAttribute("aria-pressed","false"),n.classList.remove("hidden"),n.setAttribute("aria-hidden","false"),a.classList.add("hidden"),a.setAttribute("aria-hidden","true"),(o=this.vector)==null||o.showBrowse()}),i.addEventListener("click",()=>{var o;e.classList.remove("active"),e.setAttribute("aria-pressed","false"),i.classList.add("active"),i.setAttribute("aria-pressed","true"),n.classList.add("hidden"),n.setAttribute("aria-hidden","true"),a.classList.remove("hidden"),a.setAttribute("aria-hidden","false"),(o=this.vector)==null||o.showVectors()})}buildSearchScheduler(){let e;return()=>{e&&window.clearTimeout(e),e=window.setTimeout(()=>{e=void 0,this.runSearch()},200)}}wireSearch(){const{searchInput:e,searchLimit:i,searchClear:n}=this.elements;e.addEventListener("input",()=>this.triggerSearch()),i.addEventListener("change",()=>this.triggerSearch()),n.addEventListener("click",()=>{var a;e.value="",this.clearSearchEffects(),(a=this.vector)==null||a.onClearSearch()})}async runSearch(){var t,s;const{searchInput:e,searchLimit:i}=this.elements,n=e.value.trim(),a=Math.max(1,parseInt(i.value||"10",10));if(this.state.lastSearchTerm=n,this.state.lastSearchLimit=a,!n){this.clearSearchEffects(),(t=this.vector)==null||t.onClearSearch();return}this.state.activeSearchController&&this.state.activeSearchController.abort();const o=new AbortController;this.state.activeSearchController=o;try{const r=await M.search(n,a,o.signal);if(this.renderResults(r,n),this.elements.vectorsView.classList.contains("hidden")){const h=new Set(r.results.map(c=>c.path));this.filterTreeWithResults(h)}else(s=this.vector)==null||s.onSearchResults(n,r)}catch(r){if((r==null?void 0:r.name)==="AbortError")return;this.elements.searchResults.textContent=this.errorMessage(r,"Search error"),console.error(r)}finally{this.state.activeSearchController===o&&(this.state.activeSearchController=null)}}filterTreeWithResults(e){this.state.resultPaths=e;const i=n=>{let a=!1;const o=Array.from(n.children);for(let t=0;t<o.length;t+=1){const s=o[t];if(s.classList.contains("file")){const r=e.has(s.dataset.path??"");s.style.display=r?"":"none",a||(a=r)}else if(s.classList.contains("dir")){const r=o[t+1];if(r&&r.tagName==="UL"){const h=i(r);s.style.display=h?"":"none",r.style.display=h?"":"none",a||(a=h),t+=1}}}return a};i(this.elements.tree)}clearSearchEffects(){this.elements.searchResults.textContent="",this.state.resultPaths=new Set;for(const e of this.elements.tree.querySelectorAll("li, ul"))e.style.display=""}renderResults(e,i){const{searchResults:n,tree:a}=this.elements;if(e.results.length===0){n.textContent="No results",this.state.resultPaths=new Set;return}n.textContent="";for(const o of e.results){const t=(o.content??"").split(`
`),s=Math.max(0,o.start_line),r=Math.min(s+t.length,Math.max(0,o.end_line)),h=document.createElement("div");h.className="result",h.innerHTML=`<span class="line">L${s}-L${r}</span><span class="path">${o.path}</span>`,h.title=t.join(`
`),h.addEventListener("click",()=>{const c=a.querySelector(`.file[data-path="${CSS.escape(o.path)}"]`);this.selectFile(o.path,c,s,r)}),n.appendChild(h)}}findTreeItem(e){return this.elements.tree.querySelector(`.file[data-path="${CSS.escape(e)}"]`)}}function z(l,e){if(l==null)throw new Error(`->${e} is null or undefined`)}function oe(l,e){return typeof l>"u"?e:l}function B(l,e,i){for(const[n,a]of i)z(l[n],`Row ${e}[${n}][${a}]`),a!==void 0&&z(l[n][a],`Col ${e}[${n}][${a}]`)}function j(l,e){if(!l[0]||!l.length)throw new Error(`->${e} should be a valid matrix`)}function X(l,e,i,n){if(j(l,i),j(e,n),e.length!==l[0].length)throw new Error(`Columns in ${i} should be the same as the number of rows in ${n}`)}function _(l,e){let i=Math.pow(10,e);return l.map(function(n,a){return n.map(function(o){return Math.round(o*i)/i})})}function G(l){return l.map(e=>Array.from(new Float64Array(e)))}function N(l,e){X(l,e,"a","b");const i=l.length,n=l[0].length,a=e[0].length,o=new Float64Array(i*a);for(let s=0;s<i;s++)for(let r=0;r<n;r++){const h=l[s][r],c=s*a;for(let S=0;S<a;S++)o[c+S]+=h*e[r][S]}const t=[];for(let s=0;s<i;s++)t[s]=Array.from(o.subarray(s*a,(s+1)*a));return t}function J(l,e){j(l,"a"),j(e,"b");const i=l.length,n=l[0].length,a=e.length,o=e[0].length;if(!(i===a&&n===o))throw new Error("Both A and B should have the same dimensions");const t=Array.from({length:i},()=>Array(o).fill(0));for(var s=0;s<i;s++)for(var r=0;r<o;r++)t[s][r]=l[s][r]-e[s][r];return t}function O(l,e){j(l,"a");const i=l.length,n=l[0].length,a=Array.from({length:i},()=>Array(n).fill(0));for(var o=0;o<i;o++)for(var t=0;t<n;t++)a[o][t]=l[o][t]*e;return a}function W(l,e,i){X(l,e,"a","b");const n=l.length,a=l[0].length,o=e[0].length,t=new Float64Array(n*o);for(let r=0;r<n;r++)for(let h=0;h<a;h++){const c=l[r][h]*i,S=r*o;for(let m=0;m<o;m++)t[S+m]+=c*e[h][m]}const s=[];for(let r=0;r<n;r++)s[r]=Array.from(t.subarray(r*o,(r+1)*o));return s}function H(l){const e=Array.from({length:l},()=>Array(l).fill(0));for(let i=0;i<l;i++)for(let n=0;n<l;n++)e[i][n]=1;return e}function q(l,e=!1){if(e){const i=G(l);return j(i,"a"),i[0].map(function(a,o){return l.map(function(t){return t[o]})})}else return j(l,"a"),l[0].map(function(n,a){return l.map(function(o){return o[a]})})}function le(l){let e,i=Math.pow(2,-52),n=1e-64/i,a=50,o=0,t=0,s=0,r=0,h=0,c=G(l),S=c.length;z(c[0],"u");let m=c[0].length;if(S<m)throw"Need more rows than columns";let C=new Array(m),v=new Array(m);for(t=0;t<m;t++)C[t]=v[t]=0;let p=D([m,m],0);function T(y,E){return y=Math.abs(y),E=Math.abs(E),y>E?y*Math.sqrt(1+E*E/y/y):E==0?y:E*Math.sqrt(1+y*y/E/E)}function D(y,E,L){let x=oe(L,0),P=y[x],V=Array(P),k;if(x===y.length-1){for(k=P-2;k>=0;k-=2)V[k+1]=E,V[k]=E;return k===-1&&(V[0]=E),V}for(k=P-1;k>=0;k--)V[k]=D(y,E,x+1);return V}let g=0,f=0,w=0,I=0,A=0,u=0,d=0;for(t=0;t<m;t++){for(C[t]=f,d=0,h=t+1,s=t;s<S;s++)B(c,"u[j, i]",[[s,t]]),d+=c[s][t]*c[s][t];if(d<=n)f=0;else for(B(c,"u[i, i]",[[t,t]]),g=c[t][t],f=Math.sqrt(d),g>=0&&(f=-f),w=g*f-d,c[t][t]=g-f,s=h;s<m;s++){for(d=0,r=t;r<S;r++)B(c,"u[k, i], [k, j]",[[r,t],[r,s]]),d+=c[r][t]*c[r][s];for(g=d/w,r=t;r<S;r++)c[r][s]+=g*c[r][t]}for(v[t]=f,d=0,s=h;s<m;s++)B(c,"u[i, j]",[[t,s]]),d=d+c[t][s]*c[t][s];if(d<=n)f=0;else{for(g=c[t][t+1],f=Math.sqrt(d),g>=0&&(f=-f),w=g*f-d,B(c,"u[i, i+1]",[[t,t+1]]),c[t][t+1]=g-f,s=h;s<m;s++)C[s]=c[t][s]/w;for(s=h;s<S;s++){for(d=0,r=h;r<m;r++)B(c,"u[j, k], [i, k]",[[s,r],[t,r]]),d+=c[s][r]*c[t][r];for(r=h;r<m;r++)B(c,"u[j, k]",[[s,r]]),c[s][r]+=d*C[r]}}A=Math.abs(v[t])+Math.abs(C[t]),A>I&&(I=A)}for(t=m-1;t!=-1;t+=-1){if(f!=0){for(B(c,"u[i, i+1]",[[t,t+1]]),w=f*c[t][t+1],s=h;s<m;s++)B(c,"u[i, j]",[[t,s]]),p[s][t]=c[t][s]/w;for(s=h;s<m;s++){for(d=0,r=h;r<m;r++)B(c,"u[i, k]",[[t,r]]),B(p,"v[k, j]",[[r,s]]),d+=c[t][r]*p[r][s];for(r=h;r<m;r++)B(p,"v[k, j],[k, i]",[[r,s],[r,t]]),p[r][s]+=d*p[r][t]}}for(s=h;s<m;s++)B(p,"v[i, j],[j, i]",[[t,s],[s,t]]),p[t][s]=0,p[s][t]=0;p[t][t]=1,f=C[t],h=t}for(t=m-1;t!=-1;t+=-1){for(h=t+1,f=v[t],s=h;s<m;s++)B(c,"u[i, j]",[[t,s]]),c[t][s]=0;if(f!=0){for(B(c,"u[i, i]",[[t,t]]),w=c[t][t]*f,s=h;s<m;s++){for(d=0,r=h;r<S;r++)B(c,"u[k, j],[k, i]",[[r,s],[r,t]]),d+=c[r][t]*c[r][s];for(g=d/w,r=t;r<S;r++)B(c,"u[k, j],[k, i]",[[r,s],[r,t]]),c[r][s]+=g*c[r][t]}for(s=t;s<S;s++)B(c,"u[j, i]",[[s,t]]),c[s][t]=c[s][t]/f}else for(s=t;s<S;s++)B(c,"u[j, i]",[[s,t]]),c[s][t]=0;c[t][t]+=1}for(i=i*I,r=m-1;r!=-1;r+=-1)for(let y=0;y<a;y++){let E=!1;for(h=r;h!=-1;h+=-1){if(Math.abs(C[h])<=i){E=!0;break}if(Math.abs(v[h-1])<=i)break}if(!E){o=0,d=1;let L=h-1;for(t=h;t<r+1&&(g=d*C[t],C[t]=o*C[t],!(Math.abs(g)<=i));t++)for(f=v[t],w=T(g,f),v[t]=w,o=f/w,d=-g/w,s=0;s<S;s++)B(c,"u[j, l1],[j, i]",[[s,L],[s,t]]),A=c[s][L],u=c[s][t],c[s][L]=A*o+u*d,c[s][t]=-A*d+u*o}if(u=v[r],h==r){if(u<0)for(v[r]=-u,s=0;s<m;s++)B(p,"v[k, j]",[[s,r]]),p[s][r]=-p[s][r];break}if(y>=a-1)throw`Error: no convergence for ${y} exceeding ${a-1}`;for(I=v[h],A=v[r-1],f=C[r-1],w=C[r],g=((A-u)*(A+u)+(f-w)*(f+w))/(2*w*A),f=T(g,1),g<0?g=((I-u)*(I+u)+w*(A/(g-f)-w))/I:g=((I-u)*(I+u)+w*(A/(g+f)-w))/I,o=1,d=1,t=h+1;t<r+1;t++){for(f=C[t],A=v[t],w=d*f,f=o*f,u=T(g,w),C[t-1]=u,o=g/u,d=w/u,g=I*o+f*d,f=-I*d+f*o,w=A*d,A=A*o,s=0;s<m;s++)B(p,"v[j, i],[j, i-1]",[[s,t-1],[s,t]]),I=p[s][t-1],u=p[s][t],p[s][t-1]=I*o+u*d,p[s][t]=-I*d+u*o;for(u=T(g,w),v[t-1]=u,o=g/u,d=w/u,g=o*f+d*A,I=-d*f+o*A,s=0;s<S;s++)B(c,"u[j, i],[j, i-1]",[[s,t-1],[s,t]]),A=c[s][t-1],u=c[s][t],c[s][t-1]=A*o+u*d,c[s][t]=-A*d+u*o}C[h]=0,C[r]=g,v[r]=I}for(t=0;t<v.length;t++)v[t]<i&&(v[t]=0);for(t=0;t<m;t++)for(s=t-1;s>=0;s--)if(v[s]<v[t]){for(o=v[s],v[s]=v[t],v[t]=o,r=0;r<c.length;r++)B(c,"u[k, i]",[[r,t],[r,s]]),e=c[r][t],c[r][t]=c[r][s],c[r][s]=e;for(r=0;r<p.length;r++)B(p,"v[k, i]",[[r,t],[r,s]]),e=p[r][t],p[r][t]=p[r][s],p[r][s]=e;t=s}return{U:c,S:v,V:p}}function U(l){let e=H(l.length);return J(l,W(e,l,1/l.length))}function K(l){return N(q(l),l)}function Q(l,e){let i;return e?i=O(l,1/(l.length-1)):i=O(l,1/l.length),i}function Z(l){let e=le(l),i=e.U;return e.S.map(function(o,t){return{eigenvalue:o,eigenvector:i.map(function(r){return-1*r[t]})}})}function ee(l,...e){let i=e.map(function(r){return r.eigenvector}),n=U(l),a=N(i,q(n)),o=H(l.length),t=W(o,l,-1/l.length),s=_(a,2);return{adjustedData:a,formattedAdjustedData:s,avgData:t,selectedVectors:i}}function ce(l,e,i){let n=q(N(q(e),l)),a=J(n,i),o=_(a,2);return{originalData:a,formattedOriginalData:o}}function he(l,...e){let i=l.map(a=>a.eigenvalue).reduce((a,o)=>a+o);return e.map(a=>a.eigenvalue).reduce((a,o)=>a+o)/i}function te(l){return Z(Q(K(U(l)),!1))}function de(l){let n=te(l).sort(function(a,o){return o.eigenvalue-a.eigenvalue})[0];return ee(l,n)}var $=Object.freeze({__proto__:null,analyseTopResult:de,computeAdjustedData:ee,computeDeviationMatrix:U,computeDeviationScores:K,computeOriginalData:ce,computePercentageExplained:he,computeSVD:Z,computeVarianceCovariance:Q,getEigenVectors:te});typeof window<"u"&&(window.PCA=$);function ue(){const l=document.getElementById("menu-browse"),e=document.getElementById("menu-vectors"),i=document.getElementById("menu-reindex"),n=document.getElementById("menu-umap-refit"),a=document.getElementById("browse-view"),o=document.getElementById("vectors-view"),t=document.getElementById("vector-legend"),s=document.getElementById("vector-status"),r=document.getElementById("vector-canvas"),h=document.getElementById("vector-canvas-container");if(!l||!e||!i||!n||!a||!o||!t||!s||!r||!h)throw new Error("Vector UI markup missing required elements");return{browseBtn:l,vectorBtn:e,reindexBtn:i,refitBtn:n,browseView:a,vectorsView:o,legend:t,status:s,canvas:r,canvasContainer:h}}class fe{constructor(){b(this,"elements",ue());b(this,"available",!1);b(this,"active",!1);b(this,"initialized",!1);b(this,"rows",[]);b(this,"coords",new Float32Array);b(this,"basis",[]);b(this,"indicesByPath",new Map);b(this,"indicesByDocumentId",new Map);b(this,"indicesByRowId",new Map);b(this,"selectedIndices",new Set);b(this,"resultIndices",new Set);b(this,"queryPoint",null);b(this,"yaw",0);b(this,"pitch",0);b(this,"zoom",1);b(this,"panX",0);b(this,"panY",0);b(this,"dragMode",null);b(this,"lastX",0);b(this,"lastY",0)}async initialize(){await this.loadAvailability(),this.wireInteractions(),this.wireAdminButtons()}showBrowse(){this.active=!1,this.elements.vectorBtn.classList.remove("active"),this.elements.vectorBtn.setAttribute("aria-pressed","false"),this.elements.browseBtn.classList.add("active"),this.elements.browseBtn.setAttribute("aria-pressed","true"),this.elements.vectorsView.classList.add("hidden"),this.elements.vectorsView.setAttribute("aria-hidden","true"),this.elements.browseView.classList.remove("hidden"),this.elements.browseView.setAttribute("aria-hidden","false")}showVectors(){if(!this.available){this.setStatus("Vector store unavailable");return}this.active=!0,this.elements.browseBtn.classList.remove("active"),this.elements.browseBtn.setAttribute("aria-pressed","false"),this.elements.vectorBtn.classList.add("active"),this.elements.vectorBtn.setAttribute("aria-pressed","true"),this.elements.browseView.classList.add("hidden"),this.elements.browseView.setAttribute("aria-hidden","true"),this.elements.vectorsView.classList.remove("hidden"),this.elements.vectorsView.setAttribute("aria-hidden","false"),this.initialized?this.render():(this.initialized=!0,this.loadEmbeddings())}onTreeSelect(e){if(!this.available)return;this.selectedIndices.clear();const i=this.indicesByPath.get(e);i&&i.forEach(n=>this.selectedIndices.add(n)),this.updateLegend(),this.active&&this.render()}async onSearchResults(e,i){if(!(!this.available||!this.rows.length)){this.resultIndices.clear();for(const n of i.results){let a=!1;const o=[];n.chunk_id&&o.push(n.chunk_id),n.document_id&&typeof n.chunk_number=="number"&&o.push(`${n.document_id}-${n.chunk_number}`);for(const t of o){const s=this.indicesByRowId.get(t);s!==void 0&&(this.resultIndices.add(s),a=!0)}if(!a&&n.document_id){const t=this.indicesByDocumentId.get(n.document_id);t&&t.forEach(s=>this.resultIndices.add(s))}}this.queryPoint=i.meta.query_embeddings_umap3d??null,this.updateLegend(),this.active&&this.render()}}onClearSearch(){this.available&&(this.resultIndices.clear(),this.queryPoint=null,this.updateLegend(),this.active&&this.render())}isAvailable(){return this.available}isActive(){return this.active}setStatus(e){this.elements.status.textContent=e??""}resizeCanvas(){const e=this.elements.canvas.getBoundingClientRect(),i=window.devicePixelRatio||1,n=Math.max(1,Math.floor(e.width*i)),a=Math.max(1,Math.floor(e.height*i));(this.elements.canvas.width!==n||this.elements.canvas.height!==a)&&(this.elements.canvas.width=n,this.elements.canvas.height=a)}render(){if(!this.rows.length||!this.coords.length)return;this.resizeCanvas();const e=this.elements.canvas.getContext("2d");if(!e)return;const i=this.elements.canvas.width,n=this.elements.canvas.height;e.clearRect(0,0,i,n),e.fillStyle="#111",e.fillRect(0,0,i,n);const a=20;let o=1/0,t=-1/0,s=1/0,r=-1/0;const h=Math.cos(this.yaw),c=Math.sin(this.yaw),S=Math.cos(this.pitch),m=Math.sin(this.pitch),C=new Float32Array(this.coords.length);for(let u=0;u<this.coords.length;u+=3){const d=this.coords[u],y=this.coords[u+1],E=this.coords[u+2],L=d*h+E*c,x=-d*c+E*h,P=y*S-x*m,V=y*m+x*S;C[u]=L,C[u+1]=P,C[u+2]=V,L<o&&(o=L),L>t&&(t=L),P<s&&(s=P),P>r&&(r=P)}const v=(i-a*2)/Math.max(1e-6,t-o),p=(n-a*2)/Math.max(1e-6,r-s),T=Math.min(v,p)*this.zoom,D=(u,d,y,E)=>{e.beginPath(),e.arc(u,d,E,0,Math.PI*2),e.fillStyle=y,e.fill()},g=getComputedStyle(document.documentElement),f=g.getPropertyValue("--vec-base").trim()||"#8a8a8a",w=g.getPropertyValue("--vec-selected").trim()||"#3d7eff",I=g.getPropertyValue("--vec-result").trim()||"#ffb02e",A=g.getPropertyValue("--vec-query").trim()||"#ff4d4f";for(let u=0,d=0;u<this.rows.length;u+=1,d+=3){const y=a+(C[d]-o)*T+this.panX,E=n-(a+(C[d+1]-s)*T)+this.panY;let L=f,x=2;this.selectedIndices.has(u)&&(L=w,x=2.5),this.resultIndices.has(u)&&(L=I,x=3),D(y,E,L,x)}if(this.queryPoint){const[u,d,y=0]=this.queryPoint,E=u*h+y*c,L=-u*c+y*h,x=d*S-L*m,P=a+(E-o)*T+this.panX,V=n-(a+(x-s)*T)+this.panY;D(P,V,A,4)}}updateLegend(){if(!this.rows.length){this.elements.legend.textContent="";return}this.elements.legend.textContent=`Total: ${this.rows.length} • Selected: ${this.selectedIndices.size} • Results: ${this.resultIndices.size}`}computeUMAP(){if(!this.rows.length){this.coords=new Float32Array,this.basis=[];return}const e=this.rows.map(i=>i.umap3d??[NaN,NaN,NaN]);this.coords=new Float32Array(e.length*3);for(let i=0;i<e.length;i+=1)this.coords[i*3]=e[i][0],this.coords[i*3+1]=e[i][1],this.coords[i*3+2]=e[i][2];this.resetView()}computePCA(){if(!this.rows.length){this.coords=new Float32Array,this.basis=[];return}const e=this.rows.map(s=>s.embedding),i=$.getEigenVectors(e)??[];this.basis=i.slice(0,3);const n=$.computeAdjustedData(e,...this.basis).adjustedData,a=n[0]??[],o=n[1]??new Array(a.length).fill(0),t=n[2]??new Array(a.length).fill(0);this.coords=new Float32Array(a.length*3);for(let s=0;s<a.length;s+=1)this.coords[s*3]=a[s],this.coords[s*3+1]=o[s],this.coords[s*3+2]=t[s];this.resetView()}resetView(){this.yaw=0,this.pitch=0,this.zoom=1,this.panX=0,this.panY=0}indexRows(){this.indicesByRowId.clear(),this.indicesByPath.clear(),this.indicesByDocumentId.clear(),this.rows.forEach((e,i)=>{if(e.id&&this.indicesByRowId.set(e.id,i),e.path){const n=this.indicesByPath.get(e.path)??[];n.push(i),this.indicesByPath.set(e.path,n)}if(e.document_id){const n=this.indicesByDocumentId.get(e.document_id)??[];n.push(i),this.indicesByDocumentId.set(e.document_id,n)}})}async loadAvailability(){try{const e=await M.vectorStatus();this.handleVectorStatus(e)}catch{this.available=!1,this.elements.vectorBtn.classList.add("hidden")}}handleVectorStatus(e){if(this.available=!!(e!=null&&e.available),this.available){this.elements.vectorBtn.classList.remove("hidden"),this.elements.reindexBtn.classList.remove("hidden"),this.elements.refitBtn.classList.remove("hidden");const i=[];e.count!=null&&i.push(`Embeddings: ${e.count}`),e.dimensions!=null&&i.push(`Dims: ${e.dimensions}`),i.length&&(this.elements.legend.textContent=i.join(" • "))}else this.elements.vectorBtn.classList.add("hidden"),this.elements.reindexBtn.classList.add("hidden"),this.elements.refitBtn.classList.add("hidden")}async loadEmbeddings(){this.setStatus("Loading embeddings…");try{this.rows=[];let e=await M.vectorEmbeddings({limit:200,offset:0});for(;e.length>0;)this.rows.push(...e),e=await M.vectorEmbeddings({limit:200,offset:this.rows.length});this.setStatus("Indexing embeddings…"),this.indexRows(),this.computeUMAP(),this.setStatus(""),this.updateLegend(),this.render()}catch(e){console.error(e),this.setStatus("Failed to load embeddings")}}async projectQueryEmbedding(e){var i,n,a;try{const o=await M.vectorQueryEmbedding(e);console.log(o);const t=o.embedding??[];if(!t.length||!this.rows.length||(this.basis.length===0&&this.computePCA(),this.basis.length===0))return null;const s=$.computeAdjustedData([t],...this.basis).adjustedData,r=((i=s[0])==null?void 0:i[0])??0,h=((n=s[1])==null?void 0:n[0])??0,c=((a=s[2])==null?void 0:a[0])??0;return[r,h,c]}catch{return null}}wireInteractions(){const e=this.elements.canvas;e.addEventListener("mousedown",i=>{this.lastX=i.clientX,this.lastY=i.clientY,this.dragMode=i.button===0&&!i.shiftKey?"rotate":"pan",i.preventDefault()}),window.addEventListener("mousemove",i=>{if(!this.dragMode)return;const n=i.clientX-this.lastX,a=i.clientY-this.lastY;if(this.lastX=i.clientX,this.lastY=i.clientY,this.dragMode==="rotate"){this.yaw+=n*.01,this.pitch+=a*.01;const o=Math.PI/2-.001;this.pitch=Math.max(-o,Math.min(o,this.pitch))}else this.panX+=n,this.panY+=a;this.active&&this.render()}),window.addEventListener("mouseup",()=>{this.dragMode=null}),e.addEventListener("wheel",i=>{const n=-i.deltaY,a=Math.exp(n*.0015);this.zoom=Math.max(.2,Math.min(10,this.zoom*a)),this.active&&this.render(),i.preventDefault()},{passive:!1}),new ResizeObserver(()=>{this.active&&this.render()}).observe(this.elements.canvasContainer)}wireAdminButtons(){const{reindexBtn:e,refitBtn:i}=this.elements;e.addEventListener("click",async()=>{if(!(!this.available||e.disabled)){this.setStatus("Reindexing…"),e.disabled=!0,i.disabled=!0;try{const n=await M.vectorReindex(),a=(n==null?void 0:n.status)??"ok";this.setStatus(a==="queued"?"Reindex queued (running in background)":`Reindex: ${a}`)}catch(n){console.error(n),this.setStatus("Reindex failed")}finally{e.disabled=!1,i.disabled=!1}}}),i.addEventListener("click",async()=>{if(!(!this.available||i.disabled)){this.setStatus("Scheduling UMAP refit…"),e.disabled=!0,i.disabled=!0;try{const n=await M.vectorRefit(),a=(n==null?void 0:n.status)??"ok";this.setStatus(a==="queued"?"UMAP refit queued (running in background)":`Refit: ${a}`)}catch(n){console.error(n),this.setStatus("UMAP refit failed")}finally{e.disabled=!1,i.disabled=!1}}})}}async function me(){let l=null;try{l=new fe,await l.initialize()}catch(i){console.warn("Vector controller unavailable:",i),l=null}await new ae(l).start()}me();
