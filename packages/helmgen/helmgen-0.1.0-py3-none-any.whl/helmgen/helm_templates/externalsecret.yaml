{{- range $name, $svc := .Values.services }}
{{- if and (eq $.Values.secretProvider "externalsecret") ($svc.secrets) }}
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ $.Release.Name }}-{{ $name }}-externalsecret
spec:
  refreshInterval: 1h
  secretStoreRef:
    {{- if $.Values.reuseStore }}
    name: {{ $.Values.reuseStore }}
    kind: {{ ternary "ClusterSecretStore" "SecretStore" (eq $.Values.storeScope "cluster") }}
    {{- else }}
    name: {{ $.Release.Name }}-secretstore
    kind: {{ ternary "ClusterSecretStore" "SecretStore" (eq $.Values.storeScope "cluster") }}
    {{- end }}
  target:
    name: {{ $.Release.Name }}-{{ $name }}-secret
  data:
    {{- range $k, $v := $svc.secrets }}
    - secretKey: {{ $k }}
      remoteRef:
        key: {{ printf "%s/%s" $name $k | lower }}
    {{- end }}
---
{{- end }}
{{- end }}
