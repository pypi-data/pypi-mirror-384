.build-ci-image:
  extends: .tuxlava
  stage: build-ci-images
  only:
    refs:
      - main
    changes:
      - support/docker/Dockerfile.ci
      - support/docker/tuxlava-ci-images.yml
  image: docker:20.10-dind
  services:
      - name: docker:20.10-dind
  script:
    - 'docker build --build-arg=BASE=$BASE -t $CI_REGISTRY_IMAGE:$CI_JOB_NAME -f support/docker/Dockerfile.ci .'
    - 'docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY'
    - 'docker push $CI_REGISTRY_IMAGE:$CI_JOB_NAME'

.publish-ci-image:
  extends: .tuxlava
  stage: publish-ci-images
  only:
    refs:
      - main
    changes:
      - support/docker/Dockerfile.ci
      - support/docker/tuxlava-ci-images.yml
  image: docker:20.10-dind
  services:
      - name: docker:20.10-dind
  variables:
      DOCKER_CLI_EXPERIMENTAL: "enabled"
  script:
    - 'docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY'
    - 'docker manifest create $CI_REGISTRY_IMAGE:$CI_JOB_NAME $CI_REGISTRY_IMAGE:$CI_JOB_NAME-amd64 $CI_REGISTRY_IMAGE:$CI_JOB_NAME-arm64'
    - 'docker manifest push $CI_REGISTRY_IMAGE:$CI_JOB_NAME'

.build-ci-image-amd64:
  extends: .build-ci-image
  variables:
    ARCH: amd64

.build-ci-image-arm64:
  extends: .build-ci-image
  tags:
    - saas-linux-medium-arm64
  variables:
    ARCH: arm64

ci-python-3.9-amd64:
  extends: .build-ci-image-amd64
  variables:
    BASE: docker.io/library/python:3.9-slim

ci-python-3.9-arm64:
  extends: .build-ci-image-arm64
  variables:
    BASE: docker.io/library/python:3.9-slim

ci-python-3.9:
  extends: .publish-ci-image

ci-python-3.10-amd64:
  extends: .build-ci-image-amd64
  variables:
    BASE: docker.io/library/python:3.10-slim

ci-python-3.10-arm64:
  extends: .build-ci-image-arm64
  variables:
    BASE: docker.io/library/python:3.10-slim

ci-python-3.10:
  extends: .publish-ci-image

ci-python-3.11-amd64:
  extends: .build-ci-image-amd64
  variables:
    BASE: docker.io/library/python:3.11-slim

ci-python-3.11-arm64:
  extends: .build-ci-image-arm64
  variables:
    BASE: docker.io/library/python:3.11-slim

ci-python-3.11:
  extends: .publish-ci-image

ci-python-3.12-amd64:
  extends: .build-ci-image-amd64
  variables:
    BASE: docker.io/library/python:3.12-slim

ci-python-3.12-arm64:
  extends: .build-ci-image-arm64
  variables:
    BASE: docker.io/library/python:3.12-slim

ci-python-3.12:
  extends: .publish-ci-image

ci-python-3.13-amd64:
  extends: .build-ci-image-amd64
  variables:
    BASE: docker.io/library/python:3.13-slim

ci-python-3.13-arm64:
  extends: .build-ci-image-arm64
  variables:
    BASE: docker.io/library/python:3.13-slim

ci-python-3.13:
  extends: .publish-ci-image
