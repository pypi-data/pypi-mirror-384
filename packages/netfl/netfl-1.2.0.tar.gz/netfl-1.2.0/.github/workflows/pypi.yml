name: PyPI Pipeline

on:
  push:
    tags:
      - 'v*.*.*'
    branches:
      - main

permissions:
  contents: read

jobs:
  verify-ci:
    name: Verify CI Passed
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check CI status
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Checking CI status for commit ${{ github.sha }}..."
          
          # Wait a moment for CI to start if it hasn't already
          sleep 10
          
          # Get the CI workflow run status for this commit
          RUNS=$(gh run list --commit ${{ github.sha }} --workflow=ci.yml --json conclusion,status)
          
          echo "CI runs: $RUNS"
          
          # Check if CI completed successfully
          if echo "$RUNS" | jq -e '.[] | select(.conclusion == "success")' > /dev/null; then
            echo "CI passed successfully"
            exit 0
          elif echo "$RUNS" | jq -e '.[] | select(.status == "in_progress" or .status == "queued")' > /dev/null; then
            echo "CI is still running. Please wait for CI to complete before publishing."
            exit 1
          else
            echo "CI did not pass or was not found"
            exit 1
          fi

  pypi-publish:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: verify-ci
    environment: pypi
    permissions:
      id-token: write
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-publish-${{ hashFiles('**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-publish-
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build

    - name: Build package
      run: python -m build

    - name: Publish package to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
