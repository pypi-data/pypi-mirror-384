# SPDX-FileCopyrightText: 2025 Alex Willmer <alex@moreati.org.uk>
# SPDX-License-Identifier: MIT

[build-system]
requires = [
    "cffi>=1.15; python_version == '3.10' or python_version == '3.11'",
    "cffi>=1.16; python_version == '3.12' or python_version == '3.13'",
    "cffi>=2.0; python_version >= '3.14'",
    "setuptools>=77.0.3",  # Supports SPDX expression in license field
]
build-backend = "setuptools.build_meta"

[project]
name = "lzma-cf"
version = "0.0.4"
description = "LZMA and XZ compression for control freaks"
license = "BSD-3-Clause AND MIT AND PSF-2.0"
license-files = ["LICENSES/*.txt"]
authors = [
    {name = "Alex Willmer", email = "alex@moreati.org.uk"},
]
readme = "README.md"
dependencies = [
    "cffi>=1.15; python_version == '3.10' or python_version == '3.11'",
    "cffi>=1.16; python_version == '3.12' or python_version == '3.13'",
    "cffi>=2.0; python_version >= '3.14'",
]
requires-python = ">=3.10"
keywords = [
    "compression",
    "lzma",
    "xz",
    "xz-utils",
]
classifiers = [
    "Development Status :: 3 - Alpha",
    "Intended Audience :: Developers",
    "Programming Language :: Python :: 3",
    "Programming Language :: Python :: 3.10",
    "Programming Language :: Python :: 3.11",
    "Programming Language :: Python :: 3.12",
    "Programming Language :: Python :: 3.13",
    "Programming Language :: Python :: 3.14",
    "Programming Language :: Python :: 3 :: Only",
    "Topic :: System :: Archiving :: Compression",
]

[project.urls]
"Homepage" = "https://github.com/moreati/lzma-cf"

[tool.cibuildwheel]
enable = [
    "pypy",
]
skip = [
    "*-musllinux*",
    "*-win32",
    "cp3??t-*",
]
test-command = [
    'python -c "import lzma_cf; lzma_cf.compress(bytes(100), threads=2)"',
]

[tool.cibuildwheel.environment]
# Entries are evaluated in order of appearence
# https://github.com/pypa/cibuildwheel/issues/2616
XZ_UTILS_DIR = "xz"
XZ_UTILS_PREFIX = "$HOME/.local"
XZ_UTILS_REV = "v5.8.1"
XZ_UTILS_URL = "https://github.com/tukaani-project/xz.git"
C_INCLUDE_PATH = "$XZ_UTILS_PREFIX/include:$C_INCLUDE_PATH"
LD_LIBRARY_PATH = "$XZ_UTILS_PREFIX/lib:$LD_LIBRARY_PATH"
LIBRARY_PATH = "$XZ_UTILS_PREFIX/lib:$LIBRARY_PATH"

[tool.cibuildwheel.linux]
before-all = [
    "yum install -y gettext-devel po4a",
    "./pkg/clone_xz_utils",
    "./pkg/build_xz_utils",
]

[tool.cibuildwheel.macos]
before-all = [
    "brew install autoconf automake libtool po4a",
    "./pkg/clone_xz_utils",
    "./pkg/build_xz_utils",
]

[tool.cibuildwheel.windows]
before-all = [
    "msys2 ./pkg/clone_xz_utils",
    'cmd /c pkg\windows_build_xz_utils.bat',
    'cmd /c pkg\windows_linker_fixup.bat',
]
before-build = [
    "pip install delvewheel",
]
repair-wheel-command = [
    #'delvewheel repair -vv --add-path $env:LZMA_CF_LIBRARY_DIRS -w {dest_dir} {wheel}',
    'delvewheel repair -vv --add-path D:\a\lzma-cf\lzma-cf\xz\windows\build -w {dest_dir} {wheel}',
]
