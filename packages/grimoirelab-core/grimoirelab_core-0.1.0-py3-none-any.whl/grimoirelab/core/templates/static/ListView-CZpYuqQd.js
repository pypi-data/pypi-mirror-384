import{_ as T,c as y,w as c,r as a,o as d,a as o,d as x,t as p,m as S,e as D,b as _,f as b,g as O,F as I,h as U,i as L,A as w}from"./index-B5gNOk1p.js";import{u as N}from"./loading-yltfngwl.js";import{C as j,u as R}from"./ConfirmModal-DmJufS9P.js";import{S as A,u as F}from"./StatusIcon-CHehJsJv.js";import{f as E}from"./dates-sb6Utn2R.js";import{S as z}from"./StatusCard-wjjLcoj-.js";const M={name:"OrderSelector",emits:["update:value"],props:{options:{type:Array,required:!0},default:{type:String,required:!1,default:void 0}},data(){return{descending:!0,selectedValue:this.default}},computed:{value(){return`${this.descending?"-":""}${this.selectedValue}`},icon(){return this.descending?"mdi-sort-descending":"mdi-sort-ascending"}},methods:{emitValue(){this.$emit("update:value",this.value)},changeOrder(){this.descending=!this.descending,this.selectedValue&&this.emitValue()}}};function K(s,e,t,r,i,u){const m=a("v-icon"),f=a("v-btn"),g=a("v-tooltip"),v=a("v-select");return d(),y(v,{modelValue:i.selectedValue,"onUpdate:modelValue":[e[0]||(e[0]=l=>i.selectedValue=l),u.emitValue],items:t.options,"list-props":{nav:!0},"menu-props":{offsetY:!0,bottom:!0,nudgeTop:8},density:"compact",label:"Order by",class:"select--segmented",variant:"outlined",attach:"","single-line":""},{prepend:c(()=>[o(g,{location:"bottom"},{activator:c(({props:l})=>[o(f,S(l,{variant:"text",height:"32",onClick:u.changeOrder,onKeyup:D(u.changeOrder,["enter"])}),{default:c(()=>[o(m,{small:""},{default:c(()=>[_(p(u.icon),1)]),_:1})]),_:2},1040,["onClick","onKeyup"])]),default:c(()=>[x("span",null,p(i.descending?"Descending ":"Ascending ")+" order ",1)]),_:1})]),_:1},8,["modelValue","items","onUpdate:modelValue"])}const Y=T(M,[["render",K],["__scopeId","data-v-e8749124"]]),G={name:"TaskListItem",components:{StatusCard:z,StatusIcon:A},emits:["cancel","reschedule"],props:{backend:{type:String,required:!0},category:{type:String,required:!0},status:{type:String,required:!0},executions:{type:[Number,String],required:!1,default:0},id:{type:[Number,String],required:!0},scheduledDate:{type:String,required:!1,default:null},lastExecution:{type:String,required:!1,default:null},jobs:{type:Array,required:!1,default:()=>[]},uri:{type:String,required:!1,default:""}},computed:{executionDate(){return this.lastExecution?E(this.lastExecution):""},latestRun(){if(this.lastExecution){const s=this.status==="enqueued"?this.jobs[1].status:this.status;return{date:E(this.lastExecution),status:s}}else return null}}},H={class:"d-flex flex-wrap mb-3"},J={key:0,class:"caption border text-medium-emphasis px-1"},Q={key:0,class:"text-body-2 d-flex align-baseline"};function W(s,e,t,r,i,u){const m=a("v-chip"),f=a("v-card-title"),g=a("v-icon"),v=a("v-card-subtitle"),l=a("v-col"),q=a("v-divider"),P=a("v-tooltip"),C=a("status-icon"),n=a("v-btn"),V=a("v-row"),k=a("status-card");return d(),y(k,{status:t.status,to:{name:"task",params:{id:t.id}}},{default:c(()=>[o(V,null,{default:c(()=>[o(l,{md:"6",sm:"8"},{default:c(()=>[o(f,{class:"text-subtitle-2 d-flex align-center pt-4"},{default:c(()=>[_(p(t.id)+" ",1),o(m,{color:t.status.toLowerCase(),class:"ml-4",density:"compact",size:"small"},{default:c(()=>[_(p(t.status),1)]),_:1},8,["color"])]),_:1}),o(v,{class:"font-weight-medium"},{default:c(()=>[o(g,{"aria-label":t.backend,role:"img","aria-hidden":"false",size:"small"},{default:c(()=>[_(p("mdi-"+t.backend),1)]),_:1},8,["aria-label"]),_(" "+p(t.category),1)]),_:1})]),_:1}),o(q,{vertical:""}),o(l,{md:"4",class:"px-4 py-7"},{default:c(()=>[x("div",H,[(d(!0),b(I,null,U([...t.jobs].reverse(),h=>(d(),y(P,{key:h.uuid,text:`#${h.job_num} ${h.status}`,eager:!1,location:"bottom"},{activator:c(({props:B})=>[x("div",S({ref_for:!0},B,{class:[`bg-${h.status}`,"job-run mr-2"]}),null,16)]),_:2},1032,["text"]))),128)),t.executions>9?(d(),b("span",J," + "+p(t.executions-9),1)):O("",!0)]),u.latestRun?(d(),b("p",Q,[o(C,{status:u.latestRun.status,size:"x-small",start:""},null,8,["status"]),_(" Last run "+p(u.latestRun.date),1)])):O("",!0)]),_:1}),o(l,{class:"pa-6 d-flex flex-column align-end"},{default:c(()=>[o(n,{icon:"mdi-cancel",class:"mb-1",color:"danger",variant:"text",size:"small",density:"comfortable",onClick:e[0]||(e[0]=L(h=>s.$emit("cancel",t.id),["stop","prevent"]))}),o(n,{icon:"mdi-refresh",variant:"text",size:"small",density:"comfortable",onClick:e[1]||(e[1]=L(h=>s.$emit("reschedule",t.id),["stop","prevent"]))})]),_:1})]),_:1})]),_:1},8,["status","to"])}const X=T(G,[["render",W],["__scopeId","data-v-0211eae0"]]),Z={name:"TaskList",components:{OrderSelector:Y,TaskListItem:X},emits:["cancel","reschedule","update:page","update:filters"],props:{tasks:{type:Array,required:!0},count:{type:Number,required:!0},pages:{type:Number,required:!0},loading:{type:Boolean,required:!1,default:!1},currentPage:{type:Number,required:!1,default:1}},data(){return{dialog:!1,page:this.currentPage,tab:"all",tabs:[{text:"All",value:"all"},{text:"Running",value:{status:3}},{text:"Failed",value:{status:5}},{text:"Failed last run",value:{last_run_status:5}},{text:"Enqueued",value:{status:2}},{text:"Canceled",value:{status:7}}],orderBy:null}},methods:{emitFilters(){let s={};this.tab!=="all"&&Object.assign(s,this.tab),this.orderBy&&Object.assign(s,{ordering:this.orderBy}),this.$emit("update:filters",s)}},watch:{orderBy(){this.emitFilters(),this.page=1},currentPage(s){this.page=s}}},$={class:"text-h6 my-4 d-flex align-center"},ee={class:"d-flex"},te={key:0,class:"d-flex justify-center pa-4"};function se(s,e,t,r,i,u){const m=a("v-chip"),f=a("v-tab"),g=a("v-tabs"),v=a("order-selector"),l=a("v-progress-circular"),q=a("v-empty-state"),P=a("task-list-item"),C=a("v-pagination");return d(),b("div",null,[x("h1",$,[e[6]||(e[6]=_(" Tasks ",-1)),o(m,{class:"ml-2",density:"comfortable"},{default:c(()=>[_(p(t.count),1)]),_:1})]),x("div",ee,[o(g,{modelValue:i.tab,"onUpdate:modelValue":[e[0]||(e[0]=n=>i.tab=n),u.emitFilters],items:i.tabs,"align-tabs":"left",color:"primary",height:"36","slider-color":"primary"},{tab:c(({item:n})=>[o(f,{text:n.text,value:n.value,class:"text-none text-subtitle-2"},null,8,["text","value"])]),_:1},8,["modelValue","items","onUpdate:modelValue"]),o(v,{options:[{title:"Last run",value:"last_run"},{title:"Scheduled at",value:"scheduled_at"}],default:"last_run",class:"ml-auto","onUpdate:value":e[1]||(e[1]=n=>i.orderBy=n)})]),t.loading?(d(),b("div",te,[o(l,{class:"mx-auto",color:"primary",indeterminate:""})])):!t.loading&&t.count===0?(d(),y(q,{key:1,icon:"mdi-magnify",title:"No results found",size:"52"})):(d(!0),b(I,{key:2},U(t.tasks,n=>{var V;return d(),y(P,{key:n.uuid,id:n.uuid,backend:n.datasource_type,category:n.datasource_category,status:n.status,executions:n.runs,jobs:n.last_jobs,"scheduled-date":n.scheduled_at,"last-execution":n.last_run,uri:(V=n.task_args)==null?void 0:V.uri,class:"mb-3",onCancel:e[2]||(e[2]=k=>s.$emit("cancel",k)),onReschedule:e[3]||(e[3]=k=>s.$emit("reschedule",k))},null,8,["id","backend","category","status","executions","jobs","scheduled-date","last-execution","uri"])}),128)),o(C,{modelValue:i.page,"onUpdate:modelValue":[e[4]||(e[4]=n=>i.page=n),e[5]||(e[5]=n=>s.$emit("update:page",n))],length:t.pages,color:"primary",density:"comfortable"},null,8,["modelValue","length"])])}const ae=T(Z,[["render",se],["__scopeId","data-v-01c5b32b"]]),ne={components:{TaskList:ae,ConfirmModal:j},data(){return{tasks:[],pages:1,currentPage:1,count:0,interval:3e4,pollID:null,filters:{}}},mounted(){this.pollID=this.pollTasks(1)},unmounted(){clearTimeout(this.pollID)},methods:{async cancelTask(s){try{await w.scheduler.cancel(s),this.openSnackbar({color:"success",text:`Canceled task ${s}`}),this.pollTasks(this.currentPage)}catch(e){this.openErrorSnackbar(e)}this.closeModal()},async fetchTasks(s=1,e=this.filters){try{const t={page:s};e&&Object.assign(t,e);const r=await w.scheduler.list(t);r.data.results&&(this.tasks=r.data.results,this.count=r.data.count,this.pages=r.data.total_pages,this.currentPage=r.data.page,this.filters=e)}catch(t){console.log(t)}},async rescheduleTask(s){try{await w.scheduler.reschedule(s),this.openSnackbar({color:"success",text:`Rescheduled task ${s}`}),this.pollTasks(this.currentPage)}catch(e){this.openErrorSnackbar(e)}},async pollTasks(s,e){clearTimeout(this.pollID);try{await this.fetchTasks(s,e)}catch(t){this.openErrorSnackbar(t)}finally{this.pollID=setTimeout(()=>this.pollTasks(s,e),this.interval)}}},setup(){const{isLoading:s}=N(),{modalProps:e,confirmCancel:t,closeModal:r}=R(),{snackbarProps:i,openSnackbar:u,openErrorSnackbar:m}=F();return{isLoading:s,modalProps:e,confirmCancel:t,closeModal:r,snackbarProps:i,openSnackbar:u,openErrorSnackbar:m}}};function oe(s,e,t,r,i,u){const m=a("task-list"),f=a("v-snackbar"),g=a("confirm-modal"),v=a("v-container");return d(),y(v,null,{default:c(()=>[o(m,{tasks:i.tasks,count:i.count,loading:r.isLoading,pages:i.pages,"current-page":i.currentPage,onCancel:e[0]||(e[0]=l=>r.confirmCancel(u.cancelTask,l)),onReschedule:e[1]||(e[1]=l=>u.rescheduleTask(l)),"onUpdate:page":e[2]||(e[2]=l=>u.pollTasks(l,i.filters)),"onUpdate:status":e[3]||(e[3]=l=>u.pollTasks(1,l)),"onUpdate:filters":e[4]||(e[4]=l=>u.pollTasks(1,l))},null,8,["tasks","count","loading","pages","current-page"]),o(f,S({modelValue:r.snackbarProps.isOpen,"onUpdate:modelValue":e[5]||(e[5]=l=>r.snackbarProps.isOpen=l)},r.snackbarProps),null,16,["modelValue"]),o(g,S({"is-open":r.modalProps.isOpen,"onUpdate:isOpen":e[6]||(e[6]=l=>r.modalProps.isOpen=l)},r.modalProps),null,16,["is-open"])]),_:1})}const me=T(ne,[["render",oe]]);export{me as default};
