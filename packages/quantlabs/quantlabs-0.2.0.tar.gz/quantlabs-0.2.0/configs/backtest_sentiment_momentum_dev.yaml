# QuantLab Backtest: Sentiment + Momentum Strategy - DEV VERSION
#
# Optimized for SPEED during development:
# - Small stock universe (5 stocks)
# - Simpler model (fewer trees, shallow depth)
# - Momentum only (no slow sentiment API calls)
# - Shorter training period
#
# Expected runtime: 30-60 seconds
#
# For production, use: backtest_sentiment_momentum.yaml

qlib_init:
  provider_uri: "/Volumes/sandisk/quantmini-data/data/qlib/stocks_daily"
  region: us

# Small universe: 5 mega-cap tech stocks
market: &market ["AAPL", "MSFT", "GOOGL", "AMZN", "NVDA"]
benchmark: &benchmark SPY

data_handler_config: &data_handler_config
  start_time: 2024-06-01      # Shorter history (6 months vs 12)
  end_time: 2024-12-31
  instruments: *market
  feature_names:
    # Momentum indicators only (FAST - from parquet)
    - polygon_sma_20
    - polygon_sma_50
    # Skip sentiment for dev (SLOW - API calls)
    # - av_sentiment_score
    # Skip fundamentals for dev (SLOW - API calls)
    # - yf_forward_pe

port_analysis_config: &port_analysis_config
  strategy:
    class: SentimentMomentumStrategy
    module_path: quantlab.backtest.strategies
    kwargs:
      signal: <PRED>
      momentum_weight: 1.0       # 100% momentum (no sentiment in dev)
      sentiment_weight: 0.0      # Skip sentiment for speed
      min_sentiment: -1.0        # Disabled
      max_pe: 1000               # Disabled
  backtest:
    start_time: 2024-09-01
    end_time: 2024-12-31
    account: 100000000
    benchmark: *benchmark
    exchange_kwargs:
      freq: day
      limit_threshold: 0.095
      deal_price: close
      open_cost: 0.0015
      close_cost: 0.0015
      min_cost: 5

task:
  model:
    class: LGBModel
    module_path: qlib.contrib.model.gbdt
    kwargs:
      loss: mse
      colsample_bytree: 0.8
      learning_rate: 0.05
      subsample: 0.8
      lambda_l1: 0.1
      lambda_l2: 10
      max_depth: 4                # Simpler (was 6)
      num_leaves: 16              # Fewer leaves (was 64)
      num_threads: 8
      early_stopping_rounds: 30   # More aggressive (was 50)
      num_boost_round: 100        # Fewer rounds (was 1000)

  dataset:
    class: DatasetH
    module_path: qlib.data.dataset
    kwargs:
      handler:
        class: QuantLabFeatureHandler
        module_path: quantlab.backtest.handlers
        kwargs: *data_handler_config
      segments:
        train: [2024-06-01, 2024-08-31]   # Shorter train (3 months)
        valid: [2024-09-01, 2024-10-15]   # Shorter valid (1.5 months)
        test: [2024-10-16, 2024-12-31]    # Shorter test (2.5 months)

  record:
    - class: SignalRecord
      module_path: qlib.workflow.record_temp
      kwargs:
        model: <MODEL>
        dataset: <DATASET>
    - class: SigAnaRecord
      module_path: qlib.workflow.record_temp
      kwargs:
        ana_long_short: False
        ann_scaler: 252
    - class: PortAnaRecord
      module_path: qlib.workflow.record_temp
      kwargs:
        config: *port_analysis_config
